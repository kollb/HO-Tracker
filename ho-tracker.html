<!DOCTYPE html>
<html lang="de">
<head>
  <title>HO Planer V2 (Standalone)</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <meta name="theme-color" content="#0f172a">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%233b82f6%22><path d=%22M4,6H20V16H4M20,18A2,2 0 0,0 22,16V6C22,4.89 21.1,4 20,4H4C2.89,4 2,4.89 2,6V16A2,2 0 0,0 4,18H0V20H24V18H20Z%22/></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.css" rel="stylesheet">
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <style>
    [v-cloak] { display: none !important; }
    
    body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #f8fafc; overflow-y: overlay;}
    .mono-num { font-family: 'JetBrains Mono', monospace; letter-spacing: -0.5px; }
    .glass-effect { background: rgba(30, 41, 59, 0.4) !important; backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border: 1px solid rgba(255, 255, 255, 0.05) !important; }

    /* Top Nav Controls */
    .view-toggle { background: rgba(15, 23, 42, 0.5); border-radius: 10px; padding: 4px; border: 1px solid rgba(255,255,255,0.05); display: flex; gap: 4px;}
    .view-btn { padding: 4px 16px; border-radius: 6px; font-size: 0.85rem; font-weight: 500; cursor: pointer; transition: all 0.2s; color: #94a3b8; }
    .view-btn:hover { color: #f8fafc; }
    .view-btn.active { background: #1e293b; color: #f8fafc; box-shadow: 0 2px 4px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05); }

    /* BENTO GRID */
    .bento-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .bento-card { border-radius: 20px; padding: 16px 20px; transition: transform 0.2s, box-shadow 0.2s; display: flex; flex-direction: column; justify-content: space-between; position: relative; overflow: hidden; height: 110px;}
    .bento-card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.3); }
    .bento-card.budget-card { grid-column: span 2; }
    
    .bento-label { font-size: 0.75rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px; color: #94a3b8; display: flex; align-items: center; margin-bottom: 8px;}
    .bento-value { font-size: 1.7rem; font-weight: 700; line-height: 1; color: #f8fafc; }
    .bento-sub { font-size: 0.8rem; color: #64748b; margin-top: 2px; }
    
    .progress-track { width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-top: 10px;}
    .progress-fill { height: 100%; background: linear-gradient(90deg, #10b981 0%, #3b82f6 50%, #f59e0b 100%); border-radius: 4px; transition: width 1s cubic-bezier(0.4, 0, 0.2, 1); }

    /* HYBRID TIMELINE-GRID */
    .timeline-wrapper { width: 100%; max-width: 1100px; margin: 0 auto; }
    .tl-panel { border-radius: 20px; padding: 20px; position: relative; }
    .tl-spine { position: absolute; left: 39px; top: 50px; bottom: 20px; width: 2px; background: rgba(255,255,255,0.05); z-index: 1; }

    .tl-header {
        display: grid;
        grid-template-columns: 140px 140px 90px 90px 120px 1fr 40px;
        gap: 16px;
        padding-left: 48px; 
        padding-right: 16px;
        padding-bottom: 8px;
        margin-bottom: 8px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #64748b;
        border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    
    .tl-row {
        position: relative;
        display: grid;
        grid-template-columns: 140px 140px 90px 90px 120px 1fr 40px;
        gap: 16px;
        align-items: center;
        min-height: 36px; 
        padding-left: 48px; 
        padding-right: 16px;
        border-radius: 8px;
        transition: background 0.1s;
    }
    .tl-row:hover { background: rgba(255,255,255,0.05); }
    .tl-row.is-off-day { opacity: 0.4; }
    
    .tl-dot {
        position: absolute;
        left: 16px; 
        top: 50%;
        transform: translateY(-50%);
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: #1e293b;
        border: 2px solid #334155;
        z-index: 2;
        transition: all 0.2s;
    }
    .is-today .tl-dot { background: #3b82f6; border-color: #0ea5e9; box-shadow: 0 0 10px rgba(59, 130, 246, 0.6); }
    
    .tl-date-cell { display: flex; align-items: baseline; gap: 8px; white-space: nowrap; overflow: hidden; }
    .tl-date-num { font-size: 1rem; font-weight: 700; color: #f8fafc; }
    .tl-date-day { font-size: 0.9rem; font-weight: 500; color: #94a3b8; }
    .tl-holiday-badge { font-size: 0.65rem; font-weight: 600; color: #ef4444; letter-spacing: -0.2px; background: rgba(239, 68, 68, 0.15); padding: 2px 6px; border-radius: 4px;}
    
    .tl-week-sum {
        display: flex;
        align-items: center;
        font-size: 0.85rem;
        font-weight: 600;
        color: #94a3b8;
        margin: 6px 0 12px 48px; 
        padding: 4px 14px;
        background: rgba(0,0,0,0.25);
        border: 1px solid rgba(255,255,255,0.05);
        border-radius: 12px;
        width: fit-content;
        position: relative;
        z-index: 2;
    }

    .hover-input { background: transparent; border: 1px solid transparent; color: inherit; outline: none; transition: all 0.1s; border-radius: 6px; padding: 0 8px; width: 100%; font-family: 'JetBrains Mono', monospace; font-size: 0.95rem; height: 30px;}
    .hover-input:hover, .hover-input:focus { background: rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.2); }
    .hover-input::placeholder { color: rgba(255,255,255,0.2); font-family: 'Inter', sans-serif;}
    
    .hover-select { appearance: none; background: transparent; border: 1px solid transparent; color: inherit; outline: none; transition: all 0.1s; border-radius: 6px; padding: 0 8px; width: 100%; cursor: pointer; font-size: 0.95rem; font-weight: 600; height: 30px;}
    .hover-select:hover, .hover-select:focus { background: rgba(0,0,0,0.3); border-color: rgba(255,255,255,0.2); }
    .hover-select option { background: #1e293b; color: #f8fafc; }

    .glz-input { width: 85px; text-align: right; cursor: pointer; padding: 0 4px !important; }
    .glz-input::placeholder { color: inherit; opacity: 1; }
    .glz-input:focus::placeholder { opacity: 0.3; }

    .action-cell { display: flex; justify-content: flex-end; align-items: center;}
    .action-icon { opacity: 0; transition: opacity 0.2s; color: #64748b; cursor: pointer; font-size: 1.2rem;}
    .action-icon:hover { color: #ef4444; }
    .tl-row:hover .action-icon { opacity: 1; }

    /* FARBEN */
    .text-mint { color: #10b981 !important; }
    .text-warning { color: #f59e0b !important; }
    .text-indigo { color: #818cf8 !important; } 
    .text-slate { color: #94a3b8; }
    .text-bright { color: #f8fafc; }
    .text-neutral { color: #f8fafc !important; }

    .type-home { color: #10b981; background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); }
    .type-home::before { background: #10b981; }
    
    .type-office { color: #818cf8; background: rgba(129, 140, 248, 0.1); border: 1px solid rgba(129, 140, 248, 0.2); }
    .type-office::before { background: #818cf8; }
    
    .type-planned { color: #3b82f6; background: rgba(59, 130, 246, 0.1); border: 1px dashed rgba(59, 130, 246, 0.3); }
    .type-planned::before { background: #3b82f6; }
    
    .type-sick { color: #ef4444; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); }
    .type-sick::before { background: #ef4444; }
    
    .type-vacation { color: #d946ef; background: rgba(217, 70, 239, 0.1); border: 1px solid rgba(217, 70, 239, 0.2); }
    .type-vacation::before { background: #d946ef; }
    
    .type-dr { color: #0ea5e9; background: rgba(14, 165, 233, 0.1); border: 1px solid rgba(14, 165, 233, 0.2); }
    .type-dr::before { background: #0ea5e9; }

    /* Kalender & Rest */
    .cal-grid-wrapper { border-radius: 20px; overflow-x: auto; border: 1px solid rgba(255,255,255,0.05); background: rgba(15,23,42,0.5); padding: 1px; max-width: 1100px; margin: 0 auto;}
    .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: rgba(255,255,255,0.05); }
    .cal-header-cell { text-align: center; font-size: 0.8rem; font-weight: 600; text-transform: uppercase; color: #64748b; padding: 12px 0; background: rgba(30,41,59,0.3); border-bottom: 1px solid rgba(255,255,255,0.05); }
    .cal-cell { background: #0f172a; min-height: 100px; padding: 12px; cursor: pointer; transition: background 0.2s; display: flex; flex-direction: column; gap: 4px;}
    .cal-cell:hover { background: rgba(30,41,59,0.8); }
    .cal-cell.is-today { background: rgba(59, 130, 246, 0.05); border: 1px solid #3b82f6;}
    .cal-cell.is-off-day { background: repeating-linear-gradient(45deg, #0f172a, #0f172a 10px, rgba(30,41,59,0.3) 10px, rgba(30,41,59,0.3) 20px); opacity: 0.6; }
    
    .cal-date-num { font-size: 1.1rem; font-weight: 600; color: #94a3b8; }
    .cal-cell.is-today .cal-date-num { color: #3b82f6; }
    
    .cal-pill { display: inline-flex; align-items: center; gap: 6px; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; width: fit-content; text-transform: uppercase; letter-spacing: 0.5px;}
    .cal-pill::before { content: ''; display: block; width: 6px; height: 6px; border-radius: 50%; }

    /* File Status Dot */
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot.green { background-color: #10b981; box-shadow: 0 0 4px #10b981; }
    .dot.red { background-color: #ef4444; }
    .dot.orange { background-color: #f59e0b; }

    /* Force text to not wrap in year view to enable scroll */
    .year-table th, .year-table td { white-space: nowrap !important; }

    @media (max-width: 1200px) {
        .bento-grid { grid-template-columns: repeat(2, 1fr); }
        .bento-card { height: 120px; }
    }
    
    /* === MOBILE LAYOUT === */
    @media (max-width: 768px) {
        .bento-grid { grid-template-columns: 1fr; gap: 12px; margin-bottom: 16px;}
        .bento-card { height: auto; }
        .tl-header { display: none; }
        .tl-spine { left: 24px; top: 10px; bottom: 10px;}
        
        .tl-row { 
            display: flex;
            flex-wrap: wrap;
            padding: 14px 12px 14px 42px;
            gap: 8px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        
        .tl-dot { left: 16px; top: 22px; transform: none; }
        .tl-date-cell { width: 100%; margin-bottom: 2px; }
        
        .tl-col-status { width: 100%; background: rgba(0,0,0,0.25); border-radius: 6px; border: 1px solid rgba(255,255,255,0.03); }
        .tl-col-start { width: calc(50% - 4px); background: rgba(0,0,0,0.25); border-radius: 6px; border: 1px solid rgba(255,255,255,0.03); }
        .tl-col-end { width: calc(50% - 4px); background: rgba(0,0,0,0.25); border-radius: 6px; border: 1px solid rgba(255,255,255,0.03); }
        .tl-col-glz { width: 100%; display: flex; justify-content: flex-start !important; margin-top: 4px; padding-left: 4px;}
        .tl-col-note { width: 100%; background: rgba(0,0,0,0.25); border-radius: 6px; border: 1px solid rgba(255,255,255,0.03); margin-top: 2px;}
        
        .action-cell { position: absolute; right: 12px; top: 12px; }
        .action-icon { opacity: 1; }
    }
  </style>
</head>
<body>
  
  <div id="app" v-cloak>
    <v-app style="background: transparent;">
      
      <v-app-bar class="glass-effect" elevation="0" border="bottom" density="comfortable" :height="$vuetify.display.mobile ? 56 : 64">
        <v-container class="d-flex align-center pa-0 px-4" style="max-width: 1100px; width: 100%;">
            <div class="d-flex align-center mr-2 mr-md-6">
                <v-avatar color="rgba(59, 130, 246, 0.1)" size="36" class="mr-2 mr-sm-3 border" style="border-color: rgba(59, 130, 246, 0.3) !important;">
                    <v-icon color="#3b82f6" size="small">mdi-laptop</v-icon>
                </v-avatar>
                <div class="font-weight-bold text-subtitle-1 text-bright" style="letter-spacing: -0.5px;">
                    <span class="d-none d-sm-inline">HO Planer</span>
                    <v-chip size="x-small" color="success" variant="flat" class="ml-1 font-weight-bold" style="font-size: 0.6rem; height: 18px;">STANDALONE</v-chip>
                </div>
            </div>

            <v-spacer></v-spacer>

            <div class="view-toggle d-none d-md-flex mx-auto">
                <div class="view-btn" :class="{active: viewMode === 'list'}" @click="viewMode = 'list'">Timeline</div>
                <div class="view-btn" :class="{active: viewMode === 'calendar'}" @click="viewMode = 'calendar'">Kalender</div>
                <div class="view-btn" :class="{active: viewMode === 'year'}" @click="viewMode = 'year'">Jahr</div>
            </div>

            <v-spacer></v-spacer>

            <div class="d-flex align-center gap-1">
                <div class="d-none d-md-flex align-center px-3 py-1 mr-4 rounded-pill border" style="background: rgba(0,0,0,0.25); border-color: rgba(255,255,255,0.05) !important;">
                    <template v-if="fileHandle">
                        <span class="dot green mr-2" title="Mit lokaler Datei synchronisiert"></span>
                        <span class="text-caption text-bright font-weight-bold text-truncate" style="max-width: 100px;">[[ fileName ]]</span>
                        <v-btn icon="mdi-content-save" size="x-small" variant="text" class="ml-1" :color="unsavedChanges ? 'warning' : 'grey'" @click="saveToFile" title="Speichern"></v-btn>
                    </template>
                    <template v-else-if="storedHandleName">
                        <span class="dot orange mr-2" title="Berechtigung zur Datei fehlt"></span>
                        <span class="text-caption text-slate text-truncate" style="max-width: 100px;">[[ storedHandleName ]]</span>
                        <v-btn icon="mdi-link-variant" size="x-small" variant="text" class="ml-1" color="primary" @click="restoreFileConnection" title="Verbindung wiederherstellen"></v-btn>
                        <v-btn icon="mdi-folder-open" size="x-small" variant="text" class="ml-1" color="slate" @click="openFile" title="Andere Datei öffnen"></v-btn>
                    </template>
                    <template v-else>
                        <span class="dot red mr-2" title="Nur temporär im Browser gespeichert"></span>
                        <span class="text-caption text-slate">Lokal (Browser)</span>
                        <v-btn icon="mdi-folder-open" size="x-small" variant="text" class="ml-1" color="primary" @click="openFile" title="Datei öffnen/anlegen"></v-btn>
                        <v-btn icon="mdi-download" size="x-small" variant="text" class="ml-1" color="slate" @click="saveToFile" title="Als JSON herunterladen"></v-btn>
                    </template>
                </div>

                <v-btn icon="mdi-file-pdf-box" variant="text" color="#94a3b8" size="small" @click="triggerPdfImport" title="PDF Import"></v-btn>
                <v-btn icon="mdi-calendar-multiple" variant="text" color="#94a3b8" size="small" @click="openSeriesDialog()" title="Serien-Planer"></v-btn>
                <v-btn icon="mdi-cog" variant="text" color="#94a3b8" size="small" @click="dialogSettings = true" title="Einstellungen"></v-btn>
            </div>
        </v-container>
      </v-app-bar>

      <v-main>
        <v-container class="pt-6 pb-12" style="max-width: 1100px; width: 100%;">
            
            <div class="bento-grid" v-if="viewMode !== 'year'">
                <div class="bento-card glass-effect" style="border-top: 2px solid #3b82f6 !important;">
                    <div class="bento-label"><v-icon size="small" class="mr-2" color="#3b82f6">mdi-calendar-check</v-icon> Arbeitstage</div>
                    <div>
                        <div class="bento-value mono-num">[[ stats.workdays_month ]]</div>
                        <div class="bento-sub">In diesem Monat</div>
                    </div>
                </div>

                <div class="bento-card glass-effect" :style="stats.current_glz < 0 ? 'border-top: 2px solid #ef4444 !important;' : 'border-top: 2px solid #64748b !important;'">
                    <div class="bento-label"><v-icon size="small" class="mr-2" :color="stats.current_glz < 0 ? '#ef4444' : '#94a3b8'">mdi-clock-outline</v-icon> Gleitzeit</div>
                    <div>
                        <div class="bento-value mono-num" :class="stats.current_glz < 0 ? 'text-error' : 'text-neutral'">
                            <span v-if="stats.current_glz > 0">+</span>[[ formatNum(stats.current_glz) ]] <span style="font-size: 1rem; opacity: 0.5; color: #94a3b8;">h</span>
                        </div>
                        <div class="bento-sub">Aktueller Saldo</div>
                    </div>
                </div>

                <div class="bento-card budget-card glass-effect" style="border-top: 2px solid #0ea5e9 !important;">
                    <div class="d-flex justify-space-between align-center mb-1">
                        <div class="bento-label mb-0"><v-icon size="small" class="mr-2" color="#0ea5e9">mdi-laptop</v-icon> Home Office Budget</div>
                        <div class="d-flex align-center rounded-pill px-2" style="height: 26px; background: rgba(0,0,0,0.25); border: 1px solid rgba(255,255,255,0.05);">
                            <v-btn icon variant="plain" size="x-small" @click="changeMonth(-1)" style="width: 20px; height: 20px;"><v-icon size="small">mdi-chevron-left</v-icon></v-btn>
                            <span class="font-weight-bold text-slate mx-1" style="font-size: 0.75rem;">[[ getGermanMonthName(currentMonth) ]] [[ currentYear ]]</span>
                            <v-btn icon variant="plain" size="x-small" @click="changeMonth(1)" style="width: 20px; height: 20px;"><v-icon size="small">mdi-chevron-right</v-icon></v-btn>
                        </div>
                    </div>
                    
                    <div>
                        <div class="d-flex justify-space-between align-end">
                            <div class="bento-value mono-num">
                                [[ formatOneDecimal(budgetRemainingDays) ]] <span style="font-size: 0.9rem; opacity: 0.5; font-family: 'Inter', sans-serif;">Tage übrig</span>
                                <span class="text-caption text-slate mono-num ml-1" style="font-size: 0.8rem !important; opacity: 0.6;">([[ formatNum(budgetRemainingHours) ]] h)</span>
                            </div>
                            <div class="text-caption text-slate mono-num" style="font-size: 0.8rem !important;">[[ Math.round(quotaPercentage) ]]% genutzt</div>
                        </div>
                        <div class="progress-track">
                            <div class="progress-fill" :style="{width: Math.min(quotaPercentage, 100) + '%', background: quotaPercentage > 100 ? '#ef4444' : ''}"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div v-else class="bento-card glass-effect mb-4 d-flex flex-row align-center justify-center py-5" style="height: auto; border-top: 2px solid #3b82f6 !important;">
                <v-btn icon variant="plain" size="small" @click="changeYear(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                <div class="text-h6 font-weight-bold mx-6">Jahresübersicht [[ currentYear ]]</div>
                <v-btn icon variant="plain" size="small" @click="changeYear(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
            </div>

            <v-fade-transition hide-on-leave>
                <div :key="viewMode">
                    
                    <div v-if="viewMode === 'list'" class="timeline-wrapper">
                        
                        <div class="tl-panel glass-effect">
                            <div class="tl-spine d-none d-md-block"></div>

                            <div class="tl-header d-none d-md-grid">
                                <div>Datum</div>
                                <div>Status</div>
                                <div class="text-center">Start</div>
                                <div class="text-center">Ende</div>
                                <div class="text-right pr-2">GLZ Abgleich</div>
                                <div>Notiz</div>
                                <div></div>
                            </div>

                            <template v-for="(item, idx) in items" :key="item.date ? 'tl-day-'+item.date : 'tl-sum-'+idx">
                                
                                <div v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))" class="position-relative" :class="{'is-today': isToday(item.date)}">
                                    
                                    <div v-for="(entry, index) in item.entries" :key="index" 
                                         class="tl-row" :class="{'is-off-day': item.is_off_day}">
                                        
                                        <div v-if="index === 0" class="tl-dot d-none d-md-block"></div>
                                        
                                        <div class="tl-date-cell">
                                            <template v-if="index === 0">
                                                <span class="tl-date-num" :class="{'text-primary': isToday(item.date)}">[[ item.day_num ]].</span>
                                                <span class="tl-date-day">[[ getGermanDayShort(item.weekday_index) ]]</span>
                                                <span v-if="item.is_holiday" class="tl-holiday-badge">[[ item.holiday_name ]]</span>
                                            </template>
                                        </div>

                                        <div class="tl-col-status">
                                            <select v-model="entry.type" class="hover-select" @change="onEntryChange(item, entry)" :class="'text-' + getStatusIconColor(entry.type, true)">
                                                <option v-for="t in getAvailableTypes(item.date)" :value="t.value">[[ t.title ]]</option>
                                            </select>
                                        </div>

                                        <div class="tl-col-start">
                                            <input v-if="needsTimeInput(entry.type)" type="text" v-model="entry.start" class="hover-input mono-num text-center" placeholder="Start" @input="debouncedSave(item.date)">
                                            <div v-else class="text-center opacity-30 text-slate mono-num" style="font-size: 0.95rem; line-height: 30px;">-</div>
                                        </div>

                                        <div class="tl-col-end">
                                            <input v-if="needsTimeInput(entry.type)" type="text" v-model="entry.end" class="hover-input mono-num text-center" placeholder="Ende" @input="debouncedSave(item.date)">
                                            <div v-else class="text-center opacity-30 text-slate mono-num" style="font-size: 0.95rem; line-height: 30px;">-</div>
                                        </div>

                                        <div class="tl-col-glz d-flex justify-md-end justify-start align-center pr-md-2" style="gap: 4px;">
                                            <template v-if="index === 0">
                                                <div class="d-md-none text-caption text-slate font-weight-bold mr-1" style="line-height: 30px;">GLZ:</div>
                                                <v-icon v-if="entry.glz_override !== null && entry.glz_override !== undefined" 
                                                        size="14" 
                                                        color="#0ea5e9" 
                                                        class="cursor-pointer" 
                                                        :title="entry.glz_override_source === 'manual' ? 'Manuell bearbeitet. Klick zum Entfernen.' : 'Aus PDF importiert. Klick zum Entfernen.'" 
                                                        @click="entry.glz_override = null; entry.glz_override_source = null; debouncedSave(item.date)">
                                                    [[ entry.glz_override_source === 'manual' ? 'mdi-account-edit-outline' : 'mdi-file-pdf-box' ]]
                                                </v-icon>
                                                
                                                <input type="text" 
                                                       v-model="entry.glz_override" 
                                                       class="hover-input glz-input mono-num font-weight-bold"
                                                       :class="(entry.glz_override !== null && entry.glz_override !== '') ? (entry.glz_override >= 0 ? 'text-mint' : 'text-error') : (item.glz_saldo >= 0 ? 'text-mint' : 'text-error')"
                                                       :placeholder="(item.glz_saldo > 0 ? '+' : '') + formatNum(item.glz_saldo)"
                                                       @input="entry.glz_override_source = 'manual'; debouncedSave(item.date)"
                                                       title="Klicken um Saldo manuell zu überschreiben">
                                                <span class="text-slate" style="font-size: 0.8rem;">h</span>
                                            </template>
                                        </div>

                                        <div class="tl-col-note">
                                            <input type="text" v-model="entry.comment" class="hover-input text-slate pl-md-2 pl-3" placeholder="Notiz..." @input="debouncedSave(item.date)">
                                        </div>

                                        <div class="action-cell">
                                            <i v-if="index === 0" class="mdi mdi-plus-circle action-icon" title="Split hinzufügen" @click="addEntryToDay(item)"></i>
                                            <i v-else class="mdi mdi-close action-icon" title="Löschen" @click="deleteEntry(item, index)"></i>
                                        </div>
                                    </div>
                                </div>
                                
                                <div v-else-if="item && item.row_type === 'summary'" class="tl-week-sum">
                                    <span class="mr-3 text-uppercase text-slate" style="font-size: 0.8rem;">KW [[ item.iso_week ]]</span>
                                    <span class="mono-num font-weight-bold" style="font-size: 0.95rem;" :class="getWeeklyColor(item)">
                                        [[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] <span style="font-size: 0.8rem; font-weight: normal; opacity: 0.7;">h</span>
                                    </span>
                                </div>

                            </template>
                        </div>
                    </div>

                    <div v-if="viewMode === 'calendar'">
                        <div class="cal-grid-wrapper">
                            <div style="min-width: 650px;">
                                <div class="cal-grid">
                                    <div class="cal-header-cell">Mo</div><div class="cal-header-cell">Di</div><div class="cal-header-cell">Mi</div><div class="cal-header-cell">Do</div><div class="cal-header-cell">Fr</div><div class="cal-header-cell text-error">Sa</div><div class="cal-header-cell text-error">So</div>

                                    <div v-for="n in paddingDays" :key="'pad-'+n" class="cal-cell" style="background: rgba(15,23,42,0.3);"></div>
                                    <template v-for="item in items" :key="item ? item.date : 'cal-unk'">
                                        <div v-if="item && item.row_type === 'day'" class="cal-cell position-relative"
                                             :class="{'is-today': isToday(item.date), 'is-off-day': item.is_off_day}"
                                             @click="openEditDialog(item)">
                                            <div class="d-flex justify-space-between align-start">
                                                <span class="cal-date-num mono-num">[[ item.day_num ]]</span>
                                                <div v-if="item.total_net > 0 || item.main_type === 'planned'" class="text-caption text-slate mono-num">[[ formatNum(item.total_net) ]]h</div>
                                            </div>
                                            <div v-if="item.is_holiday" class="text-error font-weight-bold mt-1 text-truncate" style="line-height: 1.1; font-size: 0.75rem !important;">[[ item.holiday_name ]]</div>
                                            <div class="mt-auto d-flex flex-column gap-1">
                                                <div v-if="item.main_type" class="cal-pill" :class="'type-' + item.main_type">
                                                    [[ getTypeName(item.main_type, item.date) ]]
                                                </div>
                                                <div v-if="item.entries && item.entries.length > 1" class="text-slate mt-1" style="font-size: 0.75rem !important;">
                                                    + [[ item.entries.length - 1 ]] Split(s)
                                                </div>
                                            </div>
                                        </div>
                                    </template>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div v-if="viewMode === 'year'">
                        <v-row class="mb-4">
                            <v-col cols="12" md="4">
                                <div class="bento-card glass-effect h-100" style="min-height: 250px; border-top: 2px solid #10b981 !important;">
                                    <div class="bento-label">Verteilung</div>
                                    <div style="height: 200px; position: relative;"><canvas id="donutChart"></canvas></div>
                                </div>
                            </v-col>
                            <v-col cols="12" md="8">
                                <div class="bento-card glass-effect h-100" style="min-height: 250px; border-top: 2px solid #3b82f6 !important;">
                                    <div class="bento-label">HO Verlauf</div>
                                    <div style="height: 200px; position: relative;"><canvas id="barChart"></canvas></div>
                                </div>
                            </v-col>
                        </v-row>
                        
                        <div class="bento-card glass-effect pa-0 overflow-hidden" style="max-width: 1100px; margin: 0 auto; height: auto;">
                            <div style="width: 100%; overflow-x: auto;">
                                <v-table density="compact" class="bg-transparent text-bright year-table" style="min-width: 750px;">
                                    <template v-slot:default>
                                        <thead>
                                            <tr style="background: rgba(0,0,0,0.2);">
                                                <th class="text-left font-weight-bold text-slate">Monat</th>
                                                <th class="text-center font-weight-bold text-slate">Home Office</th>
                                                <th class="text-center font-weight-bold text-slate">Büro</th>
                                                <th class="text-center font-weight-bold text-slate">Urlaub</th>
                                                <th class="text-center font-weight-bold text-slate">Budget Nutzung</th>
                                                <th class="text-center font-weight-bold text-slate">Arbeitsstunden</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            <tr v-for="stat in yearData" :key="stat.month" class="border-b" style="border-color: rgba(255,255,255,0.05) !important;">
                                                <td class="font-weight-bold" style="font-size: 0.95rem;">[[ getGermanMonthName(stat.month) ]]</td>
                                                <td class="text-center"><span class="cal-pill type-home mono-num" v-if="stat.days_ho > 0" style="font-size: 0.85rem;">[[ stat.days_ho ]] T.</span><span v-else class="text-slate">-</span></td>
                                                <td class="text-center"><span class="cal-pill type-office mono-num" v-if="stat.days_office > 0" style="font-size: 0.85rem;">[[ stat.days_office ]] T.</span><span v-else class="text-slate">-</span></td>
                                                <td class="text-center"><span class="cal-pill type-vacation mono-num" v-if="stat.days_vacation > 0" style="font-size: 0.85rem;">[[ stat.days_vacation ]] T.</span><span v-else class="text-slate">-</span></td>
                                                <td class="text-center">
                                                    <div class="d-flex align-center justify-center">
                                                        <div style="width: 100px" class="mr-3"><v-progress-linear :model-value="stat.ho_hours_allowed ? (stat.ho_hours_made / stat.ho_hours_allowed)*100 : 0" color="#3b82f6" height="6" rounded bg-opacity="0.2"></v-progress-linear></div>
                                                        <div class="text-caption mono-num text-slate" style="font-size: 0.85rem !important;">[[ formatNum(stat.ho_hours_made) ]] / [[ formatNum(stat.ho_hours_allowed) ]]h</div>
                                                    </div>
                                                </td>
                                                <td class="text-center text-slate mono-num" style="font-size: 0.85rem;">
                                                    <div class="d-flex align-center justify-center" v-if="(stat.ho_hours_made + stat.office_hours_made) > 0 || stat.work_hours_target > 0">
                                                        <div class="text-right" style="width: 50px;">[[ formatNum(stat.ho_hours_made + stat.office_hours_made) ]]</div>
                                                        <div class="text-center mx-1" style="width: 10px;">/</div>
                                                        <div class="text-right" style="width: 50px;">[[ formatNum(stat.work_hours_target) ]]</div>
                                                        <div class="ml-1 text-left" style="width: 15px;">h</div>
                                                    </div>
                                                    <span v-else>-</span>
                                                </td>
                                            </tr>
                                        </tbody>
                                        <tfoot style="background: rgba(15, 23, 42, 0.8);" class="font-weight-bold border-t">
                                            <tr>
                                                <td class="text-left py-3 text-body-1 text-bright">GESAMT</td>
                                                <td class="text-center"><span class="cal-pill type-home mono-num text-bright" style="font-size: 0.9rem;">[[ yearTotalHo ]] T.</span></td>
                                                <td class="text-center"><span class="cal-pill type-office mono-num text-bright" style="font-size: 0.9rem;">[[ yearTotalOffice ]] T.</span></td>
                                                <td class="text-center"><span class="cal-pill type-vacation mono-num text-bright" style="font-size: 0.9rem;">[[ yearTotalVacation ]] T.</span></td>
                                                <td class="text-center"></td>
                                                <td class="text-center"></td>
                                            </tr>
                                        </tfoot>
                                    </template>
                                </v-table>
                            </div>
                        </div>
                    </div>

                </div>
            </v-fade-transition>
        </v-container>
      </v-main>

      <v-bottom-navigation v-model="viewMode" bg-color="#0f172a" active-color="#3b82f6" class="d-md-none border-t" style="border-color: rgba(255,255,255,0.05) !important;">
        <v-btn value="list"><v-icon>mdi-format-list-bulleted</v-icon><span>Timeline</span></v-btn>
        <v-btn value="calendar"><v-icon>mdi-calendar-month</v-icon><span>Kalender</span></v-btn>
        <v-btn value="year"><v-icon>mdi-chart-bar</v-icon><span>Jahr</span></v-btn>
      </v-bottom-navigation>

      <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="4000" location="top" rounded="pill">
         [[ snackbar.text ]]
      </v-snackbar>

      <v-dialog v-model="dialogEditDay" max-width="500">
        <v-card v-if="editingDay" class="glass-effect" rounded="xl" style="background: #1e293b !important;">
            <v-card-title class="d-flex justify-space-between align-center py-3 border-b" style="border-color: rgba(255,255,255,0.05) !important;">
                <div class="font-weight-bold text-bright text-body-1">[[ editingDay.day_num ]]. [[ currentMonthName ]]</div>
                <v-chip size="small" color="#64748b" variant="tonal">[[ getGermanDay(editingDay.weekday_index) ]]</v-chip>
            </v-card-title>
            <v-card-text class="pt-4">
                <div v-for="(entry, index) in editingDay.entries" :key="index" class="mb-4 pa-3 rounded-lg" style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.05);">
                    <div class="d-flex justify-space-between mb-2">
                        <select v-model="entry.type" class="hover-select bg-transparent font-weight-bold" style="width: auto;" @change="debouncedSave(editingDay.date)">
                            <option v-for="t in getAvailableTypes(editingDay.date)" :value="t.value">[[ t.title ]]</option>
                        </select>
                        <v-btn icon="mdi-delete" size="small" variant="text" color="error" @click="deleteEntry(editingDay, index)"></v-btn>
                    </div>
                    <v-row dense>
                        <v-col cols="6"><v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.start" label="Start" variant="underlined" density="compact" hide-details class="mono-num" @update:model-value="debouncedSave(editingDay.date)"></v-text-field></v-col>
                        <v-col cols="6"><v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.end" label="Ende" variant="underlined" density="compact" hide-details class="mono-num" @update:model-value="debouncedSave(editingDay.date)"></v-text-field></v-col>
                        <v-col cols="12"><v-text-field v-model="entry.comment" label="Notiz" variant="underlined" density="compact" hide-details @update:model-value="debouncedSave(editingDay.date)"></v-text-field></v-col>
                    </v-row>
                </div>
                <v-btn variant="text" size="small" color="primary" @click="addEntryToDay(editingDay)" prepend-icon="mdi-plus">Split hinzufügen</v-btn>
                
                <v-divider class="my-4 opacity-20"></v-divider>
                <v-text-field v-if="editingDay.entries && editingDay.entries.length > 0" v-model="editingDay.entries[0].glz_override" label="Manueller GLZ Abgleich" placeholder="z.B. +12,50" variant="outlined" density="compact" hide-details @update:model-value="editingDay.entries[0].glz_override_source = 'manual'; debouncedSave(editingDay.date)"></v-text-field>
            </v-card-text>
            <v-card-actions class="px-5 pb-5"><v-spacer></v-spacer><v-btn variant="flat" color="primary" @click="dialogEditDay = false">Fertig</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <input type="file" ref="pdfInput" style="display: none" accept=".pdf" @change="onPdfFileChange">
      <input type="file" ref="jsonInput" style="display: none" accept=".json" @change="fallbackLoadJson">
      
      <v-dialog v-model="importDialog.show" max-width="400">
          <v-card class="glass-effect" rounded="xl" style="background: #1e293b !important;">
              <v-card-title class="py-3 border-b text-bright d-flex align-center text-body-1"><v-icon start color="primary" size="small">mdi-file-pdf-box</v-icon> PDF Import (Lokal)</v-card-title>
              <v-card-text class="pt-4">
                  <p class="text-caption mb-4 text-slate">Verarbeitet den Zeitnachweis sicher und komplett offline in deinem Browser. Erkennt Zeiten, Splits und Salden.</p>
                  <v-checkbox v-model="importDialog.overwrite" label="Existierende Einträge überschreiben" color="primary" hide-details density="compact"></v-checkbox>
              </v-card-text>
              <v-card-actions class="px-4 pb-4"><v-spacer></v-spacer>
                  <v-btn variant="text" color="slate" size="small" @click="importDialog.show = false">Abbrechen</v-btn>
                  <v-btn variant="flat" color="primary" size="small" @click="processPdfImport">Import starten</v-btn>
              </v-card-actions>
          </v-card>
      </v-dialog>

      <v-dialog v-model="seriesDialog.show" max-width="500">
        <v-card class="glass-effect" rounded="xl" style="background: #1e293b !important;">
            <v-card-title class="py-3 border-b text-bright d-flex align-center text-body-1"><v-icon start color="primary" size="small">mdi-calendar-multiple</v-icon> Serien-Planer</v-card-title>
            <v-card-text class="pt-4">
                <v-row density="compact">
                    <v-col cols="6"><v-text-field v-model="seriesDialog.start" label="Von" type="date" variant="outlined" density="compact"></v-text-field></v-col>
                    <v-col cols="6"><v-text-field v-model="seriesDialog.end" label="Bis" type="date" variant="outlined" density="compact"></v-text-field></v-col>
                </v-row>
                <div class="mb-3 d-flex justify-space-between rounded-lg pa-1 mt-1" style="background: rgba(0,0,0,0.2);">
                    <v-checkbox v-for="(day, idx) in ['Mo','Di','Mi','Do','Fr']" :key="idx" v-model="seriesDialog.weekdays" :value="idx" :label="day" density="compact" hide-details color="primary"></v-checkbox>
                </div>
                <v-select v-model="seriesDialog.type" :items="baseTypes" label="Status setzen auf" item-title="title" item-value="value" variant="outlined" density="compact"></v-select>
                <v-checkbox v-model="seriesDialog.overwrite" label="Vorhandene überschreiben" density="compact" color="warning" hide-details></v-checkbox>
            </v-card-text>
            <v-card-actions class="px-4 pb-4"><v-spacer></v-spacer>
                <v-btn variant="text" color="slate" size="small" @click="seriesDialog.show = false">Abbrechen</v-btn>
                <v-btn variant="flat" color="primary" size="small" @click="saveSeriesPlan">Ausführen</v-btn>
            </v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialogSettings" max-width="600">
        <v-card class="glass-effect" rounded="xl" style="background: #1e293b !important;">
          <v-card-title class="py-3 border-b text-bright d-flex align-center text-body-1"><v-icon start color="primary" size="small">mdi-cog</v-icon> Einstellungen</v-card-title>
          <v-card-text class="pt-4">
            <v-row>
              <v-col cols="12"><div class="text-caption text-uppercase text-slate mb-1 font-weight-bold">Allgemein</div></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.weekly_hours" label="Wochenstunden (Vertrag)" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.ho_quota_percent" label="HO Quote %" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              
              <v-col cols="12" class="mt-0 pt-0">
                  <div class="text-caption mb-1 text-slate font-weight-bold">Reguläre Arbeitstage</div>
                  <div class="d-flex justify-space-between rounded-lg pa-1 mb-3" style="max-width: 400px; background: rgba(0,0,0,0.2);">
                      <v-checkbox v-model="settings.active_weekdays" :value="0" label="Mo" density="compact" hide-details color="primary"></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="1" label="Di" density="compact" hide-details color="primary"></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="2" label="Mi" density="compact" hide-details color="primary"></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="3" label="Do" density="compact" hide-details color="primary"></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="4" label="Fr" density="compact" hide-details color="primary"></v-checkbox>
                  </div>
                  
                  <v-switch v-model="settings.hide_weekends" label="Wochenenden ausblenden" color="primary" density="compact" hide-details></v-switch>

                  <v-divider class="my-3 opacity-20"></v-divider>
                  
                  <div class="text-caption text-uppercase text-slate mb-2 font-weight-bold">Automatisierung</div>
                  <v-row align="center" dense>
                      <v-col cols="6">
                        <v-text-field v-model="settings.default_start_time" label="Standard Startzeit" type="time" density="compact" variant="outlined" hide-details></v-text-field>
                      </v-col>
                      <v-col cols="6">
                          <v-switch v-model="settings.auto_convert_planned" label="Planung auto-umwandeln" color="primary" density="compact" hide-details></v-switch>
                      </v-col>
                  </v-row>
              </v-col>
            </v-row>
            
            <v-divider class="my-4 opacity-20"></v-divider>
            
            <div class="d-flex justify-space-between align-center mb-2">
                <div class="text-caption text-uppercase text-slate font-weight-bold">Eigene Feiertage</div>
                <v-btn size="x-small" variant="tonal" color="primary" @click="addWaeldchestag"><v-icon start>mdi-calendar-plus</v-icon> Wäldchestag</v-btn>
            </div>
            
            <div class="rounded-lg mb-2 border" style="border-color: rgba(255,255,255,0.05) !important; background: rgba(0,0,0,0.1);">
                <div v-for="(h, dateKey) in customHolidays" :key="dateKey" class="d-flex align-center py-1 px-3" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="width: 80px;" class="text-caption mono-num text-slate">[[ h.date ]]</div>
                    <div class="text-caption font-weight-bold flex-grow-1 text-truncate text-bright">[[ h.name ]] <span v-if="h.hours > 0" class="text-slate ml-1 font-weight-regular">([[ h.hours ]]h)</span></div>
                    <div class="d-flex" style="gap: 8px;">
                        <v-icon size="small" color="primary" class="cursor-pointer" @click="editCustomHoliday(h, dateKey)" title="Bearbeiten">mdi-pencil</v-icon>
                        <v-icon size="small" color="error" class="cursor-pointer" @click="deleteCustomHoliday(dateKey)" title="Löschen">mdi-delete</v-icon>
                    </div>
                </div>
                <div v-if="!customHolidays || Object.keys(customHolidays).length === 0" class="text-caption text-slate pa-2 text-center">Keine angelegt.</div>
            </div>
            
            <div class="d-flex align-center pa-2 rounded-lg border" style="border-color: rgba(255,255,255,0.05) !important; background: rgba(0,0,0,0.2);">
                <v-text-field v-model="newCustomHoliday.date" type="date" density="compact" variant="outlined" hide-details class="mr-2" style="flex: 0 0 130px;"></v-text-field>
                <v-text-field v-model="newCustomHoliday.name" label="Bez." density="compact" variant="outlined" hide-details class="mr-2"></v-text-field>
                <v-text-field v-model="newCustomHoliday.hours" label="Std." type="number" density="compact" variant="outlined" hide-details class="mr-2" style="max-width: 60px;"></v-text-field>
                <v-btn icon="mdi-content-save" size="small" color="primary" elevation="0" @click="addCustomHoliday"></v-btn>
            </div>

          </v-card-text>
          <v-card-actions class="px-4 pb-4"><v-spacer></v-spacer>
            <v-btn variant="flat" color="primary" size="small" @click="saveSettings">Speichern & Schließen</v-btn>
          </v-card-actions>
        </v-card>
      </v-dialog>
      
    </v-app>
  </div>

  <script>
    let activeCharts = { donut: null, bar: null };

    const { createApp } = Vue; 
    const { createVuetify } = Vuetify; 
    
    const vuetify = createVuetify({ 
        theme: { 
            defaultTheme: 'bentoDark',
            themes: {
                bentoDark: {
                    dark: true,
                    colors: {
                        background: '#0f172a',
                        surface: '#1e293b',
                        primary: '#3b82f6',
                        secondary: '#64748b',
                        error: '#ef4444',
                        info: '#0ea5e9',
                        success: '#10b981',
                        warning: '#f59e0b',
                    }
                }
            }
        } 
    });

    const IDB_NAME = 'bbk_tracker_db';
    const IDB_STORE = 'handles';
    async function idbSet(key, val) { return new Promise((resolve, reject) => { const req = indexedDB.open(IDB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE); req.onsuccess = e => { const db = e.target.result; const tx = db.transaction(IDB_STORE, 'readwrite'); tx.objectStore(IDB_STORE).put(val, key); tx.oncomplete = () => resolve(); }; }); }
    async function idbGet(key) { return new Promise((resolve, reject) => { const req = indexedDB.open(IDB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE); req.onsuccess = e => { const db = e.target.result; const tx = db.transaction(IDB_STORE, 'readonly'); const getReq = tx.objectStore(IDB_STORE).get(key); getReq.onsuccess = () => resolve(getReq.result); }; }); }

    const Store = {
        data: { settings:{}, entries:{}, customHolidays:{} },
        init() {
            const ls = localStorage.getItem('bbk_data');
            if(ls) try { this.data = JSON.parse(ls); } catch(e){}
            if(!this.data.settings) this.data.settings = {};
            if(!this.data.entries) this.data.entries = {};
            if(!this.data.customHolidays) this.data.customHolidays = {};
            
            let migrated = false;
            for(const date in this.data.entries) {
                if(!Array.isArray(this.data.entries[date])) {
                    this.data.entries[date] = [this.data.entries[date]];
                    migrated = true;
                }
                this.data.entries[date].forEach(e => {
                    if(e.type === 'x') { e.type = 'planned'; migrated = true; }
                });
            }
            if(migrated) this.persist();
        },
        get() { return this.data; },
        set(newData) { this.data = newData; this.init(); localStorage.setItem('bbk_data', JSON.stringify(this.data)); },
        getSettings() { 
            return { 
                weekly_hours: 39, active_weekdays: [0,1,2,3,4], ho_quota_percent: 60, hide_weekends: false,
                default_start_time: '08:00', auto_convert_planned: true, ...this.data.settings 
            }; 
        },
        saveSettings(s) { this.data.settings = s; this.persist(); },
        getEntries() { return this.data.entries || {}; },
        saveDayEntries(date, entriesArray) { 
             if(entriesArray.length > 0) {
                 const clean = entriesArray.filter(e => (e.type && e.type !== '') || (e.comment && e.comment.trim() !== '') || (e.glz_override !== undefined && e.glz_override !== null));
                 if(clean.length === 0) delete this.data.entries[date];
                 else this.data.entries[date] = clean;
             } else {
                 delete this.data.entries[date];
             }
             this.persist(); 
        },
        getCustomHolidays() { return this.data.customHolidays || {}; },
        saveCustomHolidays(mapObj) { this.data.customHolidays = mapObj; this.persist(); },
        onPersist: null,
        persist() { localStorage.setItem('bbk_data', JSON.stringify(this.data)); if(this.onPersist) this.onPersist(); }
    };
    Store.init();

    // --- LOGIC PORT ---
    function normalizeTimeInput(t) {
        if(!t) return ""; t = t.toString().trim().replace('.', ':');
        let h=0, m=0;
        if (t.includes(':')) { const p = t.split(':'); h = parseInt(p[0]); m = parseInt(p[1]); } 
        else if (t.length === 4 && !isNaN(t)) { h = parseInt(t.substring(0, 2)); m = parseInt(t.substring(2, 4)); } 
        else if (t.length === 3 && !isNaN(t)) { h = parseInt(t.substring(0, 1)); m = parseInt(t.substring(1, 3)); } 
        else if (t.length <= 2 && !isNaN(t)) { h = parseInt(t); m = 0; } else { return null; }
        if(isNaN(h)) h = 0; if(isNaN(m)) m = 0; 
        if(h > 23 || m > 59) return null;
        return `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
    }

    function calculateNetHours(start, end) {
        if(!start || !end) return 0.0;
        const s = normalizeTimeInput(start), e = normalizeTimeInput(end);
        if(!s || !e) return 0.0;
        const [sh, sm] = s.split(':').map(Number); const [eh, em] = e.split(':').map(Number);
        let startMin = sh*60 + sm; let endMin = eh*60 + em;
        if (endMin < startMin) endMin += 24*60;
        
        const grossHours = (endMin - startMin) / 60.0;
        let net = grossHours;
        
        if (grossHours <= 6.0) net = grossHours;
        else if (grossHours <= 6.5) net = 6.0;
        else if (grossHours <= 9.5) net = grossHours - 0.5;
        else if (grossHours <= 9.75) net = 9.0;
        else net = grossHours - 0.75;

        return Math.max(0.0, parseFloat(net.toFixed(2)));
    }
    
    function calculateGrossTimeNeeded(targetNet) {
        if (targetNet <= 6.0) return targetNet;
        else if (targetNet <= 9.0) return targetNet + 0.5; 
        else return targetNet + 0.75; 
    }
    
    function calculateTotalDailyNet(entries, infoTarget = 0) {
        let sum = 0.0;
        entries.forEach(e => {
            if(e.type === 'planned') {
                 if (e.start && e.end) sum += calculateNetHours(e.start, e.end);
                 else sum += infoTarget;
            }
            else if(['home','office','dr'].includes(e.type) && e.start && e.end) {
                 sum += calculateNetHours(e.start, e.end);
            }
        });
        return parseFloat(sum.toFixed(2));
    }
    
    function getHolidayName(dateObj, customHolidays) {
        const ymd = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        if(customHolidays[ymd]) return customHolidays[ymd].name;
        
        const d = dateObj.getDate(), m = dateObj.getMonth() + 1, y = dateObj.getFullYear();
        if(m===12 && d===24) return "Heiligabend"; if(m===12 && d===31) return "Silvester"; if(m===1 && d===1) return "Neujahr"; if(m===5 && d===1) return "Tag der Arbeit"; if(m===10 && d===3) return "Tag der Deutschen Einheit"; if(m===12 && d===25) return "1. Weihnachtstag"; if(m===12 && d===26) return "2. Weihnachtstag";
        
        const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451);
        const monthE = Math.floor((h+l-7*m_easter+114)/31), dayE = ((h+l-7*m_easter+114)%31)+1; const easterDate = new Date(y, monthE-1, dayE);
        const addDays = (base, days) => { const n = new Date(base); n.setDate(n.getDate() + days); return n; }; 
        const isSame = (d1, d2) => d1.getDate()===d2.getDate() && d1.getMonth()===d2.getMonth();
        if(isSame(dateObj, addDays(easterDate, -2))) return "Karfreitag"; if(isSame(dateObj, addDays(easterDate, 1))) return "Ostermontag"; if(isSame(dateObj, addDays(easterDate, 39))) return "Christi Himmelfahrt"; if(isSame(dateObj, addDays(easterDate, 50))) return "Pfingstmontag"; if(isSame(dateObj, addDays(easterDate, 60))) return "Fronleichnam"; 
        return "";
    }
    
    function getISOWeek(d) { const date = new Date(d.getTime()); date.setHours(0, 0, 0, 0); date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7); const week1 = new Date(date.getFullYear(), 0, 4); return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7); }

    // --- VUE APP ---
    const app = createApp({
      data() {
        return {
          isSaving: false, saveTimeout: null, 
          viewMode: 'list', currentDate: new Date(), items: [], yearData: [],
          stats: { total_ho_made: 0, total_ho_allowed: 1, total_office_made: 0, total_work_made: 0, avg_per_week: 0, workdays_month: 0, current_glz: 0 }, 
          settings: { weekly_hours: 39, active_weekdays: [0,1,2,3,4], ho_quota_percent: 60, hide_weekends: false, default_start_time: '08:00', auto_convert_planned: true },
          dialogSettings: false, dialogEditDay: false, editingDay: null, 
          importDialog: { show: false, overwrite: false, file: null },
          seriesDialog: { show: false, start: '', end: '', weekdays: [4], type: 'home', overwrite: false },
          customHolidays: {}, newCustomHoliday: { _oldDate: null, date: '', name: '', hours: 0 },
          fileHandle: null, fileName: '', storedHandleName: '', unsavedChanges: false, snackbar: { show: false, text: '', color: 'success' },
          baseTypes: [
              { title: 'Home Office', value: 'home' }, 
              { title: 'Büro', value: 'office' }, 
              { title: 'Krank', value: 'sick' }, 
              { title: 'Urlaub', value: 'vacation' }, 
              { title: 'Gleitzeit', value: 'glz' }, 
              { title: 'Dienstreise', value: 'dr' }, 
              { title: 'Leer', value: '' }
          ]
        }
      },
      computed: {
        currentYear() { return this.currentDate.getFullYear() },
        currentMonth() { return this.currentDate.getMonth() + 1 }, 
        currentMonthName() { return this.currentDate.toLocaleString('de-DE', { month: 'long' }) },
        quotaPercentage() { if(!this.stats.total_ho_allowed) return 0; return (this.stats.total_ho_made / this.stats.total_ho_allowed) * 100; },
        paddingDays() { if(!this.items || this.items.length === 0) return 0; const firstDay = this.items.find(i => i.row_type === 'day'); return firstDay ? firstDay.weekday_index : 0; },
        calcDailyTarget() { const activeCount = this.settings.active_weekdays ? this.settings.active_weekdays.length : 5; if (activeCount === 0) return 0; return this.settings.weekly_hours / activeCount; },
        budgetRemainingHours() { return this.stats.total_ho_allowed - this.stats.total_ho_made; },
        budgetRemainingDays() { const daily = this.calcDailyTarget || 7.8; if(daily === 0) return 0; return this.budgetRemainingHours / daily; },
        yearTotalHo() { return this.yearData && this.yearData.length ? this.yearData.reduce((sum, item) => sum + item.days_ho, 0) : 0; },
        yearTotalOffice() { return this.yearData && this.yearData.length ? this.yearData.reduce((sum, item) => sum + item.days_office, 0) : 0; },
        yearTotalVacation() { return this.yearData && this.yearData.length ? this.yearData.reduce((sum, item) => sum + item.days_vacation, 0) : 0; },
        
        yearTotalWorkTarget() { return this.yearData && this.yearData.length ? this.yearData.reduce((sum, item) => sum + item.work_hours_target, 0) : 0; },
        yearTotalHoHours() { return this.yearData && this.yearData.length ? this.yearData.reduce((sum, item) => sum + item.ho_hours_made, 0) : 0; },
        yearTotalOfficeHours() { return this.yearData && this.yearData.length ? this.yearData.reduce((sum, item) => sum + item.office_hours_made, 0) : 0; }
      },
      watch: { 
          viewMode(newVal) { 
              if(newVal === 'year') { this.loadYearData(); } 
              else { this.destroyCharts(); this.loadMonthData(); }
          } 
      },
      mounted() { 
          Store.onPersist = () => { if(this.viewMode==='year') this.loadYearData(); else this.loadMonthData(); if(this.fileHandle) this.saveToFile(); else this.unsavedChanges = true; };
          this.loadData();
          this.checkForStoredHandle();
          
          window.addEventListener('keydown', (e) => {
              if(e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;
              if(this.dialogEditDay || this.dialogSettings || this.importDialog.show || this.seriesDialog.show) return;
              if(this.viewMode === 'year') {
                  if(e.key === 'ArrowLeft') this.changeYear(-1);
                  if(e.key === 'ArrowRight') this.changeYear(1);
              } else {
                  if(e.key === 'ArrowLeft') this.changeMonth(-1);
                  if(e.key === 'ArrowRight') this.changeMonth(1);
              }
          });
      },
      methods: {
        formatNum(val) { 
            if (val === null || val === undefined || val === '') return '0,00';
            const num = parseFloat(String(val).replace(',', '.'));
            return isNaN(num) ? '0,00' : num.toFixed(2).replace('.', ',');
        },
        formatOneDecimal(val) { return val || val === 0 ? val.toFixed(1).replace('.', ',') : '0,0'; },
        showMsg(text, color='success') { this.snackbar.text = text; this.snackbar.color = color; this.snackbar.show = true; },
        
        triggerPdfImport() { this.$refs.pdfInput.click(); },
        onPdfFileChange(event) { const file = event.target.files[0]; if (!file) return; this.importDialog.file = file; this.importDialog.show = true; event.target.value = ''; },
        async processPdfImport() {
            this.importDialog.show = false;
            const file = this.importDialog.file; if (!file) return;
            try {
                this.showMsg("Lese PDF...", "info");
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let cnt = 0;
                
                const germanMonths = {'Januar':1,'Februar':2,'März':3,'April':4,'Mai':5,'Juni':6,'Juli':7,'August':8,'September':9,'Oktober':10,'November':11,'Dezember':12};
                const TYPE_MAP = { 
                    "Mobil": "home", "Telearb.": "home", "Telearb": "home", 
                    "anwesend": "office", 
                    "Krank": "sick", "krank im Dienst": "sick", "Krank im Dienst": "sick",
                    "Urlaub": "vacation", "Erholungs": "vacation", "Zusatz": "vacation", "Sonder": "vacation",
                    "Gleitzeit": "glz", "GLZ": "glz",
                    "Dienstreise": "dr", "Reise": "dr", "Fortbildung": "dr",
                    "Betriebsausflug": "office", "betriebsausflug": "office",
                    "BUCHUNG FEHLT": "missing"
                };

                const page1 = await pdf.getPage(1);
                const txt1 = (await page1.getTextContent()).items.map(i=>i.str).join(' ');
                const mMatch = txt1.match(/Monat:?\s*([a-zA-ZäöüÄÖÜ]+)\s*[-_]?\s*(\d{4})/);
                if(!mMatch) { this.showMsg("Monat nicht gefunden", "error"); return; }
                const month = germanMonths[mMatch[1]], year = parseInt(mMatch[2]);
                
                const dailyData = {};
                
                for(let i=1; i<=pdf.numPages; i++){
                    const page = await pdf.getPage(i);
                    const items = (await page.getTextContent()).items;
                    
                    items.sort((a,b) => {
                        const yDiff = b.transform[5] - a.transform[5];
                        return Math.abs(yDiff) < 5 ? (a.transform[4] - b.transform[4]) : yDiff;
                    });
                    
                    const fullText = items.map(item => item.str).join(" ");
                    const datePattern = /(\d{2})\s+(MO|DI|MI|DO|FR|SA|SO)/g;
                    let match;
                    let lastIndex = 0;
                    let lastDay = null;

                    while ((match = datePattern.exec(fullText)) !== null) {
                        if (lastDay !== null) {
                            const segment = fullText.substring(lastIndex, match.index);
                            processDaySegment(lastDay, segment, dailyData, TYPE_MAP);
                        }
                        lastDay = parseInt(match[1]);
                        lastIndex = match.index;
                    }
                    if (lastDay !== null) {
                         const segment = fullText.substring(lastIndex);
                         processDaySegment(lastDay, segment, dailyData, TYPE_MAP);
                    }
                }
                
                function processDaySegment(day, text, dataStore, map) {
                    let cleanText = text;
                    const wIndex = cleanText.indexOf("Wochensumme");
                    if (wIndex !== -1) cleanText = cleanText.substring(0, wIndex);
                    const zIndex = cleanText.indexOf("Zeitkonto");
                    if (zIndex !== -1) cleanText = cleanText.substring(0, zIndex);
                    const kIndex = cleanText.indexOf("Kontingent");
                    if (kIndex !== -1) cleanText = cleanText.substring(0, kIndex);
                    
                    if (cleanText.trim().startsWith("Tag ")) return;
                    
                    if(!dataStore[day]) dataStore[day] = [];
                    
                    let glz_saldo_val = null;
                    const floats = [...cleanText.matchAll(/-?\d{1,3}[.,]\d{2}/g)].map(m => m[0]);
                    if (floats.length > 0) {
                        glz_saldo_val = parseFloat(floats[floats.length - 1].replace(',', '.'));
                    }

                    let foundType = null;
                    for(const [k,v] of Object.entries(map)) { 
                        if(cleanText.includes(k) && v !== 'missing') foundType = v; 
                        if(cleanText.includes("BUCHUNG FEHLT")) foundType = 'missing';
                    }

                    const times = [...cleanText.matchAll(/(\d{2}:\d{2})/g)].map(m=>m[1]);
                    const validTimes = times.filter(t => t !== "00:00");
                    
                    let is_valid = false;
                    
                    if (foundType === "missing") {
                        dataStore[day].push({ type: '', start: '', end: '', comment: '⚠️ Fehlt im PDF', glz_override: null, glz_override_source: null });
                        return;
                    } 
                    else if (validTimes.length >= 2) {
                        for(let i=0; i<validTimes.length-1; i+=2) {
                            let e_glz = (i===0) ? glz_saldo_val : null;
                            let src = e_glz !== null ? 'pdf' : null;
                            dataStore[day].push({ 
                                type: foundType ? foundType : "office", 
                                start: validTimes[i], 
                                end: validTimes[i+1], 
                                comment: cleanText.toLowerCase().includes("betriebsausflug") ? "Betriebsausflug" : "",
                                glz_override: e_glz, 
                                glz_override_source: src 
                            });
                        }
                    } 
                    else if (['vacation', 'sick', 'glz'].includes(foundType)) {
                        dataStore[day].push({ type: foundType, start: '', end: '', glz_override: glz_saldo_val, glz_override_source: glz_saldo_val !== null ? 'pdf' : null });
                    } 
                    else if (glz_saldo_val !== null) {
                        let already_exists = false;
                        for(let existing of dataStore[day]) {
                            if (!existing.start) {
                                already_exists = true;
                                existing.glz_override = glz_saldo_val;
                                existing.glz_override_source = 'pdf';
                                break;
                            }
                        }
                        if (!already_exists) {
                            dataStore[day].push({ type: '', start: '', end: '', glz_override: glz_saldo_val, glz_override_source: 'pdf' });
                        }
                    }
                }
                
                const daysInMonth = new Date(year, month, 0).getDate();
                for(const [d, blocks] of Object.entries(dailyData)) {
                     const dateIso = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                     const dateObj = new Date(year, month-1, d);
                     const info = this.getDayInfo(dateObj);
                     
                     const cleanBlocks = blocks.filter(b => {
                         const hasTimes = b.start && b.end;
                         const hasComment = !!b.comment;
                         const hasOverride = b.glz_override !== null && b.glz_override !== undefined;
                         const isFreeDay = !info.is_workday;
                         if (hasTimes || !isFreeDay || hasComment || hasOverride) return true;
                         return false;
                     });

                     if(this.importDialog.overwrite) Store.saveDayEntries(dateIso, []);
                     const existing = Store.getEntries()[dateIso] || [];
                     
                     if(this.importDialog.overwrite || existing.length === 0) {
                         let finalBlocks = [];
                         for(let e of cleanBlocks) {
                             if(!this.importDialog.overwrite) {
                                 let isDup = existing.some(ex => ex.type === e.type && ex.start === e.start);
                                 if(isDup) continue;
                             }
                             finalBlocks.push(e);
                         }
                         
                         if (finalBlocks.length > 0) {
                             finalBlocks.sort((a,b) => (a.start||"").localeCompare(b.start||""));
                             Store.saveDayEntries(dateIso, finalBlocks);
                             cnt++;
                         }
                     }
                }
                this.showMsg(`${cnt} Tage importiert.`);
                this.loadData();
            } catch(e) { console.error(e); this.showMsg("Import Fehler: " + e.message, "error"); }
        },

        getDayInfo(dateObj) {
            const ymd = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const cust = this.customHolidays[ymd];
            const activeDays = this.settings.active_weekdays || [];
            const dayIdx = (dateObj.getDay() + 6) % 7; 
            const is_active = activeDays.includes(dayIdx);
            
            let is_workday = false, target = 0.0, hName = "", is_short = false, is_off = false;
            
            if(cust) {
                hName = cust.name;
                if(cust.hours > 0) { is_workday = true; target = cust.hours; is_short = true; }
            } else {
                hName = getHolidayName(dateObj, this.customHolidays);
                if(!hName && is_active) {
                    is_workday = true;
                    target = activeDays.length > 0 ? (this.settings.weekly_hours / activeDays.length) : 0;
                }
                if(!is_active) is_off = true;
            }
            return { is_workday, target, holiday_name: hName, is_short_day: is_short, is_off_day: is_off };
        },

        getGlzCarryover(year, month) {
            const targetDateObj = new Date(year, month - 1, 0); 
            const targetDateStr = new Date(targetDateObj.getTime() - (targetDateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const allEntries = Store.getEntries();
            const dates = Object.keys(allEntries).sort();
            
            let lastOverrideDate = null;
            let runningGlz = 0.0;
            
            for(let i=dates.length-1; i>=0; i--) {
                if (dates[i] <= targetDateStr) {
                    const overrideEntry = allEntries[dates[i]].find(e => e.glz_override != null);
                    if (overrideEntry) {
                        lastOverrideDate = dates[i];
                        runningGlz = overrideEntry.glz_override;
                        break;
                    }
                }
            }
            
            let startDate;
            if (lastOverrideDate) {
                startDate = new Date(lastOverrideDate);
                startDate.setDate(startDate.getDate() + 1);
            } else {
                runningGlz = 0.0;
                startDate = new Date(year, 0, 1);
            }
            
            if (startDate > targetDateObj) return runningGlz;
            
            const todayStr = new Date().toISOString().split('T')[0];
            let curr = new Date(startDate);
            
            while (curr <= targetDateObj) {
                const currStr = new Date(curr.getTime() - (curr.getTimezoneOffset()*60000)).toISOString().split('T')[0];
                const info = this.getDayInfo(curr);
                const dayEntries = allEntries[currStr] || [];
                
                let isFuture = currStr >= todayStr;
                
                let dayNet = 0.0;
                for (let e of dayEntries) {
                    if (e.type === 'planned') { 
                        if (e.start && e.end) dayNet += calculateNetHours(e.start, e.end);
                        else dayNet += info.target;
                    } else if (['home', 'office', 'dr'].includes(e.type)) { 
                        if (e.start && e.end) dayNet += calculateNetHours(e.start, e.end);
                        else if (isFuture) dayNet += info.target;
                    }
                }
                
                let isPaidLeave = dayEntries.some(e => ['sick', 'vacation'].includes(e.type));
                let isGlzDay = dayEntries.some(e => e.type === 'glz');
                let isEmpty = dayEntries.length === 0 || dayEntries.every(e => !e.type);
                
                let dayDelta = 0.0;
                if (info.is_workday) {
                    if (isPaidLeave) dayDelta = dayNet;
                    else if (isGlzDay) dayDelta = dayNet - info.target;
                    else if (isEmpty && isFuture) dayDelta = 0.0;
                    else dayDelta = dayNet - info.target;
                } else {
                    dayDelta = dayNet;
                }
                
                runningGlz += dayDelta;
                curr.setDate(curr.getDate() + 1);
            }
            return runningGlz;
        },

        autoConvertExpiredEntries() {
            if(!this.settings.auto_convert_planned) return;
            const today = new Date().toISOString().split('T')[0];
            const allEntries = Store.getEntries();
            let changed = false;
            
            for(const [date, entries] of Object.entries(allEntries)) {
                if(date < today) {
                    entries.forEach(e => {
                        if(e.type === 'planned') {
                            e.type = 'home';
                            if(!e.start) {
                                const info = this.getDayInfo(new Date(date));
                                if(info.target > 0) {
                                    e.start = this.settings.default_start_time || '08:00';
                                    let gross = calculateGrossTimeNeeded(info.target);
                                    let [h,m] = e.start.split(':').map(Number);
                                    let min = h*60+m + (gross*60);
                                    e.end = `${Math.floor(min/60).toString().padStart(2,'0')}:${Math.round(min%60).toString().padStart(2,'0')}`;
                                }
                            }
                            changed = true;
                        }
                    });
                    if(changed) Store.saveDayEntries(date, entries);
                }
            }
            if(changed && this.viewMode==='list') this.loadMonthData();
        },

        loadData() {
            this.settings = Store.getSettings();
            this.customHolidays = Store.getCustomHolidays();
            this.autoConvertExpiredEntries();
            if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData();
        },

        loadMonthData() {
            const allEntries = Store.getEntries();
            const year = this.currentYear, month = this.currentMonth;
            const daysInMonth = new Date(year, month, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];
            
            let total_ho=0, total_office=0, workdays=0;
            let current_week_sum = 0.0;
            let current_week_target = 0.0;
            let total_target_hours_month = 0.0;
            
            let running_glz = this.getGlzCarryover(year, month);
            this.items = [];

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month-1, d);
                const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                const info = this.getDayInfo(dateObj);
                let isFuture = dateStr >= todayStr;
                
                if (info.is_workday) { 
                    workdays++; 
                    total_target_hours_month += info.target; 
                }
                
                // Dynamisches Wochen-Ziel (behebt Bug bei gesplitteten Wochen!)
                current_week_target += info.target;

                const dayEntries = JSON.parse(JSON.stringify(allEntries[dateStr] || []));
                
                let dayNet = 0.0;
                let dayHoPart = 0, dayOffPart = 0;
                let dayOverride = null;
                let dayOverrideSource = null;

                dayEntries.forEach(e => {
                    let h = 0.0;
                    if(e.type === 'planned') {
                        if(e.start && e.end) h = calculateNetHours(e.start, e.end);
                        else h = info.target;
                    } 
                    else if(['home','office','dr'].includes(e.type)) {
                        if(e.start && e.end) h = calculateNetHours(e.start, e.end);
                        else if(isFuture) h = info.target;
                    }
                    
                    e.net = parseFloat(h.toFixed(2)); 
                    dayNet += h;
                    
                    if(e.glz_override != null) {
                        dayOverride = e.glz_override;
                        dayOverrideSource = e.glz_override_source;
                        e.glz_override = (e.glz_override > 0 ? '+' : '') + this.formatNum(e.glz_override);
                    }
                    
                    if(['home','planned'].includes(e.type)) dayHoPart += h;
                    else if(['office','dr'].includes(e.type)) dayOffPart += h;
                });
                
                if(dayHoPart + dayOffPart > 0) {
                    if(dayNet > 0) {
                        const ratio = dayNet / (dayHoPart + dayOffPart);
                        total_ho += dayHoPart * ratio; total_office += dayOffPart * ratio;
                    } else {
                        total_ho += dayHoPart;
                        total_office += dayOffPart;
                    }
                }

                current_week_sum += dayNet;
                
                let mainType = "";
                if(dayEntries.length > 0) {
                     if(dayOffPart > dayHoPart) mainType = "office";
                     else if(dayHoPart > 0) mainType = "home";
                     else if(dayEntries.some(e=>e.type==='planned')) mainType = "planned"; 
                     else mainType = dayEntries[0].type;
                }

                let dayDelta = 0.0;
                let isPaidLeave = dayEntries.some(e => ['sick', 'vacation'].includes(e.type));
                let isGlzDay = dayEntries.some(e => e.type === 'glz');
                let isEmpty = dayEntries.length === 0 || dayEntries.every(e => !e.type);
                
                if (info.is_workday) {
                    if (isPaidLeave) dayDelta = dayNet;
                    else if (isGlzDay) dayDelta = dayNet - info.target;
                    else if (isEmpty && isFuture) dayDelta = 0.0;
                    else dayDelta = dayNet - info.target;
                } else {
                    dayDelta = dayNet;
                }

                running_glz += dayDelta;
                if (dayOverride !== null) running_glz = dayOverride;

                if(dayEntries.length === 0) dayEntries.push({type:'', start:'', end:'', comment:'', glz_override: null, glz_override_source: null});

                this.items.push({ 
                    row_type: 'day', date: dateStr, day_num: d, weekday_index: (dateObj.getDay()+6)%7, iso_week: getISOWeek(dateObj), 
                    is_holiday: (info.holiday_name && !info.is_workday), holiday_name: info.holiday_name, is_short_day: info.is_short_day, is_off_day: info.is_off_day,
                    daily_target: info.target, entries: dayEntries, total_net: dayNet, main_type: mainType, glz_saldo: running_glz, 
                    glz_override: dayOverride, glz_override_source: dayOverrideSource
                });
                
                if((dateObj.getDay()+6)%7 === 6 || d === daysInMonth) {
                    if (current_week_target > 0 || current_week_sum > 0) {
                        this.items.push({ 
                            row_type: 'summary', 
                            iso_week: getISOWeek(dateObj), 
                            sum: parseFloat(current_week_sum.toFixed(2)), 
                            target: parseFloat(current_week_target.toFixed(2)) 
                        });
                    }
                    current_week_sum = 0.0;
                    current_week_target = 0.0;
                }
            }
            
            const max_ho = total_target_hours_month * (this.settings.ho_quota_percent / 100);
            this.stats = { total_ho_made: total_ho, total_ho_allowed: max_ho, total_office_made: total_office, total_work_made: total_ho+total_office, workdays_month: workdays, current_glz: running_glz };
        },
        
        loadYearData() {
            const allEntries = Store.getEntries();
            const year = this.currentYear;
            this.yearData = [];
            const todayStr = new Date().toISOString().split('T')[0];
            
            for(let m=1; m<=12; m++) {
                const daysInMonth = new Date(year, m, 0).getDate();
                let ho_h=0, off_h=0, wd=0, total_target_month=0.0;
                let days_ho=0, days_off=0, days_vac=0;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const dateObj = new Date(year, m-1, d);
                    const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                    const info = this.getDayInfo(dateObj);
                    if(info.is_workday) { wd++; total_target_month += info.target; }
                    
                    const entries = allEntries[dateStr] || [];
                    if(entries.length > 0) {
                        let isFuture = dateStr >= todayStr;
                        let dayNet = 0.0;
                        
                        let hasHo=false, hasOff=false, hasVac=false;
                        let rawHo=0, rawOff=0;

                        entries.forEach(e => {
                            let h = 0.0;
                            if(e.type === 'planned') { 
                                if (e.start && e.end) h = calculateNetHours(e.start, e.end);
                                else h = info.target;
                            }
                            else if(['home','office','dr'].includes(e.type)) { 
                                if (e.start && e.end) h = calculateNetHours(e.start, e.end);
                                else if (isFuture) h = info.target;
                            }
                            
                            dayNet += h;

                            if(['home','planned'].includes(e.type)) { hasHo=true; rawHo += h; }
                            if(['office','dr'].includes(e.type)) { hasOff=true; rawOff += h; }
                            if(e.type === 'vacation') {
                                if(info.is_workday) hasVac = true;
                            }
                        });
                        
                        if(hasHo) days_ho++; if(hasOff) days_off++; if(hasVac) days_vac++;
                        
                        if(rawHo+rawOff > 0) {
                            const ratio = dayNet / (rawHo+rawOff);
                            ho_h += rawHo * ratio; off_h += rawOff * ratio;
                        } else if (rawHo > 0) {
                            ho_h += rawHo;
                        }
                    }
                }
                
                this.yearData.push({ 
                    month: m, 
                    days_ho, 
                    days_office: days_off, 
                    days_vacation: days_vac, 
                    ho_hours_made: parseFloat(ho_h.toFixed(2)), 
                    ho_hours_allowed: parseFloat((total_target_month * (this.settings.ho_quota_percent/100)).toFixed(2)), 
                    office_hours_made: parseFloat(off_h.toFixed(2)),
                    work_hours_target: parseFloat(total_target_month.toFixed(2))
                });
            }

            if (this.viewMode === 'year') {
                this.$nextTick(() => { this.renderCharts(); });
            }
        },

        destroyCharts() {
            if (activeCharts.donut) {
                activeCharts.donut.destroy();
                activeCharts.donut = null;
            }
            if (activeCharts.bar) {
                activeCharts.bar.destroy();
                activeCharts.bar = null;
            }
        },

        renderCharts() {
            if (!window.Chart || !this.yearData || this.yearData.length === 0) return;
            this.destroyCharts();

            const ctxDonut = document.getElementById('donutChart');
            const ctxBar = document.getElementById('barChart');
            if (!ctxDonut || !ctxBar) return;

            Chart.defaults.color = '#94a3b8';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.05)';
            Chart.defaults.font.family = "'Inter', sans-serif";

            activeCharts.donut = new Chart(ctxDonut, {
                type: 'doughnut',
                data: {
                    labels: ['Home Office', 'Büro', 'Urlaub'],
                    datasets: [{
                        data: [this.yearTotalHo, this.yearTotalOffice, this.yearTotalVacation],
                        backgroundColor: ['#10b981', '#818cf8', '#d946ef'],
                        borderWidth: 0,
                        hoverOffset: 4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, cutout: '75%', plugins: { legend: { position: 'right', labels: { boxWidth: 10, usePointStyle: true } } } }
            });

            activeCharts.bar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                    datasets: [{
                        label: 'HO Tage',
                        data: this.yearData.map(d => d.days_ho),
                        backgroundColor: '#3b82f6',
                        borderRadius: 6
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, grid: { display: true } }, x: { grid: { display: false } } } }
            });
        },

        isFutureDay(dateStr) { 
            if(!dateStr) return false; 
            const d = new Date(dateStr); 
            const today = new Date(); 
            today.setHours(0,0,0,0); 
            return d > today; 
        },

        getAvailableTypes(dateStr) {
            const isFuture = this.isFutureDay(dateStr);
            return [
                { title: isFuture ? 'Home Office ⏳' : 'Home Office', value: isFuture ? 'planned' : 'home' },
                ...this.baseTypes.filter(t => t.value !== 'home')
            ];
        },
        
        getTypeName(val) { 
            if (val === 'planned') return 'Home Office ⏳';
            if (val === 'home') return 'Home Office';
            const found = this.baseTypes.find(t => t.value === val); 
            return found ? found.title : ''; 
        },

        openEditDialog(day) { 
            this.editingDay = day; 
            if(!this.editingDay.entries || this.editingDay.entries.length === 0) { this.editingDay.entries = [{type: 'home', start: '', end: '', net: 0, comment: '', glz_override: null}]; } 
            this.dialogEditDay = true; 
        },
        addEntryToDay(day) { day.entries.push({type: 'home', start: '', end: '', comment: ''}); },
        deleteEntry(day, idx) { 
            day.entries.splice(idx, 1); 
            if(day.entries.length===0) day.entries.push({type:'', start:'', end:'', comment:'', glz_override: day.glz_override});
            this.saveSingleEntry(day.date); 
        },
        onEntryChange(day, entry) {
            if(['home', 'office', 'dr'].includes(entry.type) && !entry.start) {
                entry.start = this.settings.default_start_time || '08:00';
                if(day.entries.length === 1) {
                     const dailyTarget = this.calcDailyTarget;
                     let startMin = 480; try { let p = entry.start.split(':'); startMin = parseInt(p[0])*60 + parseInt(p[1]); } catch(e){}
                     let grossHours = calculateGrossTimeNeeded(dailyTarget);
                     const endMin = startMin + (grossHours * 60);
                     const h = Math.floor(endMin / 60); const m = Math.round(endMin % 60);
                     entry.end = `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
                }
             }
             this.saveSingleEntry(day.date);
        },
        debouncedSave(dateStr) {
            clearTimeout(this.saveTimeout);
            this.saveTimeout = setTimeout(() => { this.saveSingleEntry(dateStr); }, 800);
        },
        saveSingleEntry(date) {
             let dayObj = this.items.find(i=>i.date === date); if(this.editingDay && this.editingDay.date === date) dayObj = this.editingDay;
             if(dayObj) {
                 dayObj.entries.forEach(e => {
                     if(e.start) e.start = normalizeTimeInput(e.start) || e.start;
                     if(e.end) e.end = normalizeTimeInput(e.end) || e.end;
                     if(e.comment) e.comment = e.comment.trim();
                     
                     if (e.glz_override !== null && e.glz_override !== undefined && e.glz_override !== '') {
                        e.glz_override = parseFloat(String(e.glz_override).replace(',', '.'));
                        if (isNaN(e.glz_override)) e.glz_override = null;
                     } else {
                        e.glz_override = null;
                        e.glz_override_source = null;
                     }
                 });
                 Store.saveDayEntries(date, dayObj.entries);
                 if(this.viewMode==='list') this.loadMonthData();
             }
        },
        
        openSeriesDialog() { const nextM = new Date(); nextM.setMonth(nextM.getMonth() + 1); const y = nextM.getFullYear(), m = nextM.getMonth(); const lastDay = new Date(y, m + 1, 0).getDate(); this.seriesDialog.start = `${y}-${(m+1).toString().padStart(2,'0')}-01`; this.seriesDialog.end = `${y}-${(m+1).toString().padStart(2,'0')}-${lastDay}`; this.seriesDialog.show = true; },
        
        // Smart Series Planner
        saveSeriesPlan() {
            this.seriesDialog.show = false;
            let curr = new Date(this.seriesDialog.start); const end = new Date(this.seriesDialog.end);
            let cnt = 0;
            const todayStr = new Date().toISOString().split('T')[0];
            
            while(curr <= end) {
                const dayIdx = (curr.getDay()+6)%7;
                if(this.seriesDialog.weekdays.includes(dayIdx)) {
                    const dStr = new Date(curr.getTime() - (curr.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                    const info = this.getDayInfo(curr);
                    if(info.holiday_name && !info.is_workday) { curr.setDate(curr.getDate()+1); continue; }
                    
                    const existing = Store.getEntries()[dStr] || [];
                    if(this.seriesDialog.overwrite || existing.length === 0) {
                        
                        let finalType = this.seriesDialog.type;
                        let startT = '';
                        let endT = '';

                        if (finalType === 'home' && dStr > todayStr) {
                            finalType = 'planned';
                        } else if (['home', 'office', 'dr'].includes(finalType)) {
                            if (info.target > 0) {
                                startT = this.settings.default_start_time || '08:00';
                                let gross = calculateGrossTimeNeeded(info.target);
                                let [h,m] = startT.split(':').map(Number);
                                let min = h*60 + m + (gross * 60);
                                endT = `${Math.floor(min/60).toString().padStart(2,'0')}:${Math.round(min%60).toString().padStart(2,'0')}`;
                            }
                        }

                        Store.saveDayEntries(dStr, [{type: finalType, start: startT, end: endT, comment:''}]);
                        cnt++;
                    }
                }
                curr.setDate(curr.getDate()+1);
            }
            this.showMsg(`${cnt} Tage geplant.`);
            this.loadMonthData();
        },

        getGermanDay(index) { return ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][index] || ''; },
        getGermanDayShort(index) { return ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][index] || ''; },
        getGermanMonthName(m) { if(!m) return ""; const d = new Date(); d.setMonth(m-1); return d.toLocaleString('de-DE', { month: 'short' }); },
        isWeekend(day) { return day.weekday_index >= 5; },
        isToday(dateStr) { return dateStr === new Date().toISOString().split('T')[0]; },
        needsTimeInput(type) { return ['home', 'office', 'dr', '', null].includes(type); },
        
        getStatusIconColor(type, isClass=false) { 
            const map = { 'home': 'mint', 'office': 'indigo', 'planned': 'mint', 'sick': 'error', 'vacation': 'purple', 'dr': 'info' }; 
            return map[type] || 'slate'; 
        },
        
        getGlzColor(override, saldo) {
            if (override !== null && override !== undefined && override !== '') {
                const val = parseFloat(String(override).replace(',', '.'));
                if (!isNaN(val)) return val >= 0 ? 'text-mint' : 'text-error';
            }
            return saldo >= 0 ? 'text-mint' : 'text-error';
        },

        getWeeklyColor(item) {
            if (item.target === 0 && item.sum === 0) return 'text-slate'; 
            if (!item.sum && item.sum !== 0) return 'text-slate';
            if (item.sum >= item.target) return 'text-mint';
            const today = new Date();
            const isPastMonth = this.currentYear < today.getFullYear() || (this.currentYear === today.getFullYear() && this.currentMonth < today.getMonth() + 1);
            if (isPastMonth) return 'text-warning';
            return 'text-bright';
        },

        changeMonth(delta) { this.currentDate = new Date(this.currentDate.setMonth(this.currentDate.getMonth() + delta)); this.loadMonthData(); },
        changeYear(delta) { this.currentDate = new Date(this.currentDate.setFullYear(this.currentDate.getFullYear() + delta)); if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        saveSettings() { Store.saveSettings(this.settings); Store.saveCustomHolidays(this.customHolidays); this.dialogSettings = false; if(this.viewMode==='year') this.loadYearData(); else this.loadMonthData(); },
        
        editCustomHoliday(h, originalDate) {
            this.newCustomHoliday = { _oldDate: originalDate, date: h.date, name: h.name, hours: h.hours };
        },
        addCustomHoliday() { 
            if(!this.newCustomHoliday.date || !this.newCustomHoliday.name) return; 
            if(this.newCustomHoliday._oldDate && this.newCustomHoliday._oldDate !== this.newCustomHoliday.date) { delete this.customHolidays[this.newCustomHoliday._oldDate]; }
            this.customHolidays[this.newCustomHoliday.date] = { date: this.newCustomHoliday.date, name: this.newCustomHoliday.name, hours: parseFloat(this.newCustomHoliday.hours || 0)}; 
            this.newCustomHoliday = { _oldDate: null, date:'', name:'', hours:0}; 
            Store.saveCustomHolidays(this.customHolidays);
            if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData();
        },
        deleteCustomHoliday(dateKey) { 
            delete this.customHolidays[dateKey]; 
            Store.saveCustomHolidays(this.customHolidays);
            if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData();
        },
        
        addWaeldchestag() { 
            const y = this.currentYear; 
            const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451); 
            const monthE = Math.floor((h+l-7*m_easter+114)/31); const dayE = ((h+l-7*m_easter+114)%31)+1; 
            const easterDate = new Date(y, monthE - 1, dayE); 
            const waeldchestag = new Date(easterDate); waeldchestag.setDate(easterDate.getDate() + 51); 
            const dateStr = new Date(waeldchestag.getTime() - (waeldchestag.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; 
            this.newCustomHoliday.date = dateStr; this.newCustomHoliday.name = 'Wäldchestag'; this.newCustomHoliday.hours = 6.0; 
            this.showMsg("Wäldchestag in Eingabe geladen. Bitte prüfen und speichern.", "info"); 
        },
        
        async checkForStoredHandle() { try { const handle = await idbGet('fileHandle'); if(handle) { this.storedHandleName = handle.name; } } catch(e) { console.error(e); } },
        async restoreFileConnection() { try { const handle = await idbGet('fileHandle'); if(!handle) return; const opts = { mode: 'readwrite' }; if ((await handle.queryPermission(opts)) === 'granted' || (await handle.requestPermission(opts)) === 'granted') { this.fileHandle = handle; this.fileName = handle.name; await this.loadFileContent(); } } catch(e) { console.error("Restore failed", e); alert("Konnte Verbindung nicht wiederherstellen."); } },
        async openFile() { 
            try { 
                if (!window.showOpenFilePicker) { 
                    this.$refs.jsonInput.click();
                    return; 
                } 
                const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON', accept: {'application/json': ['.json']} }], multiple: false }); 
                this.fileHandle = handle; this.fileName = handle.name; await idbSet('fileHandle', handle); this.storedHandleName = handle.name; await this.loadFileContent(); 
            } catch(e) {} 
        },
        fallbackLoadJson(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const json = JSON.parse(ev.target.result);
                    Store.set(json);
                    this.loadData();
                    this.showMsg("Datei geladen", "success");
                } catch(err) {
                    this.showMsg("Ungültige JSON Datei", "error");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        },
        async loadFileContent() { const file = await this.fileHandle.getFile(); const text = await file.text(); try { const json = JSON.parse(text); Store.set(json); this.loadData(); } catch(e) { Store.init(); this.saveToFile(); } },
        async saveToFile() { 
            if (!window.showSaveFilePicker && !this.fileHandle) {
                const blob = new Blob([JSON.stringify(Store.get(), null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ho_planer_backup.json';
                a.click();
                URL.revokeObjectURL(url);
                this.unsavedChanges = false;
                this.showMsg("Datei heruntergeladen");
                return;
            }
            if(!this.fileHandle) return; 
            try { const writable = await this.fileHandle.createWritable(); await writable.write(JSON.stringify(Store.get(), null, 2)); await writable.close(); this.unsavedChanges = false; this.showMsg("Datei gespeichert"); } catch(e) { alert("Fehler beim Speichern"); } 
        }
      }
    });

    app.config.compilerOptions.delimiters = ['[[', ']]'];
    app.use(vuetify);
    window.vm = app.mount('#app');
  </script>
</body>
</html>