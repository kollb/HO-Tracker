<!DOCTYPE html>
<html lang="de">
<head>
  <title>Home Office Planer</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <meta name="theme-color" content="#121212">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%231976D2%22><path d=%22M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z%22/></svg>">
  
  <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@400;500;700&family=Roboto:wght@100;300;400;500;700;900&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.css" rel="stylesheet">
  
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script>
    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
  </script>

  <style>
    [v-cloak] { display: none !important; }
    body { font-family: 'Roboto', sans-serif; background-color: #121212; }
    
    .mono-num { font-family: 'Roboto Mono', monospace; letter-spacing: -0.5px; }
    
    /* Dashboard Cards */
    .status-bar { position: sticky; top: 48px; z-index: 10; background: rgb(var(--v-theme-surface)); border-bottom: 1px solid rgba(128,128,128, 0.1); padding: 12px 0; }
    .dash-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.06); border-radius: 12px; padding: 10px 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: transform 0.2s; }
    .dash-card:hover { transform: translateY(-2px); border-color: rgba(255,255,255,0.1); }
    .stat-label { font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.6; font-weight: 600; margin-bottom: 4px; display: flex; align-items: center; justify-content: center; text-align: center; line-height: 1.2;}
    .stat-value { font-weight: 700; font-size: 1.1rem; line-height: 1; }

    /* Invisible Inputs */
    .inv-input { border-radius: 6px; transition: background-color 0.2s; cursor: text; }
    .inv-input:hover { background-color: rgba(255,255,255,0.08); }
    .inv-input .v-field__input { padding: 4px 8px !important; min-height: 28px !important; text-align: center; }
    .inv-input-left .v-field__input { text-align: left; }
    .v-field--variant-plain .v-field__overlay { display: none; }

    /* Kalender */
    .calendar-wrapper { display: grid; grid-template-columns: repeat(7, 1fr) 60px; gap: 8px; padding: 10px; }
    .cal-header { text-align: center; font-weight: bold; font-size: 0.85rem; padding-bottom: 5px; text-transform: uppercase; opacity: 0.5; letter-spacing: 1px; }
    .cal-cell { background-color: rgba(128,128,128, 0.02); border: 1px solid rgba(128,128,128, 0.1); border-radius: 8px; min-height: 110px; padding: 8px; display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: all 0.2s; position: relative; overflow: hidden; }
    .cal-cell:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 2; transform: translateY(-2px); border-color: rgba(255,255,255,0.2); }
    
    .status-home { background: linear-gradient(90deg, rgba(76,175,80,0.1) 0%, transparent 100%); border-left: 4px solid #4CAF50 !important; }
    .status-office { background: linear-gradient(90deg, rgba(255,193,7,0.1) 0%, transparent 100%); border-left: 4px solid #FFC107 !important; }
    .status-sick { background: linear-gradient(90deg, rgba(244,67,54,0.1) 0%, transparent 100%); border-left: 4px solid #F44336 !important; }
    .status-vacation { background: linear-gradient(90deg, rgba(156,39,176,0.1) 0%, transparent 100%); border-left: 4px solid #9C27B0 !important; }
    .status-dr { background: linear-gradient(90deg, rgba(33,150,243,0.1) 0%, transparent 100%); border-left: 4px solid #2196F3 !important; }
    .status-planned { background: linear-gradient(90deg, rgba(33,150,243,0.05) 0%, transparent 100%); border-left: 4px dashed #2196F3 !important; }
    
    .cal-cell.is-holiday, .cal-cell.is-weekend { opacity: 0.6; }
    .cal-cell.is-off-day { opacity: 0.3; background-image: repeating-linear-gradient(45deg, transparent, transparent 10px, rgba(255,255,255,0.02) 10px, rgba(255,255,255,0.02) 20px); }

    .cal-date { font-weight: bold; font-size: 1rem; margin-bottom: 4px; display: flex; align-items: center; }
    .cal-holiday-name { font-size: 0.7rem; color: #ef5350; line-height: 1.1; margin-bottom: 4px; font-weight: 500;}
    .cal-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
    .cal-week-sum { display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.85rem; opacity: 0.5; writing-mode: vertical-rl; transform: rotate(180deg); }

    /* Timeline-Dialog */
    .timeline-wrap { position: relative; padding-left: 16px; margin-left: 8px; }
    .timeline-wrap::before { content: ''; position: absolute; left: 0; top: 16px; bottom: 30px; width: 2px; background: rgba(255,255,255,0.1); }
    .timeline-node { position: relative; margin-bottom: 16px; }
    .timeline-node::before { content: ''; position: absolute; left: -21px; top: 16px; width: 10px; height: 10px; border-radius: 50%; background: #1976D2; border: 2px solid #1e1e1e; z-index: 1; }
    .timeline-node.timeline-add::before { background: #757575; top: 8px;}

    /* Table Rows & Sticky Header */
    .v-table thead th { position: sticky !important; top: 0; z-index: 5; background: rgb(var(--v-theme-surface)) !important; border-bottom: 1px solid rgba(255,255,255,0.1) !important; }
    .day-row { transition: background-color 0.2s; border-bottom: 1px solid rgba(128,128,128, 0.05); }
    .day-row:hover { background-color: rgba(128,128,128, 0.08) !important; }
    
    .day-row.is-today td { background-color: rgba(33, 150, 243, 0.08) !important; }
    .day-row.is-today td:first-child { box-shadow: inset 3px 0 0 0 #2196F3; }
    .cal-cell.is-today { border: 2px solid #2196F3; background-color: rgba(33, 150, 243, 0.05); }
    
    /* Hover-Aktionen in Tabelle */
    .row-actions { opacity: 0; transition: opacity 0.2s; }
    .day-row:hover .row-actions { opacity: 1; }

    .weekend, .holiday-row { background-color: rgba(128,128,128, 0.02); opacity: 0.7; }
    .week-summary-row { background-color: rgba(128,128,128, 0.05); height: 36px !important; }
    .week-summary-row td { font-weight: bold; font-size: 0.85rem; padding-top: 0 !important; padding-bottom: 0 !important; }

    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot.green { background-color: #4caf50; box-shadow: 0 0 4px #4caf50; }
    .dot.red { background-color: #f44336; }
    .dot.orange { background-color: #ff9800; }

    @media (max-width: 800px) {
        .calendar-wrapper { gap: 4px; padding: 4px; grid-template-columns: repeat(7, 1fr) 25px; }
        .cal-cell { min-height: 60px; padding: 4px; border-radius: 6px; }
        .cal-holiday-name, .cal-content { display: none !important; }
        .cal-date { font-size: 0.8rem; margin: 0; }
        .dash-card { padding: 8px; }
        .stat-value { font-size: 0.9rem; }
        .row-actions { opacity: 1; } 
    }
  </style>
</head>
<body>
  
  <div id="app" v-cloak>
    <v-app>
      <v-snackbar v-model="snackbar.show" :color="snackbar.color" :timeout="4000" location="top">
         [[ snackbar.text ]]
         <template v-slot:actions><v-btn variant="text" @click="snackbar.show = false">OK</v-btn></template>
      </v-snackbar>

      <v-dialog v-model="importDialog.show" max-width="450">
          <v-card rounded="lg">
              <v-card-title class="bg-primary text-white d-flex align-center"><v-icon start>mdi-file-pdf-box</v-icon> PDF Import (Lokal)</v-card-title>
              <v-card-text class="pt-4">
                  <p class="text-body-2 mb-2">Verarbeitet den Zeitnachweis sicher und lokal in deinem Browser.</p>
                  <v-checkbox v-model="importDialog.overwrite" label="Existierende Einträge überschreiben" hide-details class="mt-2" color="primary"></v-checkbox>
                  <div class="text-caption text-grey mt-2"><v-icon size="small" class="mr-1">mdi-alert-circle-outline</v-icon>Erkennt Monat, Jahr & den GLZ-Saldo automatisch.</div>
              </v-card-text>
              <v-card-actions class="px-4 pb-4"><v-spacer></v-spacer><v-btn variant="text" @click="importDialog.show = false">Abbrechen</v-btn><v-btn variant="flat" color="primary" @click="processPdfImport">Import starten</v-btn></v-card-actions>
          </v-card>
      </v-dialog>
      
      <v-dialog v-model="seriesDialog.show" max-width="500">
        <v-card rounded="lg">
            <v-card-title class="bg-primary text-white d-flex align-center"><v-icon start>mdi-calendar-multiple</v-icon> Serien-Planer</v-card-title>
            <v-card-text class="pt-4">
                <v-row density="compact">
                    <v-col cols="6"><v-text-field v-model="seriesDialog.start" label="Von" type="date" variant="outlined" density="compact"></v-text-field></v-col>
                    <v-col cols="6"><v-text-field v-model="seriesDialog.end" label="Bis" type="date" variant="outlined" density="compact"></v-text-field></v-col>
                </v-row>
                <div class="mb-3 d-flex justify-space-between"><v-checkbox v-for="(day, idx) in ['Mo','Di','Mi','Do','Fr']" :key="idx" v-model="seriesDialog.weekdays" :value="idx" :label="day" density="compact" hide-details></v-checkbox></div>
                <v-select v-model="seriesDialog.type" :items="types" label="Status setzen auf" item-title="title" item-value="value" variant="outlined" density="comfortable"></v-select>
                <v-checkbox v-model="seriesDialog.overwrite" label="Vorhandene überschreiben" density="compact" color="warning"></v-checkbox>
            </v-card-text>
            <v-card-actions class="px-4 pb-4"><v-spacer></v-spacer><v-btn variant="text" @click="seriesDialog.show = false">Abbrechen</v-btn><v-btn variant="flat" color="primary" @click="saveSeriesPlan">Ausführen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <input type="file" ref="pdfInput" style="display: none" accept=".pdf" @change="onPdfFileChange">
      <input type="file" ref="jsonInput" style="display: none" accept=".json" @change="fallbackLoadJson">

      <v-navigation-drawer v-model="drawer" :permanent="!$vuetify.display.mobile" :temporary="$vuetify.display.mobile" width="260" border="none" elevation="2">
          <div class="pa-4 pb-2 d-flex align-center">
              <v-icon color="primary" size="large" class="mr-2">mdi-office-building-marker</v-icon>
              <div class="text-h6 font-weight-bold">HO Planer</div>
          </div>
          
          <div class="px-4 pb-4 text-caption d-flex align-center" v-if="fileHandle">
              <span class="dot green mr-2"></span><span class="text-truncate">[[ fileName ]]</span>
              <v-btn icon="mdi-content-save" size="x-small" variant="text" class="ml-2" :color="unsavedChanges ? 'warning' : 'grey'" @click="saveToFile" title="Speichern"></v-btn>
          </div>
          <div class="px-4 pb-4 text-caption d-flex align-center" v-else-if="storedHandleName">
              <span class="dot orange mr-2"></span><span class="text-truncate">[[ storedHandleName ]]</span>
              <v-btn icon="mdi-link-variant" size="x-small" variant="text" class="ml-2" @click="restoreFileConnection" title="Verbindung wiederherstellen"></v-btn>
              <v-btn icon="mdi-folder-open" size="x-small" variant="text" class="ml-1" @click="openFile" title="Andere Datei öffnen"></v-btn>
          </div>
          <div class="px-4 pb-4 text-caption d-flex align-center" v-else>
              <span class="dot red mr-2"></span>Lokal (Browser)
              <v-btn icon="mdi-folder-open" size="x-small" variant="text" class="ml-2" @click="openFile" title="Datei öffnen/anlegen"></v-btn>
              <v-btn icon="mdi-download" size="x-small" variant="text" class="ml-1" @click="saveToFile" title="Als JSON herunterladen"></v-btn>
          </div>
          
          <v-divider class="opacity-20 mb-2"></v-divider>
          
          <v-list density="compact" nav>
              <v-list-subheader class="text-uppercase text-caption font-weight-bold">Ansichten</v-list-subheader>
              <v-list-item prepend-icon="mdi-format-list-bulleted" title="Listenansicht" :active="viewMode === 'list'" @click="viewMode = 'list'; if($vuetify.display.mobile) drawer=false;" color="primary" rounded="lg"></v-list-item>
              <v-list-item prepend-icon="mdi-calendar-month" title="Kalender" :active="viewMode === 'calendar'" @click="viewMode = 'calendar'; if($vuetify.display.mobile) drawer=false;" color="primary" rounded="lg"></v-list-item>
              <v-list-item prepend-icon="mdi-chart-bar" title="Jahresübersicht" :active="viewMode === 'year'" @click="viewMode = 'year'; if($vuetify.display.mobile) drawer=false;" color="primary" rounded="lg"></v-list-item>
              
              <v-divider class="my-4 opacity-20"></v-divider>
              
              <v-list-subheader class="text-uppercase text-caption font-weight-bold">Aktionen</v-list-subheader>
              <v-list-item prepend-icon="mdi-file-pdf-box" title="PDF Importieren" @click="triggerPdfImport(); if($vuetify.display.mobile) drawer=false;" rounded="lg"></v-list-item>
              <v-list-item prepend-icon="mdi-calendar-multiple" title="Serien-Planer" @click="openSeriesDialog(); if($vuetify.display.mobile) drawer=false;" rounded="lg"></v-list-item>
              
              <v-spacer style="height: 40px;"></v-spacer>
              <v-list-item prepend-icon="mdi-cog" title="Einstellungen" @click="dialogSettings = true; if($vuetify.display.mobile) drawer=false;" rounded="lg"></v-list-item>
          </v-list>
      </v-navigation-drawer>

      <v-app-bar color="background" density="compact" elevation="0" border="bottom">
        <v-progress-linear v-if="isSaving" indeterminate color="primary" class="position-absolute" style="top: 0; width: 100%; z-index: 9999;"></v-progress-linear>
        <v-app-bar-nav-icon @click.stop="drawer = !drawer" v-if="$vuetify.display.mobile"></v-app-bar-nav-icon>
        <v-spacer></v-spacer>
        <v-btn icon @click="toggleTheme" class="mr-2" variant="tonal" size="small" color="grey">
            <v-icon>[[ theme.global.current.dark ? 'mdi-weather-sunny' : 'mdi-weather-night' ]]</v-icon>
        </v-btn>
      </v-app-bar>

      <v-main>
        <v-container fluid class="status-bar" v-if="viewMode !== 'year'">
            <div class="d-flex flex-wrap align-center justify-space-between" style="max-width: 1400px; gap: 16px;">
                
                <div class="d-flex align-center px-2">
                    <v-btn icon variant="text" size="small" @click="changeMonth(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                    <div class="font-weight-bold mx-2 text-center" style="line-height: 1.1; min-width: 120px;">
                        <div class="text-h6 font-weight-bold text-uppercase">[[ currentMonthName ]]</div>
                        <div class="text-caption opacity-60">[[ currentYear ]]</div>
                    </div>
                    <v-btn icon variant="text" size="small" @click="changeMonth(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
                </div>
                
                <div class="d-flex flex-wrap flex-grow-1 justify-center" style="gap: 12px;">
                    <div class="dash-card">
                        <div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-calendar-check</v-icon>Arbeitstage in<br>diesem Monat</div>
                        <div class="stat-value text-center mono-num">[[ stats.workdays_month ]]</div>
                    </div>
                    <div class="dash-card">
                        <div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-office-building</v-icon>Geleistete<br>Bürostd.</div>
                        <div class="stat-value text-center text-amber-darken-2 mono-num">[[ formatNum(stats.total_office_made) ]] <span class="text-caption opacity-50">h</span></div>
                    </div>
                    <div class="dash-card" :style="stats.current_glz >= 0 ? 'border-left: 3px solid #4CAF50;' : 'border-left: 3px solid #FF5252;'">
                        <div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-clock-outline</v-icon>Gleitzeit<br>Saldo</div>
                        <div class="stat-value text-center mono-num" :class="stats.current_glz >= 0 ? 'text-green' : 'text-red-accent-2'">
                            <span v-if="stats.current_glz > 0">+</span>[[ formatNum(stats.current_glz) ]] <span class="text-caption opacity-50 font-weight-regular">h</span>
                        </div>
                    </div>
                </div>

                <div class="dash-card d-flex align-center" style="min-width: 250px; flex-grow: 1; max-width: 300px; gap: 16px;">
                    <v-progress-circular :model-value="quotaPercentage" :color="getQuotaColor" size="50" width="6" bg-color="rgba(128,128,128,0.2)">
                        <span class="text-caption font-weight-bold">[[ Math.round(quotaPercentage) ]]%</span>
                    </v-progress-circular>
                    <div class="d-flex flex-column justify-center w-100">
                        <span class="stat-label justify-start mb-1 text-left">Home Office Budget</span>
                        <div class="d-flex justify-space-between align-end">
                            <div class="d-flex flex-column">
                                <div class="mono-num font-weight-bold text-subtitle-1" :class="budgetStateColor" style="line-height: 1;"><span v-if="budgetRemainingDays > 0">+</span>[[ formatOneDecimal(budgetRemainingDays) ]] <span class="text-caption opacity-50">Tage</span></div>
                                <div class="text-caption opacity-60 mono-num mt-1">[[ formatNum(budgetRemainingHours) ]] h</div>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </v-container>

        <v-container fluid class="status-bar" v-else>
            <div class="d-flex flex-column flex-md-row align-center justify-center w-100" style="max-width: 1400px;">
                <div class="d-flex align-center justify-center w-100 w-md-auto px-2">
                    <v-btn icon variant="text" size="small" @click="changeYear(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                    <div class="font-weight-bold mx-2 text-center" style="line-height: 1.1; min-width: 180px;">
                        <div class="text-h6 font-weight-bold text-uppercase">Jahresübersicht</div>
                        <div class="text-caption opacity-60">[[ currentYear ]]</div>
                    </div>
                    <v-btn icon variant="text" size="small" @click="changeYear(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
                </div>
            </div>
        </v-container>

        <v-container fluid class="px-4 px-md-6 pb-12">
            <v-card elevation="0" border min-height="500" rounded="lg" style="max-width: 1400px;">
                
                <v-fade-transition hide-on-leave>
                    <div :key="viewMode">
                        <v-table density="compact" v-if="viewMode === 'list'" class="d-none d-md-block" style="width: 100%;">
                            <template v-slot:default>
                                <thead>
                                    <tr style="background-color: rgba(128,128,128,0.05);">
                                        <th class="text-left font-weight-bold text-uppercase opacity-70">Datum</th>
                                        <th class="text-left font-weight-bold text-uppercase opacity-70" style="width:195px">Status</th>
                                        <th class="text-center font-weight-bold text-uppercase opacity-70" style="width:100px">Start</th>
                                        <th class="text-center font-weight-bold text-uppercase opacity-70" style="width:100px">Ende</th>
                                        <th class="text-center font-weight-bold text-uppercase opacity-70" style="width:140px">GLZ Saldo</th>
                                        <th class="text-left font-weight-bold text-uppercase opacity-70">Notiz</th>
                                        <th style="width: 70px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <template v-for="item in items" :key="item ? item.date : 'list-desk'">
                                        <template v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))">
                                            <tr v-for="(entry, index) in item.entries" :key="index"
                                                :class="{'weekend': isWeekend(item), 'off-day-row': item.is_off_day, 'holiday-row': item.is_holiday, 'is-today': isToday(item.date), 'day-row': true}">
                                                
                                                <td class="py-2" style="width: 180px; vertical-align: middle;">
                                                    <div v-if="index === 0">
                                                        <div class="font-weight-bold d-flex align-center" :class="{'text-primary': isToday(item.date)}">
                                                            [[ item.day_num ]]. <span class="opacity-70 font-weight-regular ml-1">[[ getGermanDay(item.weekday_index) ]]</span>
                                                            <v-chip v-if="isToday(item.date)" size="x-small" color="primary" variant="flat" class="ml-2 font-weight-bold px-2" style="height: 16px; font-size: 0.6rem;">HEUTE</v-chip>
                                                        </div>
                                                        <div v-if="item.is_holiday" class="text-caption text-red-lighten-1 font-weight-bold mt-n1">[[ item.holiday_name ]]</div>
                                                    </div>
                                                </td>

                                                <td class="py-1">
                                                    <v-select v-model="entry.type" :items="types" item-title="title" item-value="value" variant="plain" density="compact" hide-details class="inv-input inv-input-left" @update:model-value="onEntryChange(item, entry)"></v-select>
                                                </td>
                                                
                                                <td>
                                                    <v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.start" placeholder="-" variant="plain" density="compact" hide-details class="inv-input mono-num font-weight-medium" @change="saveSingleEntry(item.date, entry)"></v-text-field>
                                                </td>
                                                
                                                <td>
                                                    <v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.end" placeholder="-" variant="plain" density="compact" hide-details class="inv-input mono-num font-weight-medium" @change="saveSingleEntry(item.date, entry)"></v-text-field>
                                                </td>
                                                
                                                <td class="text-center mono-num" style="vertical-align: middle;">
                                                    <div v-if="index === 0" class="font-weight-bold" :class="item.glz_saldo >= 0 ? 'text-green' : 'text-red'">
                                                        <span v-if="item.glz_saldo > 0">+</span>[[ formatNum(item.glz_saldo) ]] <span class="text-caption opacity-50 font-weight-regular">h</span>
                                                        <v-icon v-if="item.glz_override !== null" size="x-small" color="blue-grey" class="ml-1 opacity-80" title="PDF / Manueller GLZ Saldo">mdi-file-pdf-box</v-icon>
                                                    </div>
                                                </td>

                                                <td>
                                                    <v-text-field v-model="entry.comment" placeholder="..." variant="plain" density="compact" hide-details class="inv-input inv-input-left opacity-70" @change="saveSingleEntry(item.date, entry)"></v-text-field>
                                                </td>
                                                
                                                <td style="vertical-align: middle; padding-right: 8px;">
                                                    <div class="row-actions d-flex justify-end">
                                                        <v-btn v-if="index === 0" icon size="small" variant="text" color="grey-darken-1" @click="openEditDialog(item)"><v-icon size="small">mdi-pencil</v-icon></v-btn>
                                                        <v-btn v-else icon size="small" color="error" variant="text" @click="deleteEntry(item, index)"><v-icon size="small">mdi-close</v-icon></v-btn>
                                                    </div>
                                                </td>
                                            </tr>
                                        </template>
                                        <tr v-else-if="item && item.row_type === 'summary'" class="week-summary-row"><td colspan="2" class="text-right pr-4 text-uppercase opacity-60">KW [[ item.iso_week ]] Gesamt:</td><td colspan="5"><span :class="getWeeklyColor(item.sum, item.target)" class="mono-num font-weight-bold">[[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] <span class="text-caption opacity-50 font-weight-regular">h</span></span></td></tr>
                                    </template>
                                </tbody>
                            </template>
                        </v-table>

                        <div v-if="viewMode === 'list'" class="d-md-none pa-2">
                            <template v-for="(item, idx) in items" :key="item.date ? 'mob-'+item.date : 'mob-sum-'+idx">
                                <v-card v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))" class="mb-2" elevation="1" rounded="lg" :class="{'is-today': isToday(item.date)}" @click="openEditDialog(item)">
                                    <div class="d-flex justify-space-between align-center pa-3 pb-1 border-bottom">
                                        <div>
                                            <span class="font-weight-bold text-subtitle-1" :class="{'text-primary': isToday(item.date)}">[[ item.day_num ]]. <span class="opacity-60">[[ getGermanDay(item.weekday_index) ]]</span></span>
                                            <span v-if="item.is_holiday" class="text-caption text-red ml-2 font-weight-bold">[[ item.holiday_name ]]</span>
                                        </div>
                                        <div class="text-right">
                                            <div class="text-caption font-weight-bold mono-num" :class="item.glz_saldo >= 0 ? 'text-green' : 'text-red'">
                                                <v-icon v-if="item.glz_override !== null" size="x-small" color="blue-grey" class="mr-1 opacity-80">mdi-file-pdf-box</v-icon>
                                                <span v-if="item.glz_saldo > 0">+</span>[[ formatNum(item.glz_saldo) ]] <span class="opacity-50">h</span>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="pa-3 pt-2">
                                        <div v-for="(entry, i) in item.entries" :key="i" class="text-body-2 d-flex align-center mb-1">
                                            <v-icon size="small" :color="getStatusIconColor(entry.type)" class="mr-2">[[ getStatusIcon(entry.type) ]]</v-icon>
                                            <span class="mr-2 font-weight-medium" style="min-width: 90px">[[ getTypeName(entry.type) ]]</span>
                                            <span v-if="entry.start" class="mono-num opacity-80">[[ entry.start ]] - [[ entry.end ]]</span>
                                            <span v-if="entry.comment" class="ml-2 text-grey text-truncate">([[ entry.comment ]])</span>
                                        </div>
                                        <div v-if="item.entries[0].type === ''" class="text-caption text-grey">Tippen zum Bearbeiten...</div>
                                    </div>
                                </v-card>
                                <div v-else-if="item && item.row_type === 'summary'" class="text-center py-2 mb-2 text-caption font-weight-bold text-uppercase opacity-70 dash-card mx-1">
                                    KW [[ item.iso_week ]]: <span :class="getWeeklyColor(item.sum, item.target)" class="mono-num ml-2">[[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] h</span>
                                </div>
                            </template>
                        </div>

                        <div v-if="viewMode === 'calendar'" class="pa-2">
                            <div class="calendar-wrapper">
                                <div class="cal-header">Mo</div><div class="cal-header">Di</div><div class="cal-header">Mi</div><div class="cal-header">Do</div><div class="cal-header">Fr</div><div class="cal-header text-red">Sa</div><div class="cal-header text-red">So</div><div class="cal-header" style="font-size: 0.7rem">KW</div>
                                <div v-for="n in paddingDays" :key="'pad-'+n"></div>
                                <template v-for="item in items" :key="item ? item.date : 'cal-unk'">
                                    <div v-if="item && item.row_type === 'day'" class="cal-cell"
                                         :class="{'is-holiday': item.is_holiday, 'is-weekend': isWeekend(item), 'is-today': isToday(item.date), 'is-short-day': item.is_short_day, 'is-off-day': item.is_off_day, 
                                                  'status-home': item.main_type === 'home', 'status-office': item.main_type === 'office', 'status-planned': item.main_type === 'planned', 'status-sick': item.main_type === 'sick', 'status-vacation': item.main_type === 'vacation', 'status-dr': item.main_type === 'dr'}"
                                         @click="openEditDialog(item)">
                                        <div class="d-flex justify-space-between align-start">
                                            <span class="cal-date mono-num" :class="{'opacity-50': item.is_off_day, 'text-primary': isToday(item.date)}">
                                                [[ item.day_num ]]
                                                <v-icon v-if="item.glz_override !== null" size="x-small" color="blue-grey" class="ml-1 opacity-80" title="PDF / Manueller GLZ Saldo">mdi-file-pdf-box</v-icon>
                                            </span>
                                        </div>
                                        <div v-if="item.is_holiday" class="cal-holiday-name text-truncate" :title="item.holiday_name">[[ item.holiday_name ]]</div>
                                        <div class="cal-content">
                                            <div v-if="item.main_type" class="font-weight-bold text-caption text-uppercase" :style="{color: getStatusIconColor(item.main_type)}">
                                                <v-icon size="x-small" class="mr-1">[[ getStatusIcon(item.main_type) ]]</v-icon>[[ getTypeName(item.main_type) ]]
                                            </div>
                                            <div v-if="item.total_net > 0 || item.main_type === 'planned'" class="text-caption font-weight-bold mono-num mt-1">[[ formatNum(item.total_net) ]] <span class="opacity-50 font-weight-regular">h</span></div>
                                        </div>
                                    </div>
                                    <div v-else-if="item && item.row_type === 'summary'" class="cal-week-sum mono-num" :title="'KW ' + item.iso_week"><span :class="getWeeklyColor(item.sum, item.target)" class="font-weight-bold">[[ formatNum(item.sum) ]]</span></div>
                                </template>
                            </div>
                        </div>

                        <div v-if="viewMode === 'year'" class="pa-4">
                            <v-row class="mb-4">
                                <v-col cols="12" md="4">
                                    <div class="dash-card h-100 d-flex flex-column align-center justify-center py-4">
                                        <div class="stat-label mb-3">Verteilung der Tage</div>
                                        <div style="height: 180px; width: 100%; position: relative;">
                                            <canvas id="donutChart"></canvas>
                                        </div>
                                    </div>
                                </v-col>
                                <v-col cols="12" md="8">
                                    <div class="dash-card h-100 d-flex flex-column align-center justify-center py-4">
                                        <div class="stat-label mb-3">Home Office Verlauf</div>
                                        <div style="height: 180px; width: 100%; position: relative;">
                                            <canvas id="barChart"></canvas>
                                        </div>
                                    </div>
                                </v-col>
                            </v-row>

                            <v-table density="comfortable">
                                <template v-slot:default>
                                    <thead><tr style="background-color: rgba(128,128,128,0.05);"><th class="text-left font-weight-bold text-uppercase opacity-70">Monat</th><th class="text-center font-weight-bold text-uppercase opacity-70">Home Office</th><th class="text-center font-weight-bold text-uppercase opacity-70">Büro</th><th class="text-center font-weight-bold text-uppercase opacity-70">Urlaub</th><th class="text-center font-weight-bold text-uppercase opacity-70">Budget Nutzung</th></tr></thead>
                                    <tbody>
                                        <tr v-for="stat in yearData" :key="stat.month">
                                            <td class="font-weight-bold">[[ getGermanMonthName(stat.month) ]]</td>
                                            <td class="text-center"><v-chip size="small" color="green" variant="tonal" v-if="stat.days_ho > 0" class="font-weight-bold mono-num">[[ stat.days_ho ]] T.</v-chip><span v-else class="opacity-30">-</span></td>
                                            <td class="text-center"><v-chip size="small" color="amber-darken-2" variant="tonal" v-if="stat.days_office > 0" class="font-weight-bold mono-num">[[ stat.days_office ]] T.</v-chip><span v-else class="opacity-30">-</span></td>
                                            <td class="text-center"><v-chip size="small" color="purple" variant="tonal" v-if="stat.days_vacation > 0" class="font-weight-bold mono-num">[[ stat.days_vacation ]] T.</v-chip><span v-else class="opacity-30">-</span></td>
                                            <td class="text-center">
                                                <div class="d-flex align-center justify-center">
                                                    <div style="width: 100px" class="mr-3"><v-progress-linear :model-value="stat.ho_hours_allowed ? (stat.ho_hours_made / stat.ho_hours_allowed)*100 : 0" color="blue" height="6" rounded bg-opacity="0.2"></v-progress-linear></div>
                                                    <div class="d-flex align-center text-body-2 mono-num opacity-80" style="width: 145px;">
                                                        <div class="text-right" style="width: 50px;">[[ formatNum(stat.ho_hours_made) ]]</div>
                                                        <div class="text-center mx-1" style="width: 10px;">/</div>
                                                        <div class="text-right" style="width: 55px;">[[ formatNum(stat.ho_hours_allowed) ]]</div>
                                                        <div class="ml-1 text-left" style="width: 15px;">h</div>
                                                    </div>
                                                </div>
                                            </td>
                                        </tr>
                                    </tbody>
                                    <tfoot class="bg-surface-variant font-weight-bold">
                                        <tr>
                                            <td class="text-left py-4 text-h6">GESAMT</td>
                                            <td class="text-center"><v-chip color="green" variant="elevated" class="font-weight-bold mono-num">[[ yearTotalHo ]] T.</v-chip></td>
                                            <td class="text-center"><v-chip color="amber-darken-2" variant="elevated" class="font-weight-bold mono-num">[[ yearTotalOffice ]] T.</v-chip></td>
                                            <td class="text-center"><v-chip color="purple" variant="elevated" class="font-weight-bold mono-num">[[ yearTotalVacation ]] T.</v-chip></td>
                                            <td class="text-center"></td>
                                        </tr>
                                    </tfoot>
                                </template>
                            </v-table>
                        </div>
                    </div>
                </v-fade-transition>
            </v-card>
        </v-container>
      </v-main>

      <v-dialog v-model="dialogEditDay" max-width="500">
        <v-card v-if="editingDay" rounded="lg">
            <v-card-title class="bg-primary text-white d-flex justify-space-between align-center py-3">
                <div class="d-flex align-center"><v-icon start>mdi-calendar-edit</v-icon><span class="font-weight-bold">[[ editingDay.day_num ]]. [[ currentMonthName ]] [[ currentYear ]]</span></div>
                <v-chip size="small" variant="flat" color="rgba(255,255,255,0.2)" class="text-uppercase font-weight-bold">[[ getGermanDay(editingDay.weekday_index) ]]</v-chip>
            </v-card-title>
            
            <v-card-text class="pt-5 pb-2 px-4">
                <div class="d-flex justify-center mb-5" style="gap: 8px; flex-wrap: wrap;">
                    <v-btn v-for="t in ['home', 'office', 'planned', 'sick', 'vacation']" :key="t" size="small" variant="tonal" rounded="xl"
                           :color="editingDay.entries[0] && editingDay.entries[0].type === t ? getStatusIconColor(t) : 'grey-darken-1'"
                           @click="setPrimaryType(editingDay, t)">
                           <v-icon start size="small">[[ getStatusIcon(t) ]]</v-icon>[[ getTypeName(t) ]]
                    </v-btn>
                </div>
                
                <v-divider class="mb-4 opacity-20"></v-divider>

                <div class="timeline-wrap">
                    <div class="timeline-node" v-for="(entry, index) in editingDay.entries" :key="index">
                        <v-card variant="outlined" class="pa-3" :style="{'border-left': '4px solid ' + getStatusIconColor(entry.type), 'border-color': 'rgba(128,128,128,0.2)'}">
                            <div class="d-flex justify-space-between align-start mb-2">
                                <v-select v-model="entry.type" :items="types" item-title="title" item-value="value" variant="plain" density="compact" hide-details class="font-weight-bold text-subtitle-1 pt-0 mt-0" style="max-width: 220px;" :color="getStatusIconColor(entry.type)" @update:model-value="saveSingleEntry(editingDay.date)"></v-select>
                                <v-btn v-if="index > 0" icon="mdi-delete" size="small" variant="text" color="grey" @click="deleteEntry(editingDay, index)"></v-btn>
                            </div>
                            
                            <v-row dense>
                                <v-col cols="6"><v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.start" label="Startzeit" variant="underlined" density="compact" hide-details class="mono-num" prepend-inner-icon="mdi-clock-start" :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(editingDay.date)"></v-text-field></v-col>
                                <v-col cols="6"><v-text-field v-if="needsTimeInput(entry.type)" v-model="entry.end" label="Endzeit" variant="underlined" density="compact" hide-details class="mono-num" prepend-inner-icon="mdi-clock-end" :type="$vuetify.display.mobile ? 'time' : 'text'" @change="saveSingleEntry(editingDay.date)"></v-text-field></v-col>
                                <v-col cols="12" class="mt-2"><v-text-field v-model="entry.comment" label="Notiz / Projekt" variant="underlined" density="compact" hide-details prepend-inner-icon="mdi-text" @change="saveSingleEntry(editingDay.date)"></v-text-field></v-col>
                            </v-row>
                        </v-card>
                    </div>
                    
                    <div class="timeline-node timeline-add">
                        <v-btn variant="text" size="small" color="primary" @click="addEntryToDay(editingDay)" class="font-weight-bold"><v-icon start>mdi-plus-circle</v-icon> Weiteren Split hinzufügen</v-btn>
                    </div>
                </div>
                
                <v-divider class="my-5 opacity-20"></v-divider>
                
                <div class="pa-3 rounded-lg border" style="background-color: rgba(255,255,255,0.02); border-color: rgba(255,255,255,0.1) !important;">
                    <div class="d-flex justify-space-between align-center mb-2">
                        <div class="text-caption font-weight-bold text-uppercase letter-spacing-1"><v-icon size="small" color="blue-grey" class="mr-1">mdi-file-pdf-box</v-icon>Offizieller PDF Saldo</div>
                        <div class="text-caption opacity-70">Stand: <strong class="mono-num text-body-2">[[ formatNum(editingDay.glz_saldo) ]] h</strong></div>
                    </div>
                    <v-text-field 
                        v-if="editingDay.entries && editingDay.entries.length > 0"
                        v-model.number="editingDay.entries[0].glz_override" 
                        label="Gleitzeit Saldo" 
                        placeholder="z.B. 12.5" 
                        variant="outlined" density="compact" hide-details bg-color="transparent" class="mono-num" type="number" step="0.01" 
                        @change="saveSingleEntry(editingDay.date)">
                    </v-text-field>
                </div>
            </v-card-text>
            <v-card-actions class="px-5 pb-5"><v-spacer></v-spacer><v-btn variant="flat" color="primary" size="large" class="px-6" @click="dialogEditDay = false">Schließen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialogSettings" max-width="700">
        <v-card rounded="lg">
          <v-card-title class="bg-primary text-white"><v-icon start>mdi-cog</v-icon> Einstellungen</v-card-title>
          <v-card-text class="pt-4">
            <v-row>
              <v-col cols="12"><h3 class="text-subtitle-1 font-weight-bold mb-2">Allgemein</h3></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.weekly_hours" label="Wochenstunden (Vertrag)" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.ho_quota_percent" label="HO Quote %" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              
              <v-col cols="12" class="mt-0 pt-0">
                  <div class="text-caption mb-2 font-weight-bold">Reguläre Arbeitstage</div>
                  <div class="d-flex justify-space-between" style="max-width: 400px">
                      <v-checkbox v-model="settings.active_weekdays" :value="0" label="Mo" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="1" label="Di" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="2" label="Mi" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="3" label="Do" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="4" label="Fr" density="compact" hide-details></v-checkbox>
                  </div>
                  
                  <v-divider class="my-3 opacity-20"></v-divider>
                  
                  <div class="text-caption mb-2 font-weight-bold">Ansicht</div>
                  <v-switch v-model="settings.hide_weekends" label="Wochenenden in Liste/Kalender ausblenden" color="primary" density="compact" hide-details></v-switch>

                  <v-divider class="my-3 opacity-20"></v-divider>
                  
                  <h3 class="text-subtitle-1 font-weight-bold mb-2">Automatisierung</h3>
                  <v-row align="center">
                      <v-col cols="6">
                        <v-text-field v-model="settings.default_start_time" label="Standard Startzeit" type="time" density="compact" variant="outlined" hide-details></v-text-field>
                      </v-col>
                      <v-col cols="6">
                          <v-switch v-model="settings.auto_convert_planned" label="Planung auto-umwandeln" color="primary" density="compact" hide-details></v-switch>
                          <div class="text-caption text-grey">Wandelt 'Geplant' vergangener Tage automatisch in 'Home Office' um.</div>
                      </v-col>
                  </v-row>
              </v-col>
            </v-row>
            
            <v-divider class="my-4 opacity-20"></v-divider>
            
            <div class="d-flex justify-space-between align-center mb-2">
                <h3 class="text-subtitle-1 font-weight-bold">Eigene Feiertage</h3>
                <v-btn size="small" variant="tonal" color="primary" @click="addWaeldchestag"><v-icon start>mdi-calendar-plus</v-icon> Wäldchestag</v-btn>
            </div>
            
            <div class="bg-surface-variant rounded mb-2 border" style="border-color: rgba(255,255,255,0.05) !important;">
                <div v-for="(h, dateKey) in customHolidays" :key="dateKey" class="d-flex align-center py-2 px-3" style="border-bottom: 1px solid rgba(255,255,255,0.05);">
                    <div style="width: 95px;" class="text-caption mono-num opacity-80">[[ h.date ]]</div>
                    <div class="text-caption font-weight-bold flex-grow-1 text-truncate">[[ h.name ]] <span v-if="h.hours > 0" class="text-grey ml-1 font-weight-regular">([[ h.hours ]]h)</span></div>
                    <div class="d-flex" style="gap: 12px;">
                        <v-icon size="small" color="primary" class="cursor-pointer" @click="editCustomHoliday(h, dateKey)" title="Bearbeiten">mdi-pencil</v-icon>
                        <v-icon size="small" color="error" class="cursor-pointer" @click="deleteCustomHoliday(dateKey)" title="Löschen">mdi-delete</v-icon>
                    </div>
                </div>
                <div v-if="!customHolidays || Object.keys(customHolidays).length === 0" class="text-caption text-grey pa-3 text-center">Keine eigenen Feiertage angelegt.</div>
            </div>
            
            <div class="d-flex mt-2 align-center pa-2 rounded border" style="border-color: rgba(255,255,255,0.05) !important; background: rgba(255,255,255,0.02);">
                <v-text-field v-model="newCustomHoliday.date" type="date" density="compact" variant="outlined" bg-color="transparent" hide-details class="mr-2" style="flex: 0 0 155px;"></v-text-field>
                <v-text-field v-model="newCustomHoliday.name" label="Bez." density="compact" variant="outlined" bg-color="transparent" hide-details class="mr-2"></v-text-field>
                <v-text-field v-model="newCustomHoliday.hours" label="Std." type="number" density="compact" variant="outlined" bg-color="transparent" hide-details class="mr-2" style="max-width: 80px;"></v-text-field>
                <v-btn icon="mdi-content-save" size="small" color="primary" elevation="0" @click="addCustomHoliday"></v-btn>
            </div>

          </v-card-text>
          <v-card-actions class="px-4 pb-4"><v-spacer></v-spacer><v-btn variant="flat" color="primary" @click="saveSettings">Speichern & Schließen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>
    </v-app>
  </div>

  <script>
    let activeCharts = { donut: null, bar: null };

    const { createApp } = Vue
    const { createVuetify } = Vuetify
    const vuetify = createVuetify({ theme: { defaultTheme: 'dark' } })

    const IDB_NAME = 'bbk_tracker_db';
    const IDB_STORE = 'handles';
    async function idbSet(key, val) { return new Promise((resolve, reject) => { const req = indexedDB.open(IDB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE); req.onsuccess = e => { const db = e.target.result; const tx = db.transaction(IDB_STORE, 'readwrite'); tx.objectStore(IDB_STORE).put(val, key); tx.oncomplete = () => resolve(); }; }); }
    async function idbGet(key) { return new Promise((resolve, reject) => { const req = indexedDB.open(IDB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE); req.onsuccess = e => { const db = e.target.result; const tx = db.transaction(IDB_STORE, 'readonly'); const getReq = tx.objectStore(IDB_STORE).get(key); getReq.onsuccess = () => resolve(getReq.result); }; }); }

    // --- DATA STORE ---
    const Store = {
        data: { settings:{}, entries:{}, customHolidays:{} },
        init() {
            const ls = localStorage.getItem('bbk_data');
            if(ls) try { this.data = JSON.parse(ls); } catch(e){}
            if(!this.data.settings) this.data.settings = {};
            if(!this.data.entries) this.data.entries = {};
            if(!this.data.customHolidays) this.data.customHolidays = {};
            
            let migrated = false;
            for(const date in this.data.entries) {
                if(!Array.isArray(this.data.entries[date])) {
                    this.data.entries[date] = [this.data.entries[date]];
                    migrated = true;
                }
                this.data.entries[date].forEach(e => {
                    if(e.type === 'x') { e.type = 'planned'; migrated = true; }
                });
            }
            if(migrated) this.persist();
        },
        get() { return this.data; },
        set(newData) { this.data = newData; this.init(); localStorage.setItem('bbk_data', JSON.stringify(this.data)); },
        getSettings() { 
            return { 
                weekly_hours: 39, active_weekdays: [0,1,2,3,4], ho_quota_percent: 60, hide_weekends: false,
                default_start_time: '08:00', auto_convert_planned: true, ...this.data.settings 
            }; 
        },
        saveSettings(s) { this.data.settings = s; this.persist(); },
        getEntries() { return this.data.entries || {}; },
        saveDayEntries(date, entriesArray) { 
             if(entriesArray.length > 0) {
                 const clean = entriesArray.filter(e => (e.type && e.type !== '') || (e.comment && e.comment.trim() !== '') || (e.glz_override !== undefined && e.glz_override !== null));
                 if(clean.length === 0) delete this.data.entries[date];
                 else this.data.entries[date] = clean;
             } else {
                 delete this.data.entries[date];
             }
             this.persist(); 
        },
        getCustomHolidays() { return this.data.customHolidays || {}; },
        saveCustomHolidays(mapObj) { this.data.customHolidays = mapObj; this.persist(); },
        onPersist: null,
        persist() { localStorage.setItem('bbk_data', JSON.stringify(this.data)); if(this.onPersist) this.onPersist(); }
    };
    Store.init();

    // --- LOGIC PORT ---
    function normalizeTimeInput(t) {
        if(!t) return ""; t = t.toString().trim().replace('.', ':');
        let h=0, m=0;
        if (t.includes(':')) { const p = t.split(':'); h = parseInt(p[0]); m = parseInt(p[1]); } 
        else if (t.length === 4 && !isNaN(t)) { h = parseInt(t.substring(0, 2)); m = parseInt(t.substring(2, 4)); } 
        else if (t.length === 3 && !isNaN(t)) { h = parseInt(t.substring(0, 1)); m = parseInt(t.substring(1, 3)); } 
        else if (t.length <= 2 && !isNaN(t)) { h = parseInt(t); m = 0; } else { return null; }
        if(isNaN(h)) h = 0; if(isNaN(m)) m = 0; 
        if(h > 23 || m > 59) return null;
        return `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
    }

    function calculateNetHours(start, end) {
        if(!start || !end) return 0.0;
        const s = normalizeTimeInput(start), e = normalizeTimeInput(end);
        if(!s || !e) return 0.0;
        const [sh, sm] = s.split(':').map(Number); const [eh, em] = e.split(':').map(Number);
        let startMin = sh*60 + sm; let endMin = eh*60 + em;
        if (endMin < startMin) endMin += 24*60;
        
        const grossHours = (endMin - startMin) / 60.0;
        let net = grossHours;
        
        if (grossHours <= 6.0) net = grossHours;
        else if (grossHours <= 6.5) net = 6.0;
        else if (grossHours <= 9.5) net = grossHours - 0.5;
        else if (grossHours <= 9.75) net = 9.0;
        else net = grossHours - 0.75;

        return Math.max(0.0, parseFloat(net.toFixed(2)));
    }
    
    function calculateGrossTimeNeeded(targetNet) {
        if (targetNet <= 6.0) return targetNet;
        else if (targetNet <= 9.0) return targetNet + 0.5; 
        else return targetNet + 0.75; 
    }
    
    function calculateTotalDailyNet(entries, infoTarget = 0) {
        let sum = 0.0;
        entries.forEach(e => {
            if(e.type === 'planned') {
                 if (e.start && e.end) sum += calculateNetHours(e.start, e.end);
                 else sum += infoTarget;
            }
            else if(['home','office','dr'].includes(e.type) && e.start && e.end) {
                 sum += calculateNetHours(e.start, e.end);
            }
        });
        return parseFloat(sum.toFixed(2));
    }
    
    function getHolidayName(dateObj, customHolidays) {
        const ymd = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
        if(customHolidays[ymd]) return customHolidays[ymd].name;
        
        const d = dateObj.getDate(), m = dateObj.getMonth() + 1, y = dateObj.getFullYear();
        if(m===12 && d===24) return "Heiligabend"; if(m===12 && d===31) return "Silvester"; if(m===1 && d===1) return "Neujahr"; if(m===5 && d===1) return "Tag der Arbeit"; if(m===10 && d===3) return "Tag der Deutschen Einheit"; if(m===12 && d===25) return "1. Weihnachtstag"; if(m===12 && d===26) return "2. Weihnachtstag";
        
        const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451);
        const monthE = Math.floor((h+l-7*m_easter+114)/31), dayE = ((h+l-7*m_easter+114)%31)+1; const easterDate = new Date(y, monthE-1, dayE);
        const addDays = (base, days) => { const n = new Date(base); n.setDate(n.getDate() + days); return n; }; 
        const isSame = (d1, d2) => d1.getDate()===d2.getDate() && d1.getMonth()===d2.getMonth();
        if(isSame(dateObj, addDays(easterDate, -2))) return "Karfreitag"; if(isSame(dateObj, addDays(easterDate, 1))) return "Ostermontag"; if(isSame(dateObj, addDays(easterDate, 39))) return "Christi Himmelfahrt"; if(isSame(dateObj, addDays(easterDate, 50))) return "Pfingstmontag"; if(isSame(dateObj, addDays(easterDate, 60))) return "Fronleichnam"; 
        return "";
    }
    
    function getISOWeek(d) { const date = new Date(d.getTime()); date.setHours(0, 0, 0, 0); date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7); const week1 = new Date(date.getFullYear(), 0, 4); return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7); }

    // --- VUE APP ---
    const app = createApp({
      data() {
        return {
          drawer: true,
          viewMode: 'list', currentDate: new Date(), items: [], yearData: [],
          stats: { total_ho_made: 0, total_ho_allowed: 1, total_office_made: 0, total_work_made: 0, avg_per_week: 0, workdays_month: 0, current_glz: 0 }, 
          settings: { weekly_hours: 39, active_weekdays: [0,1,2,3,4], ho_quota_percent: 60, hide_weekends: false, default_start_time: '08:00', auto_convert_planned: true },
          dialogSettings: false, dialogEditDay: false, editingDay: null, 
          importDialog: { show: false, overwrite: false, file: null },
          seriesDialog: { show: false, start: '', end: '', weekdays: [4], type: 'planned', overwrite: false },
          customHolidays: {}, newCustomHoliday: { _oldDate: null, date: '', name: '', hours: 0 },
          fileHandle: null, fileName: '', storedHandleName: '', unsavedChanges: false, snackbar: { show: false, text: '', color: 'success' },
          types: [{ title: 'Home Office', value: 'home' }, { title: 'Büro', value: 'office' }, { title: 'Home Office ⏳', value: 'planned' }, { title: 'Krank', value: 'sick' }, { title: 'Urlaub', value: 'vacation' }, { title: 'Gleitzeit', value: 'glz' }, { title: 'Dienstreise', value: 'dr' }, { title: 'Leer', value: '' }]
        }
      },
      computed: {
        currentYear() { return this.currentDate.getFullYear() },
        currentMonth() { return this.currentDate.getMonth() + 1 }, 
        currentMonthName() { return this.currentDate.toLocaleString('de-DE', { month: 'long' }) },
        quotaPercentage() { if(!this.stats.total_ho_allowed) return 0; return (this.stats.total_ho_made / this.stats.total_ho_allowed) * 100; },
        getQuotaColor() { return this.quotaPercentage > 100 ? 'red' : (this.quotaPercentage > 85 ? 'orange' : '#4CAF50'); },
        paddingDays() { if(!this.items || this.items.length === 0) return 0; const firstDay = this.items.find(i => i.row_type === 'day'); return firstDay ? firstDay.weekday_index : 0; },
        theme() { return this.$vuetify.theme },
        calcDailyTarget() { const activeCount = this.settings.active_weekdays ? this.settings.active_weekdays.length : 5; if (activeCount === 0) return 0; return this.settings.weekly_hours / activeCount; },
        budgetRemainingHours() { return this.stats.total_ho_allowed - this.stats.total_ho_made; },
        budgetRemainingDays() { const daily = this.calcDailyTarget || 7.8; if(daily === 0) return 0; return this.budgetRemainingHours / daily; },
        budgetStateColor() { return this.budgetRemainingHours >= 0 ? 'text-green' : 'text-red-accent-2'; },
        
        yearTotalHo() { return this.yearData.reduce((sum, item) => sum + item.days_ho, 0); },
        yearTotalOffice() { return this.yearData.reduce((sum, item) => sum + item.days_office, 0); },
        yearTotalVacation() { return this.yearData.reduce((sum, item) => sum + item.days_vacation, 0); },
        yearTotalHoHours() { return this.yearData.reduce((sum, item) => sum + item.ho_hours_made, 0); },
        yearTotalAllowed() { return this.yearData.reduce((sum, item) => sum + item.ho_hours_allowed, 0); }
      },
      watch: { 
          viewMode(newVal) { 
              if(newVal === 'year') {
                  this.loadYearData(); 
              } else {
                  this.destroyCharts();
                  this.loadMonthData(); 
              }
          } 
      },
      mounted() { 
          if(window.innerWidth < 1200) this.drawer = false;
          Store.onPersist = () => { if(this.viewMode==='year') this.loadYearData(); else this.loadMonthData(); if(this.fileHandle) this.saveToFile(); else this.unsavedChanges = true; };
          this.loadData();
          this.checkForStoredHandle();
          
          window.addEventListener('keydown', (e) => {
              if(e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
              if(this.dialogEditDay || this.dialogSettings || this.importDialog.show || this.seriesDialog.show) return;
              if(this.viewMode === 'year') {
                  if(e.key === 'ArrowLeft') this.changeYear(-1);
                  if(e.key === 'ArrowRight') this.changeYear(1);
              } else {
                  if(e.key === 'ArrowLeft') this.changeMonth(-1);
                  if(e.key === 'ArrowRight') this.changeMonth(1);
              }
          });
      },
      methods: {
        goHome() { window.location.reload(); },
        toggleTheme() { this.theme.global.name = this.theme.global.current.dark ? 'light' : 'dark'; },
        formatNum(val) { return val || val === 0 ? val.toFixed(2).replace('.', ',') : '0,00'; },
        formatOneDecimal(val) { return val || val === 0 ? val.toFixed(1).replace('.', ',') : '0,0'; },
        showMsg(text, color='success') { this.snackbar.text = text; this.snackbar.color = color; this.snackbar.show = true; },
        
        triggerPdfImport() { this.$refs.pdfInput.click(); },
        onPdfFileChange(event) { const file = event.target.files[0]; if (!file) return; this.importDialog.file = file; this.importDialog.show = true; event.target.value = ''; },
        async processPdfImport() {
            this.importDialog.show = false;
            const file = this.importDialog.file; if (!file) return;
            try {
                this.showMsg("Lese PDF...", "info");
                const arrayBuffer = await file.arrayBuffer();
                const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
                let cnt = 0;
                
                const germanMonths = {'Januar':1,'Februar':2,'März':3,'April':4,'Mai':5,'Juni':6,'Juli':7,'August':8,'September':9,'Oktober':10,'November':11,'Dezember':12};
                const TYPE_MAP = { 
                    "Mobil": "home", "Telearb.": "home", "Telearb": "home", 
                    "anwesend": "office", 
                    "Krank": "sick", 
                    "Urlaub": "vacation", "Erholungs": "vacation", "Zusatz": "vacation", "Sonder": "vacation",
                    "Gleitzeit": "glz", "GLZ": "glz",
                    "Dienstreise": "dr", "Reise": "dr", "Fortbildung": "dr",
                    "BUCHUNG FEHLT": "missing"
                };

                const page1 = await pdf.getPage(1);
                const txt1 = (await page1.getTextContent()).items.map(i=>i.str).join(' ');
                const mMatch = txt1.match(/Monat:?\s*([a-zA-ZäöüÄÖÜ]+)\s*[-_]?\s*(\d{4})/);
                if(!mMatch) { this.showMsg("Monat nicht gefunden", "error"); return; }
                const month = germanMonths[mMatch[1]], year = parseInt(mMatch[2]);
                
                const dailyData = {};
                
                for(let i=1; i<=pdf.numPages; i++){
                    const page = await pdf.getPage(i);
                    const items = (await page.getTextContent()).items;
                    
                    items.sort((a,b) => {
                        const yDiff = b.transform[5] - a.transform[5];
                        return Math.abs(yDiff) < 5 ? (a.transform[4] - b.transform[4]) : yDiff;
                    });
                    
                    const fullText = items.map(item => item.str).join(" ");
                    const datePattern = /(\d{2})\s+(MO|DI|MI|DO|FR|SA|SO)/g;
                    let match;
                    let lastIndex = 0;
                    let lastDay = null;

                    while ((match = datePattern.exec(fullText)) !== null) {
                        if (lastDay !== null) {
                            const segment = fullText.substring(lastIndex, match.index);
                            processDaySegment(lastDay, segment, dailyData, TYPE_MAP);
                        }
                        lastDay = parseInt(match[1]);
                        lastIndex = match.index;
                    }
                    if (lastDay !== null) {
                         const segment = fullText.substring(lastIndex);
                         processDaySegment(lastDay, segment, dailyData, TYPE_MAP);
                    }
                }
                
                function processDaySegment(day, text, dataStore, map) {
                    let cleanText = text;
                    const wIndex = cleanText.indexOf("Wochensumme");
                    if (wIndex !== -1) cleanText = cleanText.substring(0, wIndex);
                    const zIndex = cleanText.indexOf("Zeitkonto");
                    if (zIndex !== -1) cleanText = cleanText.substring(0, zIndex);
                    const kIndex = cleanText.indexOf("Kontingent");
                    if (kIndex !== -1) cleanText = cleanText.substring(0, kIndex);
                    
                    if (cleanText.trim().startsWith("Tag ")) return;
                    
                    if(!dataStore[day]) dataStore[day] = [];
                    
                    let glz_saldo_val = null;
                    const floats = [...cleanText.matchAll(/-?\d{1,3}[.,]\d{2}/g)].map(m => m[0]);
                    if (floats.length > 0) {
                        glz_saldo_val = parseFloat(floats[floats.length - 1].replace(',', '.'));
                    }

                    if(cleanText.includes("BUCHUNG FEHLT")) {
                        dataStore[day].push({ type: '', start: '', end: '', comment: 'Buchung fehlt (PDF)', glz_override: glz_saldo_val });
                        return;
                    }

                    let foundType = null;
                    for(const [k,v] of Object.entries(map)) { 
                        if(cleanText.includes(k) && v !== 'missing') foundType = v; 
                    }
                    
                    const times = [...cleanText.matchAll(/(\d{2}:\d{2})/g)].map(m=>m[1]);
                    const validTimes = times.filter(t => t !== "00:00");
                    
                    let entryAdded = false;
                    if (foundType) {
                        let isDuplicate = false;
                        if (validTimes.length === 0) {
                             for(let e of dataStore[day]) {
                                  if (e.type === foundType && !e.start) {
                                      isDuplicate = true;
                                      if (glz_saldo_val !== null) e.glz_override = glz_saldo_val;
                                  }
                             }
                        }
                        if (!isDuplicate || validTimes.length >= 2) {
                            const start = validTimes.length >= 2 ? validTimes[0] : "";
                            const end = validTimes.length >= 2 ? validTimes[1] : "";
                            dataStore[day].push({ type: foundType, start, end, glz_override: glz_saldo_val });
                            entryAdded = true;
                        }
                    } else if (validTimes.length >= 2 && !cleanText.includes("Soll")) {
                        dataStore[day].push({ type: 'office', start: validTimes[0], end: validTimes[1], glz_override: glz_saldo_val });
                        entryAdded = true;
                    }
                    
                    if (!entryAdded && glz_saldo_val !== null) {
                        if (dataStore[day].length > 0) {
                            dataStore[day][dataStore[day].length - 1].glz_override = glz_saldo_val;
                        } else {
                            dataStore[day].push({ type: '', start: '', end: '', glz_override: glz_saldo_val });
                        }
                    }
                }
                
                const daysInMonth = new Date(year, month, 0).getDate();
                for(const [d, blocks] of Object.entries(dailyData)) {
                     const dateIso = `${year}-${String(month).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                     const dateObj = new Date(year, month-1, d);
                     const info = this.getDayInfo(dateObj);
                     
                     const cleanBlocks = blocks.filter(b => {
                         const hasTimes = b.start && b.end;
                         const hasComment = !!b.comment;
                         const hasOverride = b.glz_override !== null && b.glz_override !== undefined;
                         const isFreeDay = !info.is_workday;
                         
                         if (hasTimes || !isFreeDay || hasComment || hasOverride) return true;
                         return false;
                     });

                     if(this.importDialog.overwrite) Store.saveDayEntries(dateIso, []);
                     const existing = Store.getEntries()[dateIso] || [];
                     if(this.importDialog.overwrite || existing.length === 0) {
                         cleanBlocks.sort((a,b) => (a.start||"").localeCompare(b.start||""));
                         Store.saveDayEntries(dateIso, cleanBlocks);
                         if(cleanBlocks.length > 0) cnt++;
                     }
                }
                this.showMsg(`${cnt} Tage importiert.`);
                this.loadData();
            } catch(e) { console.error(e); this.showMsg("Import Fehler: " + e.message, "error"); }
        },

        getDayInfo(dateObj) {
            const ymd = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const cust = this.customHolidays[ymd];
            const activeDays = this.settings.active_weekdays || [];
            const dayIdx = (dateObj.getDay() + 6) % 7; 
            const is_active = activeDays.includes(dayIdx);
            
            let is_workday = false, target = 0.0, hName = "", is_short = false, is_off = false;
            
            if(cust) {
                hName = cust.name;
                if(cust.hours > 0) { is_workday = true; target = cust.hours; is_short = true; }
            } else {
                hName = getHolidayName(dateObj, this.customHolidays);
                if(!hName && is_active) {
                    is_workday = true;
                    target = activeDays.length > 0 ? (this.settings.weekly_hours / activeDays.length) : 0;
                }
                if(!is_active) is_off = true;
            }
            return { is_workday, target, holiday_name: hName, is_short_day: is_short, is_off_day: is_off };
        },

        getGlzCarryover(year, month) {
            const targetDateObj = new Date(year, month - 1, 0); 
            const targetDateStr = new Date(targetDateObj.getTime() - (targetDateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            const allEntries = Store.getEntries();
            const dates = Object.keys(allEntries).sort();
            
            let lastOverrideDate = null;
            let runningGlz = 0.0;
            
            for(let i=dates.length-1; i>=0; i--) {
                if (dates[i] <= targetDateStr) {
                    const overrideEntry = allEntries[dates[i]].find(e => e.glz_override != null);
                    if (overrideEntry) {
                        lastOverrideDate = dates[i];
                        runningGlz = overrideEntry.glz_override;
                        break;
                    }
                }
            }
            
            let startDate;
            if (lastOverrideDate) {
                startDate = new Date(lastOverrideDate);
                startDate.setDate(startDate.getDate() + 1);
            } else {
                runningGlz = 0.0;
                startDate = new Date(year, 0, 1);
            }
            
            if (startDate > targetDateObj) return runningGlz;
            
            const todayStr = new Date().toISOString().split('T')[0];
            let curr = new Date(startDate);
            
            while (curr <= targetDateObj) {
                const currStr = new Date(curr.getTime() - (curr.getTimezoneOffset()*60000)).toISOString().split('T')[0];
                const info = this.getDayInfo(curr);
                const dayEntries = allEntries[currStr] || [];
                
                let dayNet = calculateTotalDailyNet(dayEntries, info.target);
                let isPaidLeave = dayEntries.some(e => ['sick', 'vacation'].includes(e.type));
                let isGlzDay = dayEntries.some(e => e.type === 'glz');
                let isEmpty = dayEntries.length === 0 || dayEntries.every(e => !e.type);
                let isFuture = currStr > todayStr;
                
                let dayDelta = 0.0;
                if (info.is_workday) {
                    if (isPaidLeave) dayDelta = dayNet;
                    else if (isGlzDay) dayDelta = dayNet - info.target;
                    else if (isEmpty && isFuture) dayDelta = 0.0;
                    else dayDelta = dayNet - info.target;
                } else {
                    dayDelta = dayNet;
                }
                
                runningGlz += dayDelta;
                curr.setDate(curr.getDate() + 1);
            }
            return runningGlz;
        },

        autoConvertExpiredEntries() {
            if(!this.settings.auto_convert_planned) return;
            const today = new Date().toISOString().split('T')[0];
            const allEntries = Store.getEntries();
            let changed = false;
            
            for(const [date, entries] of Object.entries(allEntries)) {
                if(date < today) {
                    entries.forEach(e => {
                        if(e.type === 'planned') {
                            e.type = 'home';
                            if(!e.start) {
                                const info = this.getDayInfo(new Date(date));
                                if(info.target > 0) {
                                    e.start = this.settings.default_start_time || '08:00';
                                    let gross = calculateGrossTimeNeeded(info.target);
                                    let [h,m] = e.start.split(':').map(Number);
                                    let min = h*60+m + (gross*60);
                                    e.end = `${Math.floor(min/60).toString().padStart(2,'0')}:${Math.round(min%60).toString().padStart(2,'0')}`;
                                }
                            }
                            changed = true;
                        }
                    });
                    if(changed) Store.saveDayEntries(date, entries);
                }
            }
            if(changed && this.viewMode==='list') this.loadMonthData();
        },

        loadData() {
            this.settings = Store.getSettings();
            this.customHolidays = Store.getCustomHolidays();
            this.autoConvertExpiredEntries();
            if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData();
        },

        loadMonthData() {
            const allEntries = Store.getEntries();
            const year = this.currentYear, month = this.currentMonth;
            const daysInMonth = new Date(year, month, 0).getDate();
            const todayStr = new Date().toISOString().split('T')[0];
            
            let total_ho=0, total_office=0, workdays=0, current_week_sum=0;
            let total_target_hours_month = 0.0;
            
            let running_glz = this.getGlzCarryover(year, month);
            this.items = [];

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month-1, d);
                const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                const info = this.getDayInfo(dateObj);
                
                if (info.is_workday) { workdays++; total_target_hours_month += info.target; }

                const dayEntries = JSON.parse(JSON.stringify(allEntries[dateStr] || []));
                const dayNet = calculateTotalDailyNet(dayEntries, info.target);
                
                let dayHoPart = 0, dayOffPart = 0;
                let dayOverride = null;

                dayEntries.forEach(e => {
                    let h = 0;
                    if(e.type === 'planned') {
                        if(e.start && e.end) h = calculateNetHours(e.start, e.end);
                        else h = info.target;
                    } 
                    else if(['home','office','dr'].includes(e.type)) h = calculateNetHours(e.start, e.end);
                    
                    e.net = parseFloat(h.toFixed(2)); 
                    if(e.glz_override != null) dayOverride = e.glz_override;
                    
                    if(['home','planned'].includes(e.type)) dayHoPart += h;
                    else if(['office','dr'].includes(e.type)) dayOffPart += h;
                });
                
                if(dayHoPart + dayOffPart > 0) {
                    if(dayNet > 0) {
                        const ratio = dayNet / (dayHoPart + dayOffPart);
                        total_ho += dayHoPart * ratio; total_office += dayOffPart * ratio;
                    } else {
                        total_ho += dayHoPart;
                        total_office += dayOffPart;
                    }
                }

                current_week_sum += dayNet;
                
                let mainType = "";
                if(dayEntries.length > 0) {
                     if(dayOffPart > dayHoPart) mainType = "office";
                     else if(dayHoPart > 0) mainType = "home";
                     else if(dayEntries.some(e=>e.type==='planned')) mainType = "planned"; 
                     else mainType = dayEntries[0].type;
                }

                let dayDelta = 0.0;
                let isPaidLeave = dayEntries.some(e => ['sick', 'vacation'].includes(e.type));
                let isGlzDay = dayEntries.some(e => e.type === 'glz');
                let isEmpty = dayEntries.length === 0 || dayEntries.every(e => !e.type);
                let isFuture = dateStr > todayStr;
                
                if (info.is_workday) {
                    if (isPaidLeave) dayDelta = dayNet;
                    else if (isGlzDay) dayDelta = dayNet - info.target;
                    else if (isEmpty && isFuture) dayDelta = 0.0;
                    else dayDelta = dayNet - info.target;
                } else {
                    dayDelta = dayNet;
                }

                running_glz += dayDelta;
                if (dayOverride !== null) running_glz = dayOverride;

                if(dayEntries.length === 0) dayEntries.push({type:'', start:'', end:'', comment:'', glz_override: dayOverride});

                this.items.push({ 
                    row_type: 'day', date: dateStr, day_num: d, weekday_index: (dateObj.getDay()+6)%7, iso_week: getISOWeek(dateObj), 
                    is_holiday: (info.holiday_name && !info.is_workday), holiday_name: info.holiday_name, is_short_day: info.is_short_day, is_off_day: info.is_off_day,
                    daily_target: info.target, entries: dayEntries, total_net: dayNet, main_type: mainType, glz_saldo: running_glz, glz_override: dayOverride
                });
                
                if((dateObj.getDay()+6)%7 === 6 || d === daysInMonth) {
                    this.items.push({ row_type: 'summary', iso_week: getISOWeek(dateObj), sum: parseFloat(current_week_sum.toFixed(2)), target: this.settings.weekly_hours });
                    current_week_sum = 0;
                }
            }
            
            const max_ho = total_target_hours_month * (this.settings.ho_quota_percent / 100);
            this.stats = { total_ho_made: total_ho, total_ho_allowed: max_ho, total_office_made: total_office, total_work_made: total_ho+total_office, workdays_month: workdays, current_glz: running_glz };
        },
        
        loadYearData() {
            const allEntries = Store.getEntries();
            const year = this.currentYear;
            this.yearData = [];
            
            for(let m=1; m<=12; m++) {
                const daysInMonth = new Date(year, m, 0).getDate();
                let ho_h=0, off_h=0, wd=0, total_target_month=0.0;
                let days_ho=0, days_off=0, days_vac=0;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const dateObj = new Date(year, m-1, d);
                    const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                    const info = this.getDayInfo(dateObj);
                    if(info.is_workday) { wd++; total_target_month += info.target; }
                    
                    const entries = allEntries[dateStr] || [];
                    if(entries.length > 0) {
                        const dayNet = calculateTotalDailyNet(entries, info.target);
                        
                        let hasHo=false, hasOff=false, hasVac=false;
                        let rawHo=0, rawOff=0;

                        entries.forEach(e => {
                            if(['home','planned'].includes(e.type)) { hasHo=true; rawHo += (e.start && e.end) ? calculateNetHours(e.start, e.end) : info.target; }
                            if(['office','dr'].includes(e.type)) { hasOff=true; rawOff += calculateNetHours(e.start, e.end); }
                            if(e.type === 'vacation') {
                                if(info.is_workday) hasVac = true;
                            }
                        });
                        
                        if(hasHo) days_ho++; if(hasOff) days_off++; if(hasVac) days_vac++;
                        
                        if(rawHo+rawOff > 0) {
                            const ratio = dayNet / (rawHo+rawOff);
                            ho_h += rawHo * ratio; off_h += rawOff * ratio;
                        } else if (rawHo > 0) {
                            ho_h += rawHo;
                        }
                    }
                }
                this.yearData.push({ month: m, days_ho, days_office: days_off, days_vacation: days_vac, ho_hours_made: parseFloat(ho_h.toFixed(2)), ho_hours_allowed: parseFloat((total_target_month * (this.settings.ho_quota_percent/100)).toFixed(2)), office_hours_made: parseFloat(off_h.toFixed(2)) });
            }

            if (this.viewMode === 'year') {
                this.$nextTick(() => { this.renderCharts(); });
            }
        },

        destroyCharts() {
            if (activeCharts.donut) {
                activeCharts.donut.destroy();
                activeCharts.donut = null;
            }
            if (activeCharts.bar) {
                activeCharts.bar.destroy();
                activeCharts.bar = null;
            }
        },

        renderCharts() {
            if (!window.Chart) return;
            
            this.destroyCharts();

            const ctxDonut = document.getElementById('donutChart');
            const ctxBar = document.getElementById('barChart');
            if (!ctxDonut || !ctxBar) return;

            Chart.defaults.color = 'rgba(255, 255, 255, 0.7)';
            Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';

            activeCharts.donut = new Chart(ctxDonut, {
                type: 'doughnut',
                data: {
                    labels: ['Home Office', 'Büro', 'Urlaub'],
                    datasets: [{
                        data: [this.yearTotalHo, this.yearTotalOffice, this.yearTotalVacation],
                        backgroundColor: ['#4CAF50', '#FFC107', '#9C27B0'],
                        borderWidth: 0,
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    cutout: '65%',
                    layout: { padding: 10 },
                    plugins: { 
                        legend: { position: 'right', labels: { boxWidth: 12 } },
                        tooltip: { 
                            callbacks: {
                                label: function(context) {
                                    let val = context.parsed || 0;
                                    let dataset = context.chart.data.datasets[context.datasetIndex];
                                    let total = dataset.data.reduce((acc, current) => acc + current, 0);
                                    let percentage = total > 0 ? Math.round((val / total) * 100) : 0;
                                    return ` ${context.label}: ${val} Tage (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });

            activeCharts.bar = new Chart(ctxBar, {
                type: 'bar',
                data: {
                    labels: ['Jan', 'Feb', 'Mär', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
                    datasets: [{
                        label: 'HO Tage',
                        data: this.yearData.map(d => d.days_ho),
                        backgroundColor: '#4CAF50',
                        hoverBackgroundColor: '#66BB6A',
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: { 
                        legend: { display: false },
                        tooltip: { 
                            callbacks: {
                                label: function(context) {
                                    return ` ${context.parsed.y} Home Office Tage`;
                                }
                            }
                        }
                    },
                    scales: { 
                        y: { beginAtZero: true, suggestedMax: 20, ticks: { stepSize: 5 } },
                        x: { grid: { display: false } }
                    }
                }
            });
        },

        openEditDialog(day) { 
            this.editingDay = day; 
            if(!this.editingDay.entries || this.editingDay.entries.length === 0) { this.editingDay.entries = [{type: 'home', start: '', end: '', net: 0, comment: '', glz_override: null}]; } 
            this.dialogEditDay = true; 
        },
        quickSetStatus(day, type) { 
             if(type==='') { Store.saveDayEntries(day.date, []); this.loadMonthData(); return; }
             if(day.entries.length === 0 || day.entries[0].type === '') day.entries = [{type, start:'', end:'', comment:'', glz_override: day.glz_override}];
             else day.entries[0].type = type;
             this.onEntryChange(day, day.entries[0]);
        },
        setPrimaryType(day, type) { 
            if(day.entries.length === 0 || day.entries[0].type === '') day.entries = [{type, start:'', end:'', comment:'', glz_override: day.glz_override}];
            day.entries[0].type = type; 
            this.onEntryChange(day, day.entries[0]); 
        },
        addEntryToDay(day) { day.entries.push({type:'home', start:'', end:'', comment:''}); },
        deleteEntry(day, idx) { 
            day.entries.splice(idx, 1); 
            if(day.entries.length===0) day.entries.push({type:'', start:'', end:'', comment:'', glz_override: day.glz_override});
            this.saveSingleEntry(day.date); 
        },
        onEntryChange(day, entry) {
            if(['home', 'office', 'dr'].includes(entry.type) && !entry.start) {
                entry.start = this.settings.default_start_time || '08:00';
                if(day.entries.length === 1) {
                     const dailyTarget = this.calcDailyTarget;
                     let startMin = 480; try { let p = entry.start.split(':'); startMin = parseInt(p[0])*60 + parseInt(p[1]); } catch(e){}
                     let grossHours = calculateGrossTimeNeeded(dailyTarget);
                     const endMin = startMin + (grossHours * 60);
                     const h = Math.floor(endMin / 60); const m = Math.round(endMin % 60);
                     entry.end = `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
                }
             }
             this.saveSingleEntry(day.date);
        },
        saveEntry(day) { this.saveSingleEntry(day.date); },
        saveSingleEntry(date) {
             let dayObj = this.items.find(i=>i.date === date); if(this.editingDay && this.editingDay.date === date) dayObj = this.editingDay;
             if(dayObj) {
                 dayObj.entries.forEach(e => {
                     if(e.start) e.start = normalizeTimeInput(e.start) || e.start;
                     if(e.end) e.end = normalizeTimeInput(e.end) || e.end;
                     if(e.comment) e.comment = e.comment.trim();
                 });
                 Store.saveDayEntries(date, dayObj.entries);
                 if(this.viewMode==='list') this.loadMonthData();
             }
        },
        
        openSeriesDialog() { const nextM = new Date(); nextM.setMonth(nextM.getMonth() + 1); const y = nextM.getFullYear(), m = nextM.getMonth(); const lastDay = new Date(y, m + 1, 0).getDate(); this.seriesDialog.start = `${y}-${(m+1).toString().padStart(2,'0')}-01`; this.seriesDialog.end = `${y}-${(m+1).toString().padStart(2,'0')}-${lastDay}`; this.seriesDialog.show = true; },
        saveSeriesPlan() {
            this.seriesDialog.show = false;
            let curr = new Date(this.seriesDialog.start); const end = new Date(this.seriesDialog.end);
            let cnt = 0;
            while(curr <= end) {
                const dayIdx = (curr.getDay()+6)%7;
                if(this.seriesDialog.weekdays.includes(dayIdx)) {
                    const dStr = new Date(curr.getTime() - (curr.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                    const info = this.getDayInfo(curr);
                    if(info.holiday_name && !info.is_workday) { curr.setDate(curr.getDate()+1); continue; }
                    
                    const existing = Store.getEntries()[dStr] || [];
                    if(this.seriesDialog.overwrite || existing.length === 0) {
                        Store.saveDayEntries(dStr, [{type: this.seriesDialog.type, start:'', end:'', comment:''}]);
                        cnt++;
                    }
                }
                curr.setDate(curr.getDate()+1);
            }
            this.showMsg(`${cnt} Tage geplant.`);
            this.loadMonthData();
        },

        getGermanDay(index) { return ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][index] || ''; },
        getGermanMonthName(m) { if(!m) return ""; const d = new Date(); d.setMonth(m-1); return d.toLocaleString('de-DE', { month: 'long' }); },
        isWeekend(day) { return day.weekday_index >= 5; },
        isToday(dateStr) { return dateStr === new Date().toISOString().split('T')[0]; },
        needsTimeInput(type) { return ['home', 'office', 'dr', 'planned', '', null].includes(type); },
        getStatusIcon(type) { const map = { 'home': 'mdi-home', 'office': 'mdi-office-building', 'planned': 'mdi-calendar-clock', 'sick': 'mdi-emoticon-sick', 'vacation': 'mdi-beach', 'dr': 'mdi-car' }; return map[type] || 'mdi-help-circle-outline'; },
        getStatusIconColor(type) { const map = { 'home': '#4CAF50', 'office': '#FFC107', 'planned': '#2196F3', 'sick': '#F44336', 'vacation': '#9C27B0', 'dr': '#03A9F4' }; return map[type] || 'grey'; },
        getTypeName(val) { const found = this.types.find(t => t.value === val); return found ? found.title : ''; },
        getWeeklyColor(current, target) { if (!current) return 'text-grey'; return current >= target ? 'text-green' : 'text-orange-darken-2'; },

        changeMonth(delta) { this.currentDate = new Date(this.currentDate.setMonth(this.currentDate.getMonth() + delta)); this.loadMonthData(); },
        changeYear(delta) { this.currentDate = new Date(this.currentDate.setFullYear(this.currentDate.getFullYear() + delta)); if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        saveSettings() { Store.saveSettings(this.settings); Store.saveCustomHolidays(this.customHolidays); this.dialogSettings = false; if(this.viewMode==='year') this.loadYearData(); else this.loadMonthData(); },
        
        editCustomHoliday(h, originalDate) {
            this.newCustomHoliday = { _oldDate: originalDate, date: h.date, name: h.name, hours: h.hours };
        },
        addCustomHoliday() { 
            if(!this.newCustomHoliday.date || !this.newCustomHoliday.name) return; 
            
            if(this.newCustomHoliday._oldDate && this.newCustomHoliday._oldDate !== this.newCustomHoliday.date) {
                delete this.customHolidays[this.newCustomHoliday._oldDate];
            }
            
            this.customHolidays[this.newCustomHoliday.date] = { date: this.newCustomHoliday.date, name: this.newCustomHoliday.name, hours: parseFloat(this.newCustomHoliday.hours || 0)}; 
            this.newCustomHoliday = { _oldDate: null, date:'', name:'', hours:0}; 
            
            Store.saveCustomHolidays(this.customHolidays);
            if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData();
        },
        deleteCustomHoliday(dateKey) { 
            delete this.customHolidays[dateKey]; 
            Store.saveCustomHolidays(this.customHolidays);
            if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData();
        },
        
        addWaeldchestag() { 
            const y = this.currentYear; 
            const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451); 
            const monthE = Math.floor((h+l-7*m_easter+114)/31); const dayE = ((h+l-7*m_easter+114)%31)+1; 
            const easterDate = new Date(y, monthE - 1, dayE); 
            const waeldchestag = new Date(easterDate); waeldchestag.setDate(easterDate.getDate() + 51); 
            const dateStr = new Date(waeldchestag.getTime() - (waeldchestag.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; 
            
            this.newCustomHoliday.date = dateStr; 
            this.newCustomHoliday.name = 'Wäldchestag'; 
            this.newCustomHoliday.hours = 6.0; 
            this.showMsg("Wäldchestag in Eingabe geladen. Bitte prüfen und mit + hinzufügen.", "info"); 
        },
        
        async checkForStoredHandle() { try { const handle = await idbGet('fileHandle'); if(handle) { this.storedHandleName = handle.name; } } catch(e) { console.error(e); } },
        async restoreFileConnection() { try { const handle = await idbGet('fileHandle'); if(!handle) return; const opts = { mode: 'readwrite' }; if ((await handle.queryPermission(opts)) === 'granted' || (await handle.requestPermission(opts)) === 'granted') { this.fileHandle = handle; this.fileName = handle.name; await this.loadFileContent(); } } catch(e) { console.error("Restore failed", e); alert("Konnte Verbindung nicht wiederherstellen."); } },
        async openFile() { 
            try { 
                if (!window.showOpenFilePicker) { 
                    this.$refs.jsonInput.click();
                    return; 
                } 
                const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON', accept: {'application/json': ['.json']} }], multiple: false }); 
                this.fileHandle = handle; this.fileName = handle.name; await idbSet('fileHandle', handle); this.storedHandleName = handle.name; await this.loadFileContent(); 
            } catch(e) {} 
        },
        fallbackLoadJson(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = ev => {
                try {
                    const json = JSON.parse(ev.target.result);
                    Store.set(json);
                    this.loadData();
                    this.showMsg("Datei geladen", "success");
                } catch(err) {
                    this.showMsg("Ungültige JSON Datei", "error");
                }
            };
            reader.readAsText(file);
            event.target.value = '';
        },
        async loadFileContent() { const file = await this.fileHandle.getFile(); const text = await file.text(); try { const json = JSON.parse(text); Store.set(json); this.loadData(); } catch(e) { Store.init(); this.saveToFile(); } },
        async saveToFile() { 
            if (!window.showSaveFilePicker && !this.fileHandle) {
                const blob = new Blob([JSON.stringify(Store.get(), null, 2)], {type: 'application/json'});
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'ho_planer_backup.json';
                a.click();
                URL.revokeObjectURL(url);
                this.unsavedChanges = false;
                this.showMsg("Datei heruntergeladen");
                return;
            }
            if(!this.fileHandle) return; 
            try { const writable = await this.fileHandle.createWritable(); await writable.write(JSON.stringify(Store.get(), null, 2)); await writable.close(); this.unsavedChanges = false; this.showMsg("Datei gespeichert"); } catch(e) { alert("Fehler beim Speichern"); } 
        }
      }
    });

    app.config.compilerOptions.delimiters = ['[[', ']]'];
    app.use(vuetify);
    window.vm = app.mount('#app');
  </script>
</body>
</html>