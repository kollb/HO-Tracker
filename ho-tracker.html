<!DOCTYPE html>
<html lang="de">
<head>
  <title>Home Office Planer</title>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui">
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 24 24%22 fill=%22%231976D2%22><path d=%22M10,20V14H14V20H19V12H22L12,3L2,12H5V20H10Z%22/></svg>">
  
  <link href="https://fonts.googleapis.com/css?family=Roboto:100,300,400,500,700,900" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/@mdi/font@6.x/css/materialdesignicons.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.css" rel="stylesheet">
  <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/vuetify@3.x/dist/vuetify.min.js"></script>
  
  <style>
    [v-cloak] { display: none !important; }
    body { font-family: 'Roboto', sans-serif; background-color: #121212; }
    .v-field__input { padding-top: 6px !important; padding-bottom: 6px !important; min-height: 32px !important; }
    
    /* Sticky Header */
    .status-bar { 
        position: sticky; top: 48px; z-index: 10;
        border-bottom: 1px solid rgba(128,128,128, 0.2);
        background: rgb(var(--v-theme-surface));
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    }
    .stat-label { 
        font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; opacity: 0.7; 
        font-weight: 600; margin-bottom: 2px; display: flex; align-items: center; justify-content: center;
    }
    .stat-value { font-weight: 700; font-size: 0.95rem; line-height: 1.2; }

    /* Tabellen & Listen Styling */
    .day-row { transition: background-color 0.2s; }
    .day-row:hover { background-color: rgba(128,128,128, 0.1) !important; }
    .weekend, .holiday-row { background-color: rgba(128,128,128, 0.05); opacity: 0.8; }
    .is-today { border-left: 4px solid #1976D2; background-color: rgba(25, 118, 210, 0.1) !important; }
    .short-day-row { background-color: rgba(255, 152, 0, 0.05); } 
    .off-day-row { background-color: rgba(0, 0, 0, 0.02); opacity: 0.6; text-decoration: line-through; text-decoration-color: #aaa; }
    .week-summary-row { background-color: rgba(128,128,128, 0.1); height: 36px !important; }
    .week-summary-row td { font-weight: bold; font-size: 0.85rem; padding-top: 0 !important; padding-bottom: 0 !important; }

    /* Kalender Grid */
    .calendar-wrapper { display: grid; grid-template-columns: repeat(7, 1fr) 60px; gap: 6px; padding: 10px; }
    .cal-header { text-align: center; font-weight: bold; font-size: 0.85rem; padding-bottom: 5px; text-transform: uppercase; opacity: 0.7; }
    .cal-cell {
        border: 1px solid rgba(128,128,128, 0.2); border-radius: 8px; min-height: 110px; padding: 6px;
        display: flex; flex-direction: column; justify-content: space-between; cursor: pointer; transition: all 0.2s; position: relative;
    }
    .cal-cell:hover { border-color: #1976D2; box-shadow: 0 2px 8px rgba(0,0,0,0.2); z-index: 2; transform: translateY(-2px); }
    .cal-cell.is-holiday { background-color: rgba(244, 67, 54, 0.05); border-color: rgba(244, 67, 54, 0.2); }
    .cal-cell.is-short-day { background-color: rgba(255, 152, 0, 0.05); border-color: rgba(255, 152, 0, 0.3); }
    .cal-cell.is-weekend { background-color: rgba(128,128,128, 0.03); }
    .cal-cell.is-off-day { background-color: rgba(0,0,0,0.02); opacity: 0.5; } 
    .cal-cell.is-today { border: 2px solid #1976D2; background-color: rgba(25, 118, 210, 0.1); }
    .cal-date { font-weight: bold; font-size: 1rem; margin-bottom: 4px; }
    .cal-holiday-name { font-size: 0.7rem; color: #ef5350; line-height: 1.1; margin-bottom: 4px; font-weight: 500;}
    .cal-short-info { font-size: 0.7rem; color: #f57c00; font-weight: bold; margin-bottom: 4px; }
    .cal-content { flex-grow: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; }
    .cal-week-sum { display: flex; align-items: center; justify-content: center; text-align: center; font-size: 0.75rem; opacity: 0.7; writing-mode: vertical-rl; transform: rotate(180deg); background: rgba(128,128,128, 0.1); border-radius: 4px; }

    .status-home { background-color: rgba(76, 175, 80, 0.15); border-color: rgba(76, 175, 80, 0.5); }
    .status-office { background-color: rgba(255, 193, 7, 0.15); border-color: rgba(255, 193, 7, 0.5); }
    .status-sick { background-color: rgba(244, 67, 54, 0.15); }
    .status-vacation { background-color: rgba(156, 39, 176, 0.15); }
    
    .file-status { font-size: 0.75rem; margin-right: 10px; color: #666; display: flex; align-items: center; gap: 5px; }
    .dot { width: 8px; height: 8px; border-radius: 50%; display: inline-block; }
    .dot.green { background-color: #4caf50; }
    .dot.red { background-color: #f44336; }
    .dot.orange { background-color: #ff9800; }

    /* Print Styles */
    @media print {
        body { background-color: white !important; }
        .v-app-bar, .v-btn, .v-divider { display: none !important; }
        .status-bar { position: static !important; border: none !important; background: white !important; }
        .v-table { border: 1px solid #333; }
        .v-table th, .v-table td { border: 1px solid #ddd; padding: 8px !important; }
        .cal-cell { break-inside: avoid; }
        .v-card { box-shadow: none !important; border: 1px solid #ddd !important; }
        @page { margin: 1cm; }
    }

    @media (max-width: 600px) {
        .calendar-wrapper { gap: 2px; padding: 2px; grid-template-columns: repeat(7, 1fr) 25px; }
        .cal-cell { min-height: 50px; padding: 2px; border-radius: 4px; }
        .cal-holiday-name, .cal-short-info, .cal-content { display: none !important; }
        .cal-date { font-size: 0.8rem; margin: 0; }
        .cal-cell .v-icon { position: absolute; top: 2px; right: 2px; font-size: 10px; }
        .cal-week-sum { font-size: 0.6rem; }
        .stat-label { font-size: 0.55rem; }
        .stat-value { font-size: 0.85rem; }
    }
  </style>
</head>
<body>
  
  <div id="app" v-cloak>
    <v-app>
      <v-app-bar color="primary" density="compact" elevation="1">
        <v-app-bar-title class="font-weight-bold" style="cursor: pointer" @click="goHome">
            HO Planer
        </v-app-bar-title>
        <v-spacer></v-spacer>
        
        <div class="file-status" v-if="fileHandle">
            <span class="dot green"></span>
            <span class="d-none d-sm-inline">Datei: [[ fileName ]]</span>
        </div>
        <div v-else-if="storedHandleName" class="file-status">
            <span class="dot orange"></span>
            <span class="d-none d-sm-inline">Letzte: [[ storedHandleName ]]</span>
            <v-btn size="x-small" color="white" variant="outlined" class="ml-2" @click="restoreFileConnection">Verbinden</v-btn>
        </div>
        <div class="file-status" v-else>
            <span class="dot red"></span>
            <span class="d-none d-sm-inline">Lokal</span>
        </div>

        <v-tooltip text="Datei öffnen / wechseln" location="bottom">
            <template v-slot:activator="{ props }">
                 <v-btn v-bind="props" icon="mdi-folder-open" size="small" @click="openFile" class="mr-1" aria-label="Datei öffnen oder wechseln"></v-btn>
            </template>
        </v-tooltip>
        
        <v-tooltip text="Speichern" location="bottom">
            <template v-slot:activator="{ props }">
                 <v-btn v-bind="props" icon="mdi-content-save" size="small" @click="saveToFile" :disabled="!fileHandle" :color="unsavedChanges ? 'warning' : 'white'" class="mr-1" aria-label="Daten speichern"></v-btn>
            </template>
        </v-tooltip>
        
        <v-menu>
            <template v-slot:activator="{ props }">
                <v-btn v-bind="props" icon="mdi-download" size="small" class="mr-3" aria-label="Daten exportieren">
                </v-btn>
            </template>
            <v-list density="compact">
                <v-list-item @click="exportToCSV('month')" prepend-icon="mdi-file-delimited">
                    <v-list-item-title>Monat als CSV</v-list-item-title>
                </v-list-item>
                <v-list-item @click="exportToCSV('year')" prepend-icon="mdi-file-delimited">
                    <v-list-item-title>Jahr als CSV</v-list-item-title>
                </v-list-item>
            </v-list>
        </v-menu>

        <v-divider vertical class="mx-2 my-3" color="white" thickness="2"></v-divider>

        <v-btn icon @click="toggleTheme" class="mr-2" aria-label="Farbschema wechseln">
            <v-icon>[[ theme.global.current.dark ? 'mdi-weather-sunny' : 'mdi-weather-night' ]]</v-icon>
        </v-btn>

        <v-btn-toggle v-model="viewMode" density="compact" mandatory class="mr-3" variant="outlined" color="white" divided aria-label="Ansicht wechseln">
            <v-btn value="list" icon="mdi-format-list-bulleted" @click="loadMonthData" aria-label="Listenansicht"></v-btn>
            <v-btn value="calendar" icon="mdi-calendar-month" @click="loadMonthData" aria-label="Kalenderansicht"></v-btn>
            <v-btn value="year" icon="mdi-chart-bar" @click="loadYearData" aria-label="Jahresansicht"></v-btn>
        </v-btn-toggle>
        <v-btn icon @click="dialogSettings = true" aria-label="Einstellungen öffnen"><v-icon>mdi-cog</v-icon></v-btn>
      </v-app-bar>

      <v-main>
        <v-container fluid class="status-bar py-2 px-4 mb-3" v-if="viewMode !== 'year'">
            <div class="mx-auto" style="max-width: 1200px; width: 100%;">
                <v-row align="center" no-gutters>
                    <v-col cols="3" class="d-flex align-center">
                        <v-btn icon variant="text" size="small" @click="changeMonth(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                        <div class="font-weight-bold mx-1 text-center" style="line-height: 1.1;">
                            <div class="text-uppercase" style="font-size: 0.9rem;">[[ currentMonthName ]]</div>
                            <div class="text-caption opacity-60" style="font-size: 0.7rem;">[[ currentYear ]]</div>
                        </div>
                        <v-btn icon variant="text" size="small" @click="changeMonth(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
                    </v-col>

                    <v-col cols="5" class="d-flex justify-center px-2">
                        <div class="d-flex justify-space-around w-100" style="max-width: 380px;">
                            <div class="text-center">
                                 <div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-calendar-check</v-icon>Arbeitstage</div>
                                 <div class="stat-value">[[ stats.workdays_month ]]</div>
                            </div>
                            <div class="text-center">
                                <div class="stat-label"><v-icon size="x-small" class="mr-1">mdi-office-building</v-icon>Bürostd.</div>
                                <div class="stat-value text-amber-darken-2">[[ formatNum(stats.total_office_made) ]] <span class="text-caption opacity-60">h</span></div>
                            </div>
                        </div>
                    </v-col>

                    <v-col cols="4" class="pl-2">
                        <div class="d-flex flex-column align-end justify-center h-100">
                            <div class="text-caption text-uppercase font-weight-bold opacity-50 mb-0" style="font-size: 0.6rem !important; letter-spacing: 1px;">Home Office Budget</div>
                            <div class="d-flex align-center mb-1">
                                 <span class="text-caption text-uppercase font-weight-bold opacity-50 mr-2" style="font-size: 0.65rem; letter-spacing: 0.5px;">Verfügbar:</span>
                                 <span class="text-subtitle-1 font-weight-bold" :class="budgetStateColor" style="line-height: 1.1;">
                                     <span v-if="budgetRemainingDays > 0">+</span>[[ formatOneDecimal(budgetRemainingDays) ]] Tage
                                 </span>
                                 <span class="text-caption font-weight-medium opacity-60 ml-2" :class="budgetStateColor">([[ formatNum(budgetRemainingHours) ]] h)</span>
                            </div>
                            <v-progress-linear :model-value="quotaPercentage" :color="getQuotaColor" height="6" rounded class="mb-1" style="width: 100%;" bg-color="grey-darken-3" bg-opacity="0.3"></v-progress-linear>
                            <div class="d-flex align-center mt-0">
                                <span class="text-caption text-uppercase font-weight-bold opacity-40 mr-2" style="font-size: 0.65rem; letter-spacing: 0.5px;">Genutzt:</span>
                                <span class="text-caption opacity-80 font-weight-medium" style="font-size: 0.75rem;">[[ formatNum(stats.total_ho_made) ]] / [[ formatNum(stats.total_ho_allowed) ]] h</span>
                            </div>
                        </div>
                    </v-col>
                </v-row>
            </div>
        </v-container>

        <v-container fluid class="status-bar py-3 px-4 mb-3" v-else>
            <div class="mx-auto" style="max-width: 1200px; width: 100%;">
                <v-row align="center" no-gutters>
                    <v-col cols="3" class="d-flex align-center">
                        <v-btn icon variant="text" size="small" @click="changeYear(-1)"><v-icon>mdi-chevron-left</v-icon></v-btn>
                        <div class="font-weight-bold mx-2 text-center" style="min-width: 120px;">Jahr [[ currentYear ]]</div>
                        <v-btn icon variant="text" size="small" @click="changeYear(1)"><v-icon>mdi-chevron-right</v-icon></v-btn>
                    </v-col>
                    <v-col cols="9" class="text-right"><span class="stat-label">Jahresübersicht</span></v-col>
                </v-row>
            </div>
        </v-container>

        <v-container class="mx-auto" style="max-width: 1200px;">
            <v-card elevation="0" border min-height="500">
                <v-table density="compact" v-if="viewMode === 'list'" class="d-none d-md-block" style="width: 100%;">
                    <template v-slot:default>
                        <thead>
                            <tr style="background-color: rgba(128,128,128,0.05);">
                                <th class="text-left font-weight-bold">Datum</th><th class="text-left font-weight-bold">Status</th><th class="text-left font-weight-bold">Start</th>
                                <th class="text-left font-weight-bold">Ende</th><th class="text-left font-weight-bold">Stunden</th><th style="width: 50px;"></th>
                            </tr>
                        </thead>
                        <tbody>
                            <template v-for="item in items" :key="item ? item.date : 'list-desk'">
                                <tr v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))" 
                                    :class="{'weekend': isWeekend(item), 'off-day-row': item.is_off_day, 'holiday-row': item.is_holiday, 'short-day-row': item.is_short_day, 'is-today': isToday(item.date), 'day-row': true}">
                                    <td class="py-2">
                                        <div class="font-weight-medium">[[ item.day_num ]]. [[ getGermanDay(item.weekday_index) ]]</div>
                                        <div v-if="item.is_holiday" class="text-caption text-red-lighten-1 font-weight-bold">[[ item.holiday_name ]]</div>
                                        <div v-if="item.is_short_day" class="text-caption text-orange-darken-1 font-weight-bold">[[ item.holiday_name ]] (Kurz)</div>
                                    </td>
                                    <td style="min-width: 160px;">
                                        <v-select v-if="!item.is_off_day" v-model="item.type" :items="types" item-title="title" item-value="value" variant="plain" density="compact" hide-details class="mt-0 pt-0" @update:model-value="onTypeChange(item)"></v-select>
                                        <span v-else class="text-caption opacity-50">Freier Tag</span>
                                    </td>
                                    <td>
                                        <div v-if="!item.is_off_day">
                                            <v-text-field v-if="needsTimeInput(item.type)" v-model="item.start" placeholder="08:00" variant="underlined" density="compact" hide-details @input="onTypeTime(item)" @change="saveEntry(item)"></v-text-field>
                                            <span v-else-if="item.type == 'x'" class="text-caption opacity-60">Automatisch</span>
                                        </div>
                                    </td>
                                    <td>
                                        <div v-if="!item.is_off_day">
                                            <v-text-field v-if="needsTimeInput(item.type)" v-model="item.end" placeholder="16:00" variant="underlined" density="compact" hide-details @input="onTypeTime(item)" @change="saveEntry(item)"></v-text-field>
                                            <span v-else-if="item.type == 'x'" class="text-caption opacity-60">Ganzer Tag</span>
                                        </div>
                                    </td>
                                    <td>
                                        <v-chip size="small" :color="getChipColor(item)" v-if="item.net > 0 || item.type === 'x'" variant="flat">[[ formatNum(item.net) ]] h</v-chip>
                                        <span v-if="item.is_short_day" class="text-caption ml-1 opacity-50">(Soll: [[ formatNum(item.daily_target) ]])</span>
                                        <div v-if="hasValidationError(item.date)" class="text-caption text-error mt-1">
                                            <v-icon size="x-small" color="error">mdi-alert-circle</v-icon> [[ getValidationError(item.date) ]]
                                        </div>
                                    </td>
                                    <td><v-btn icon size="x-small" variant="text" class="opacity-50" @click="clearEntry(item)" v-if="item.type"><v-icon>mdi-close</v-icon></v-btn></td>
                                </tr>
                                <tr v-else-if="item && item.row_type === 'summary'" class="week-summary-row">
                                    <td colspan="4" class="text-right pr-4">KW [[ item.iso_week ]] GESAMT:</td>
                                    <td colspan="2"><span :class="getWeeklyColor(item.sum, item.target)">[[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] h</span><v-icon v-if="item.sum >= item.target" color="green" size="small" class="ml-1">mdi-check-circle</v-icon></td>
                                </tr>
                            </template>
                        </tbody>
                    </template>
                </v-table>

                <div v-if="viewMode === 'list'" class="d-md-none pa-2">
                    <template v-for="item in items" :key="item ? 'mob-'+item.date : 'mob-unk'">
                        <v-card v-if="item && item.row_type === 'day' && (!settings.hide_weekends || !isWeekend(item))" class="mb-2" elevation="1" 
                                :class="{'is-today': isToday(item.date)}"
                                :style="item.is_off_day || isWeekend(item) ? 'opacity: 0.7; background: rgba(128,128,128,0.05)' : ''">
                            <div class="d-flex justify-space-between align-center pa-2 pb-0">
                                <div>
                                    <span class="font-weight-bold text-subtitle-1">[[ item.day_num ]]. [[ getGermanDay(item.weekday_index) ]]</span>
                                    <span v-if="item.is_holiday" class="text-caption text-red ml-2">[[ item.holiday_name ]]</span>
                                </div>
                                <v-chip v-if="item.net > 0 || item.type === 'x'" size="small" :color="getChipColor(item)" variant="flat" class="font-weight-bold">[[ formatNum(item.net) ]] h</v-chip>
                            </div>
                            <div class="pa-2 pt-0" v-if="!item.is_off_day">
                                <v-select v-model="item.type" :items="types" label="Status" item-title="title" item-value="value" variant="underlined" density="compact" hide-details class="mb-1" @update:model-value="onTypeChange(item)"></v-select>
                                <div v-if="needsTimeInput(item.type)" class="d-flex mt-2" style="gap: 10px">
                                    <v-text-field v-model="item.start" label="Start" type="time" variant="outlined" density="compact" hide-details @change="saveEntry(item)"></v-text-field>
                                    <v-text-field v-model="item.end" label="Ende" type="time" variant="outlined" density="compact" hide-details @change="saveEntry(item)"></v-text-field>
                                </div>
                            </div>
                            <div class="d-flex justify-end pa-1" v-if="item.type">
                                 <v-btn size="small" variant="text" color="error" @click="clearEntry(item)">Löschen</v-btn>
                            </div>
                        </v-card>
                        <div v-else-if="item && item.row_type === 'summary'" class="text-center py-2 mb-2 text-caption font-weight-bold text-uppercase" style="background: rgba(128,128,128,0.1); border-radius: 4px;">
                            KW [[ item.iso_week ]]: <span :class="getWeeklyColor(item.sum, item.target)" class="text-body-2 ml-1">[[ formatNum(item.sum) ]] / [[ formatNum(item.target) ]] h</span>
                        </div>
                    </template>
                </div>

                <div v-else-if="viewMode === 'calendar'" class="pa-2">
                    <div class="calendar-wrapper">
                        <div class="cal-header">Mo</div><div class="cal-header">Di</div><div class="cal-header">Mi</div><div class="cal-header">Do</div><div class="cal-header">Fr</div><div class="cal-header text-red">Sa</div><div class="cal-header text-red">So</div><div class="cal-header" style="font-size: 0.7rem">KW</div>
                        <div v-for="n in paddingDays" :key="'pad-'+n" style="background: transparent;"></div>
                        <template v-for="item in items" :key="item ? item.date : 'cal-unk'">
                            <div v-if="item && item.row_type === 'day'" class="cal-cell"
                                 :class="{'is-holiday': item.is_holiday, 'is-weekend': isWeekend(item), 'is-today': isToday(item.date), 'is-short-day': item.is_short_day, 'is-off-day': item.is_off_day, 'status-home': item.type === 'home' || item.type === 'x', 'status-office': item.type === 'office', 'status-sick': item.type === 'sick', 'status-vacation': item.type === 'vacation'}"
                                 @click="openEditDialog(item)">
                                <div class="d-flex justify-space-between align-start">
                                    <span class="cal-date" :class="{'opacity-50': item.is_off_day}">[[ item.day_num ]]</span>
                                    <v-icon v-if="item.type" :color="getStatusIconColor(item.type)" size="small">[[ getStatusIcon(item.type) ]]</v-icon>
                                </div>
                                <div v-if="item.is_holiday" class="cal-holiday-name">[[ item.holiday_name ]]</div>
                                <div v-if="item.is_short_day" class="cal-short-info">[[ item.holiday_name ]] (6h)</div>
                                <div class="cal-content">
                                    <div v-if="item.type" class="font-weight-bold text-caption text-uppercase" :style="{color: getStatusIconColor(item.type)}">[[ getTypeName(item.type) ]]</div>
                                    <div v-if="item.net > 0 || item.type === 'x'" class="text-caption font-weight-bold">[[ formatNum(item.net) ]] h</div>
                                </div>
                            </div>
                            <div v-else-if="item && item.row_type === 'summary'" class="cal-week-sum" :title="'KW ' + item.iso_week"><span :class="getWeeklyColor(item.sum, item.target)" class="font-weight-bold">[[ formatNum(item.sum) ]]</span></div>
                        </template>
                    </div>
                </div>

                <v-table v-if="viewMode === 'year'" density="comfortable">
                    <template v-slot:default>
                        <thead><tr style="background-color: rgba(128,128,128,0.05);"><th class="text-left">Monat</th><th class="text-center">Home Office Tage</th><th class="text-center">Büro Tage</th><th class="text-center">Budget Nutzung</th></tr></thead>
                        <tbody>
                            <tr v-for="stat in yearData" :key="stat.month">
                                <td class="font-weight-medium">[[ getGermanMonthName(stat.month) ]]</td>
                                <td class="text-center"><v-chip size="small" color="green" variant="flat" v-if="stat.days_ho > 0">[[ stat.days_ho ]] Tage</v-chip><span v-else class="opacity-50">-</span></td>
                                <td class="text-center"><v-chip size="small" color="amber-darken-2" variant="flat" v-if="stat.days_office > 0">[[ stat.days_office ]] Tage</v-chip><span v-else class="opacity-50">-</span></td>
                                <td class="text-center"><div class="d-flex align-center justify-center"><div style="width: 120px" class="mr-2"><v-progress-linear :model-value="stat.ho_hours_allowed ? (stat.ho_hours_made / stat.ho_hours_allowed)*100 : 0" color="blue" height="6" rounded></v-progress-linear></div><span class="text-caption">[[ formatNum(stat.ho_hours_made) ]] / [[ formatNum(stat.ho_hours_allowed) ]] h</span></div></td>
                            </tr>
                        </tbody>
                    </template>
                </v-table>
            </v-card>
        </v-container>
      </v-main>

      <v-dialog v-model="dialogEditDay" max-width="400">
        <v-card v-if="editingDay">
            <v-card-title class="bg-primary text-white">[[ editingDay.day_num ]]. [[ currentMonthName ]] - Status</v-card-title>
            <v-card-text class="pt-4">
                <div v-if="editingDay.is_off_day" class="text-center text-body-2 mb-4 text-orange"><v-icon color="orange">mdi-alert</v-icon> Dies ist laut deinen Einstellungen ein freier Tag.</div>
                <v-select v-model="editingDay.type" :items="types" label="Status" item-title="title" item-value="value" variant="outlined" density="comfortable" @update:model-value="onTypeChange(editingDay)"></v-select>
                <div v-if="needsTimeInput(editingDay.type)">
                    <v-row>
                        <v-col cols="6"><v-text-field v-model="editingDay.start" label="Start" placeholder="08:00" variant="outlined" density="compact" @change="saveEntry(editingDay)"></v-text-field></v-col>
                        <v-col cols="6"><v-text-field v-model="editingDay.end" label="Ende" placeholder="16:00" variant="outlined" density="compact" @change="saveEntry(editingDay)"></v-text-field></v-col>
                    </v-row>
                    <div class="text-center text-h6 mt-2" v-if="editingDay.net > 0">[[ formatNum(editingDay.net) ]] Stunden</div>
                </div>
            </v-card-text>
            <v-card-actions><v-btn color="error" variant="text" @click="clearEntry(editingDay); dialogEditDay = false">Löschen</v-btn><v-spacer></v-spacer><v-btn color="primary" @click="saveEntry(editingDay); dialogEditDay = false">Speichern</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialogSettings" max-width="700">
        <v-card>
          <v-card-title>Einstellungen</v-card-title>
          <v-card-text>
            <v-row>
              <v-col cols="12"><h3 class="text-subtitle-1 font-weight-bold mb-2">Allgemein</h3></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.weekly_hours" label="Wochenstunden (Vertrag)" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              <v-col cols="6"><v-text-field v-model.number="settings.ho_quota_percent" label="HO Quote %" type="number" density="compact" variant="outlined"></v-text-field></v-col>
              
              <v-col cols="12" class="mt-0 pt-0">
                  <div class="text-caption mb-2 font-weight-bold">Reguläre Arbeitstage</div>
                  <div class="d-flex justify-space-between" style="max-width: 400px">
                      <v-checkbox v-model="settings.active_weekdays" :value="0" label="Mo" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="1" label="Di" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="2" label="Mi" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="3" label="Do" density="compact" hide-details></v-checkbox>
                      <v-checkbox v-model="settings.active_weekdays" :value="4" label="Fr" density="compact" hide-details></v-checkbox>
                  </div>
                  <div class="text-caption text-grey">Tägliches Soll (auto): [[ formatNum(calcDailyTarget) ]] Stunden</div>
                  
                  <v-divider class="my-2"></v-divider>
                  <v-switch v-model="settings.hide_weekends" label="Wochenenden in Listenansicht ausblenden" color="primary" density="compact" hide-details></v-switch>

                  <v-divider class="my-2"></v-divider>
                  <h3 class="text-subtitle-1 font-weight-bold mb-2">Automatisierung</h3>
                  <v-row align="center">
                      <v-col cols="6">
                        <v-text-field v-model="settings.default_start_time" label="Standard Startzeit" type="time" density="compact" variant="outlined" hide-details>
                            <template v-slot:append><v-tooltip location="bottom" text="Standard Startzeit für automatische Umwandlung"><template v-slot:activator="{ props }"><v-icon v-bind="props" icon="mdi-information-outline" size="small"></v-icon></template></v-tooltip></template>
                        </v-text-field>
                      </v-col>
                      <v-col cols="6">
                          <v-switch v-model="settings.auto_convert_planned" label="Planung automatisch umwandeln" color="primary" density="compact" hide-details>
                             <template v-slot:append><v-tooltip location="bottom" text="Wandelt 'Geplanter HO-Tag' in der Vergangenheit automatisch in 'Home Office' um."><template v-slot:activator="{ props }"><v-icon v-bind="props" icon="mdi-information-outline" size="small"></v-icon></template></v-tooltip></template>
                          </v-switch>
                      </v-col>
                  </v-row>
              </v-col>
            </v-row>
            <v-divider class="my-3"></v-divider>
            <div class="d-flex justify-space-between align-center mb-2">
                <h3 class="text-subtitle-1 font-weight-bold">Datensicherung</h3>
            </div>
            <v-row>
                <v-col cols="6">
                    <v-btn block color="primary" variant="outlined" @click="downloadBackup" prepend-icon="mdi-download">
                        Backup herunterladen
                    </v-btn>
                </v-col>
                <v-col cols="6">
                    <v-btn block color="primary" variant="outlined" @click="triggerRestoreBackup" prepend-icon="mdi-upload">
                        Backup wiederherstellen
                    </v-btn>
                    <input type="file" ref="restoreFileInput" @change="restoreBackup" accept=".json" style="display: none;">
                </v-col>
            </v-row>
            <div class="text-caption text-grey mt-2">
                Sichere deine Daten als JSON-Datei oder stelle eine frühere Sicherung wieder her.
            </div>
            <v-divider class="my-3"></v-divider>
            <div class="d-flex justify-space-between align-center mb-2"><h3 class="text-subtitle-1 font-weight-bold">Eigene Feiertage</h3><v-btn size="small" variant="tonal" color="primary" @click="addWaeldchestag"><v-icon start>mdi-calendar-plus</v-icon> Wäldchestag [[ currentYear ]]</v-btn></div>
            <v-table density="compact" class="mb-3" v-if="Object.keys(customHolidays).length > 0">
              <template v-slot:default>
                <thead><tr><th>Datum</th><th>Name</th><th style="width: 80px;">Soll-Std.</th><th style="width: 40px"></th></tr></thead>
                <tbody>
                    <tr v-for="(h, date) in customHolidays" :key="date"><td>[[ h.date ]]</td><td>[[ h.name ]]</td><td><span v-if="h.hours > 0" class="text-orange font-weight-bold">[[ h.hours ]] h</span><span v-else class="text-grey">Frei</span></td><td><v-btn icon size="x-small" variant="text" color="red" @click="deleteCustomHoliday(date)"><v-icon>mdi-delete</v-icon></v-btn></td></tr>
                </tbody>
              </template>
            </v-table>
            <v-row align="center">
              <v-col cols="4"><v-text-field v-model="newCustomHoliday.date" label="Datum" density="compact" variant="outlined" hide-details type="date"></v-text-field></v-col>
              <v-col cols="4"><v-text-field v-model="newCustomHoliday.name" label="Bez." density="compact" variant="outlined" hide-details></v-text-field></v-col>
              <v-col cols="2"><v-text-field v-model.number="newCustomHoliday.hours" label="Std." placeholder="0" type="number" density="compact" variant="outlined" hide-details></v-text-field></v-col>
              <v-col cols="2"><v-btn color="primary" icon size="small" @click="addCustomHoliday"><v-icon>mdi-plus</v-icon></v-btn></v-col>
            </v-row>
          </v-card-text>
          <v-card-actions><v-spacer></v-spacer><v-btn color="primary" @click="saveSettings">Schließen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>

      <v-dialog v-model="dialogHelp" max-width="500">
        <v-card>
          <v-card-title class="bg-primary text-white">Tastenkombinationen</v-card-title>
          <v-card-text class="pt-4">
            <v-list density="compact">
              <v-list-item prepend-icon="mdi-content-save">
                <v-list-item-title><kbd>Strg/Cmd + S</kbd></v-list-item-title>
                <v-list-item-subtitle>Speichern</v-list-item-subtitle>
              </v-list-item>
              <v-list-item prepend-icon="mdi-folder-open">
                <v-list-item-title><kbd>Strg/Cmd + O</kbd></v-list-item-title>
                <v-list-item-subtitle>Datei öffnen</v-list-item-subtitle>
              </v-list-item>
              <v-list-item prepend-icon="mdi-download">
                <v-list-item-title><kbd>Strg/Cmd + E</kbd></v-list-item-title>
                <v-list-item-subtitle>CSV exportieren</v-list-item-subtitle>
              </v-list-item>
              <v-list-item prepend-icon="mdi-arrow-left-right">
                <v-list-item-title><kbd>←</kbd> / <kbd>→</kbd></v-list-item-title>
                <v-list-item-subtitle>Monat/Jahr wechseln</v-list-item-subtitle>
              </v-list-item>
              <v-list-item prepend-icon="mdi-view-dashboard">
                <v-list-item-title><kbd>1</kbd> / <kbd>2</kbd> / <kbd>3</kbd></v-list-item-title>
                <v-list-item-subtitle>Ansicht wechseln (Liste/Kalender/Jahr)</v-list-item-subtitle>
              </v-list-item>
              <v-list-item prepend-icon="mdi-home">
                <v-list-item-title><kbd>H</kbd></v-list-item-title>
                <v-list-item-subtitle>Zum aktuellen Monat</v-list-item-subtitle>
              </v-list-item>
              <v-list-item prepend-icon="mdi-help-circle">
                <v-list-item-title><kbd>?</kbd></v-list-item-title>
                <v-list-item-subtitle>Diese Hilfe anzeigen</v-list-item-subtitle>
              </v-list-item>
            </v-list>
          </v-card-text>
          <v-card-actions><v-spacer></v-spacer><v-btn color="primary" @click="dialogHelp = false">Schließen</v-btn></v-card-actions>
        </v-card>
      </v-dialog>
    </v-app>
  </div>

  <script>
    const { createApp } = Vue
    const { createVuetify } = Vuetify
    const vuetify = createVuetify({ theme: { defaultTheme: 'dark' } })

    const IDB_NAME = 'bbk_tracker_db';
    const IDB_STORE = 'handles';
    async function idbSet(key, val) { return new Promise((resolve, reject) => { const req = indexedDB.open(IDB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE); req.onsuccess = e => { const db = e.target.result; const tx = db.transaction(IDB_STORE, 'readwrite'); tx.objectStore(IDB_STORE).put(val, key); tx.oncomplete = () => resolve(); tx.onerror = () => reject(tx.error); }; }); }
    async function idbGet(key) { return new Promise((resolve, reject) => { const req = indexedDB.open(IDB_NAME, 1); req.onupgradeneeded = e => e.target.result.createObjectStore(IDB_STORE); req.onsuccess = e => { const db = e.target.result; const tx = db.transaction(IDB_STORE, 'readonly'); const getReq = tx.objectStore(IDB_STORE).get(key); getReq.onsuccess = () => resolve(getReq.result); getReq.onerror = () => reject(getReq.error); }; }); }

    const Store = {
        data: { settings:{}, entries:{}, customHolidays:{} },
        init() {
            const ls = localStorage.getItem('bbk_data');
            if(ls) try { this.data = JSON.parse(ls); } catch(e){}
            if(!this.data.settings) this.data.settings = {};
            if(!this.data.entries) this.data.entries = {};
            if(!this.data.customHolidays) this.data.customHolidays = {};
        },
        get() { return this.data; },
        set(newData) { this.data = newData; if(!this.data.customHolidays) this.data.customHolidays = {}; localStorage.setItem('bbk_data', JSON.stringify(this.data)); },
        getSettings() { 
            // DEFAULT Settings (Hier sind die neuen Felder!)
            return { 
                weekly_hours: 39, 
                active_weekdays: [0,1,2,3,4], 
                ho_quota_percent: 60, 
                hide_weekends: false,
                default_start_time: '08:00', // NEU
                auto_convert_planned: true   // NEU
            , ...this.data.settings }; 
        },
        saveSettings(s) { this.data.settings = s; this.persist(); },
        getEntries() { return this.data.entries || {}; },
        saveEntry(date, entryData) { this.data.entries[date] = entryData; this.persist(); },
        deleteEntry(date) { delete this.data.entries[date]; this.persist(); },
        getCustomHolidays() { return this.data.customHolidays || {}; },
        saveCustomHolidays(mapObj) { this.data.customHolidays = mapObj; this.persist(); },
        onPersist: null,
        persist() { localStorage.setItem('bbk_data', JSON.stringify(this.data)); if(this.onPersist) this.onPersist(); }
    };
    Store.init();

    // Helper (Logic)
    function normalizeTimeInput(t) {
        if(!t) return ""; t = t.toString().trim(); if (t.match(/^\d{2}:\d{2}$/)) return t;
        let h=0, m=0;
        if (t.includes(':')) { const p = t.split(':'); h = parseInt(p[0]); m = parseInt(p[1]); } 
        else if (t.includes('.')) { const p = t.split('.'); h = parseInt(p[0]); m = parseInt(p[1]); } 
        else if (t.length === 4 && !isNaN(t)) { h = parseInt(t.substring(0, 2)); m = parseInt(t.substring(2, 4)); } 
        else if (t.length === 3 && !isNaN(t)) { h = parseInt(t.substring(0, 1)); m = parseInt(t.substring(1, 3)); } 
        else if (t.length <= 2 && !isNaN(t)) { h = parseInt(t); m = 0; } else { return t; }
        if(isNaN(h)) h = 0; if(isNaN(m)) m = 0; return `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
    }
    function calculateNetHours(start, end) {
        const parseToHours = (t) => { if(!t) return 0.0; const norm = normalizeTimeInput(t); if(!norm.includes(':')) return 0.0; const p = norm.split(':'); return parseInt(p[0]) + parseInt(p[1])/60.0; }
        if(!start || !end) return 0.0;
        let t_start = parseToHours(start); let t_end = parseToHours(end); let hours_worked = t_end - t_start; if(hours_worked < 0) return 0.0; 
        let net_hours = 0.0;
        if (hours_worked <= 6.0) net_hours = hours_worked; else if (hours_worked < 6.5) net_hours = 6.0; else if (hours_worked < 9.5) net_hours = hours_worked - 0.5; else if (hours_worked < 9.75) net_hours = 9.0; else net_hours = hours_worked - 0.75;
        return parseFloat(net_hours.toFixed(2));
    }
    function getCustomHolidayInfo(dateObj) { const ymd = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0]; return Store.getCustomHolidays()[ymd]; }
    
    // Constants
    const UTF8_BOM = '\ufeff'; // UTF-8 Byte Order Mark for Excel compatibility
    
    /**
     * Validates a time string in HH:MM format
     * @param {string} timeStr - The time string to validate
     * @returns {object} { valid: boolean, error: string }
     */
    function validateTime(timeStr) {
        if (!timeStr || timeStr.trim() === '') {
            return { valid: true, error: '' }; // Empty is valid (optional field)
        }
        
        const normalized = normalizeTimeInput(timeStr);
        if (!normalized.match(/^\d{2}:\d{2}$/)) {
            return { valid: false, error: 'Ungültiges Format (erwartet: HH:MM)' };
        }
        
        const [hours, minutes] = normalized.split(':').map(Number);
        if (hours > 23 || hours < 0) {
            return { valid: false, error: 'Stunden müssen zwischen 0 und 23 liegen' };
        }
        if (minutes > 59 || minutes < 0) {
            return { valid: false, error: 'Minuten müssen zwischen 0 und 59 liegen' };
        }
        
        return { valid: true, error: '' };
    }
    
    /**
     * Validates that end time is after start time
     * @param {string} start - Start time
     * @param {string} end - End time
     * @returns {object} { valid: boolean, error: string }
     */
    function validateTimeRange(start, end) {
        if (!start || !end) return { valid: true, error: '' };
        
        const startValidation = validateTime(start);
        const endValidation = validateTime(end);
        
        if (!startValidation.valid) return startValidation;
        if (!endValidation.valid) return endValidation;
        
        const parseToMinutes = (t) => {
            const norm = normalizeTimeInput(t);
            const [h, m] = norm.split(':').map(Number);
            return h * 60 + m;
        };
        
        const startMin = parseToMinutes(start);
        const endMin = parseToMinutes(end);
        
        if (endMin <= startMin) {
            return { valid: false, error: 'Endzeit muss nach Startzeit liegen' };
        }
        
        return { valid: true, error: '' };
    }
    
    function getHolidayName(dateObj) {
        const cust = getCustomHolidayInfo(dateObj); if(cust) return cust.name;
        const d = dateObj.getDate(), m = dateObj.getMonth() + 1, y = dateObj.getFullYear();
        if(m===12 && d===24) return "Heiligabend"; if(m===12 && d===31) return "Silvester"; if(m===1 && d===1) return "Neujahr"; if(m===5 && d===1) return "Tag der Arbeit"; if(m===10 && d===3) return "Tag der Deutschen Einheit"; if(m===12 && d===25) return "1. Weihnachtstag"; if(m===12 && d===26) return "2. Weihnachtstag";
        const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451);
        const monthE = Math.floor((h+l-7*m_easter+114)/31), dayE = ((h+l-7*m_easter+114)%31)+1; const easterDate = new Date(y, monthE-1, dayE);
        const addDays = (base, days) => { const n = new Date(base); n.setDate(n.getDate() + days); return n; }; const isSame = (d1, d2) => d1.getDate()===d2.getDate() && d1.getMonth()===d2.getMonth();
        if(isSame(dateObj, addDays(easterDate, -2))) return "Karfreitag"; if(isSame(dateObj, addDays(easterDate, 1))) return "Ostermontag"; if(isSame(dateObj, addDays(easterDate, 39))) return "Christi Himmelfahrt"; if(isSame(dateObj, addDays(easterDate, 50))) return "Pfingstmontag"; if(isSame(dateObj, addDays(easterDate, 60))) return "Fronleichnam"; 
        return "";
    }
    function getISOWeek(d) { const date = new Date(d.getTime()); date.setHours(0, 0, 0, 0); date.setDate(date.getDate() + 3 - (date.getDay() + 6) % 7); const week1 = new Date(date.getFullYear(), 0, 4); return 1 + Math.round(((date.getTime() - week1.getTime()) / 86400000 - 3 + (week1.getDay() + 6) % 7) / 7); }

    const app = createApp({
      data() {
        return {
          viewMode: 'list', currentDate: new Date(), items: [], yearData: [],
          stats: { total_ho_made: 0, total_ho_allowed: 1, total_office_made: 0, total_work_made: 0, avg_per_week: 0, workdays_month: 0 }, 
          // Settings mit neuen Feldern initialisieren
          settings: { weekly_hours: 39, active_weekdays: [0,1,2,3,4], ho_quota_percent: 60, hide_weekends: false, default_start_time: '08:00', auto_convert_planned: true },
          dialogSettings: false, dialogEditDay: false, dialogHelp: false, editingDay: null, customHolidays: {}, newCustomHoliday: { date: '', name: '', hours: 0 },
          fileHandle: null, fileName: '', storedHandleName: '', unsavedChanges: false,
          validationErrors: {}, // Store validation errors by date
          types: [{ title: 'Home Office', value: 'home' }, { title: 'Büro', value: 'office' }, { title: 'Geplanter HO-Tag', value: 'x' }, { title: 'Krank', value: 'sick' }, { title: 'Urlaub', value: 'vacation' }, { title: 'Gleitzeit', value: 'glz' }, { title: 'Dienstreise', value: 'dr' }, { title: 'Leer', value: '' }]
        }
      },
      computed: {
        currentYear() { return this.currentDate.getFullYear() },
        currentMonth() { return this.currentDate.getMonth() + 1 }, 
        currentMonthName() { return this.currentDate.toLocaleString('de-DE', { month: 'long' }) },
        quotaPercentage() { if(!this.stats.total_ho_allowed) return 0; return (this.stats.total_ho_made / this.stats.total_ho_allowed) * 100; },
        getQuotaColor() { return this.quotaPercentage > 100 ? 'red' : (this.quotaPercentage > 85 ? 'orange' : 'green-accent-3'); },
        paddingDays() { if(!this.items || this.items.length === 0) return 0; const firstDay = this.items.find(i => i.row_type === 'day'); return firstDay ? firstDay.weekday_index : 0; },
        theme() { return this.$vuetify.theme },
        calcDailyTarget() { const activeCount = this.settings.active_weekdays ? this.settings.active_weekdays.length : 5; if (activeCount === 0) return 0; return this.settings.weekly_hours / activeCount; },
        budgetRemainingHours() { return this.stats.total_ho_allowed - this.stats.total_ho_made; },
        budgetRemainingDays() { const daily = this.calcDailyTarget || 7.8; if(daily === 0) return 0; return this.budgetRemainingHours / daily; },
        budgetStateColor() { return this.budgetRemainingHours >= 0 ? 'text-green-accent-3' : 'text-red-accent-2'; }
      },
      watch: { viewMode(newVal) { if(newVal === 'year') this.loadYearData(); else this.loadMonthData(); } },
      mounted() { 
          Store.onPersist = () => { if(this.viewMode==='year') this.loadYearData(); else this.loadMonthData(); if(this.fileHandle) this.saveToFile(); else this.unsavedChanges = true; };
          this.loadData();
          this.checkForStoredHandle();
          this.setupKeyboardShortcuts();
      },
      methods: {
        setupKeyboardShortcuts() {
            document.addEventListener('keydown', (e) => {
                // Ignore if user is typing in an input field
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;
                
                // Ctrl/Cmd + S: Save
                if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                    e.preventDefault();
                    if (this.fileHandle) this.saveToFile();
                }
                
                // Ctrl/Cmd + O: Open file
                if ((e.ctrlKey || e.metaKey) && e.key === 'o') {
                    e.preventDefault();
                    this.openFile();
                }
                
                // Ctrl/Cmd + E: Export CSV (current view)
                if ((e.ctrlKey || e.metaKey) && e.key === 'e') {
                    e.preventDefault();
                    this.exportToCSV(this.viewMode === 'year' ? 'year' : 'month');
                }
                
                // Arrow Left: Previous month/year
                if (e.key === 'ArrowLeft' && !e.ctrlKey && !e.metaKey) {
                    if (this.viewMode === 'year') this.changeYear(-1);
                    else this.changeMonth(-1);
                }
                
                // Arrow Right: Next month/year
                if (e.key === 'ArrowRight' && !e.ctrlKey && !e.metaKey) {
                    if (this.viewMode === 'year') this.changeYear(1);
                    else this.changeMonth(1);
                }
                
                // 1: List view
                if (e.key === '1' && !e.ctrlKey && !e.metaKey) {
                    this.viewMode = 'list';
                }
                
                // 2: Calendar view
                if (e.key === '2' && !e.ctrlKey && !e.metaKey) {
                    this.viewMode = 'calendar';
                }
                
                // 3: Year view
                if (e.key === '3' && !e.ctrlKey && !e.metaKey) {
                    this.viewMode = 'year';
                }
                
                // H: Go home (current month)
                if (e.key === 'h' && !e.ctrlKey && !e.metaKey) {
                    this.goHome();
                }
                
                // ?: Show help
                if (e.key === '?' && !e.ctrlKey && !e.metaKey) {
                    e.preventDefault();
                    this.dialogHelp = true;
                }
            });
        },
        goHome() { window.location.reload(); },
        toggleTheme() { this.theme.global.name = this.theme.global.current.dark ? 'light' : 'dark'; },
        formatNum(val) { return val ? val.toFixed(2).replace('.', ',') : '0,00'; },
        formatOneDecimal(val) { return val ? val.toFixed(1).replace('.', ',') : '0,0'; },
        
        getGermanDay(index) { return ['Mo', 'Di', 'Mi', 'Do', 'Fr', 'Sa', 'So'][index] || ''; },
        getGermanMonthName(m) { if(!m) return ""; const d = new Date(); d.setMonth(m-1); return d.toLocaleString('de-DE', { month: 'long' }); },
        isWeekend(day) { return day.weekday_index >= 5; },
        isToday(dateStr) { return dateStr === new Date().toISOString().split('T')[0]; },
        needsTimeInput(type) { return ['home', 'office', '', null].includes(type); },
        getValidationError(date) { return this.validationErrors[date] || ''; },
        hasValidationError(date) { return !!this.validationErrors[date]; },
        getStatusIcon(type) { const map = { 'home': 'mdi-home', 'office': 'mdi-office-building', 'x': 'mdi-calendar-clock', 'sick': 'mdi-emoticon-sick', 'vacation': 'mdi-beach', 'dr': 'mdi-car' }; return map[type] || ''; },
        getStatusIconColor(type) { const map = { 'home': 'green', 'office': 'amber-darken-4', 'x': 'blue', 'sick': 'red', 'vacation': 'purple' }; return map[type] || 'grey'; },
        getTypeName(val) { const found = this.types.find(t => t.value === val); return found ? found.title : ''; },
        getWeeklyColor(current, target) { if (!current) return 'text-grey'; return current >= target ? 'text-green-darken-2' : 'text-orange-darken-2'; },
        getChipColor(day) { if (day.type === 'x') return 'blue-lighten-4'; if (day.type === 'office') return 'amber-lighten-4'; if (day.type === 'home' && day.net > 0) return 'green-lighten-4'; return 'grey'; },
        openEditDialog(day) { this.editingDay = day; this.dialogEditDay = true; },
        
        onTypeChange(day) { 
            if(['home', 'office'].includes(day.type)) { 
                if(!day.start) {
                    day.start = this.settings.default_start_time || '08:00'; 
                    const dailyTarget = this.calcDailyTarget;
                    
                    // Berechne Endzeit basierend auf Ziel und Pausen
                    let startMin = 480; 
                    try { let p = day.start.split(':'); startMin = parseInt(p[0])*60 + parseInt(p[1]); } catch(e){}
                    
                    // Pausenlogik rückwärts: Brutto-Zeit ermitteln
                    let grossHours = dailyTarget;
                    if(dailyTarget > 9) grossHours += 0.75;
                    else if(dailyTarget > 6) grossHours += 0.5;
                    
                    const endMin = startMin + (grossHours * 60);
                    const h = Math.floor(endMin / 60); const m = Math.round(endMin % 60);
                    day.end = `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
                }
            } 
            this.saveEntry(day); 
        },
        onTypeTime(day) { if(!day.type) day.type = 'home'; },
        changeMonth(delta) { this.currentDate = new Date(this.currentDate.setMonth(this.currentDate.getMonth() + delta)); this.loadMonthData(); },
        changeYear(delta) { this.currentDate = new Date(this.currentDate.setFullYear(this.currentDate.getFullYear() + delta)); if(this.viewMode === 'year') this.loadYearData(); else this.loadMonthData(); },
        addWaeldchestag() { /* Waeldchestag Logic remains same as previous */ 
            const y = this.currentYear; const a=y%19, b=Math.floor(y/100), c=y%100, dd=Math.floor(b/4), e=b%4, f=Math.floor((b+8)/25), g=Math.floor((b-f+1)/3), h=(19*a+b-dd-g+15)%30, i=Math.floor(c/4), k=c%4, l=(32+2*e+2*i-h-k)%7, m_easter=Math.floor((a+11*h+22*l)/451); const monthE = Math.floor((h+l-7*m_easter+114)/31); const dayE = ((h+l-7*m_easter+114)%31)+1; 
            const easterDate = new Date(y, monthE - 1, dayE); const waeldchestag = new Date(easterDate); waeldchestag.setDate(easterDate.getDate() + 51);
            const dateStr = new Date(waeldchestag.getTime() - (waeldchestag.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
            this.newCustomHoliday.date = dateStr; this.newCustomHoliday.name = 'Wäldchestag'; this.newCustomHoliday.hours = 6.0; this.addCustomHoliday();
        },
        getDayInfo(dateObj, settings, customHolidays) {
            const activeDaysCount = settings.active_weekdays ? settings.active_weekdays.length : 5;
            const std_target = activeDaysCount > 0 ? (settings.weekly_hours / activeDaysCount) : 0;
            let is_workday = false, target = 0.0, holiday_name = "", is_short_day = false, is_off_day = false;
            const cust = getCustomHolidayInfo(dateObj); const stdName = getHolidayName(dateObj); const weekday = (dateObj.getDay() + 6) % 7; 
            const is_active_weekday = settings.active_weekdays && settings.active_weekdays.includes(weekday);
            if (!is_active_weekday && weekday < 5) { is_off_day = true; is_workday = false; } 
            else if (cust) { holiday_name = cust.name; if (cust.hours && cust.hours > 0 && is_active_weekday) { is_workday = true; is_short_day = true; target = cust.hours; } else { is_workday = false; } } 
            else if (stdName) { holiday_name = stdName; is_workday = false; } 
            else { if (weekday < 5 && is_active_weekday) { is_workday = true; target = std_target; } }
            return { is_workday, target, holiday_name, is_short_day, is_off_day };
        },
        
        // --- NEU: Auto-Convert Function in JS ---
        autoConvertExpiredEntries() {
            if (!this.settings.auto_convert_planned) return;
            
            const today = new Date().toISOString().split('T')[0];
            const entries = Store.getEntries();
            let changed = false;
            
            // Loop through all entries (Storage is simple key-value)
            for (const [date, entry] of Object.entries(entries)) {
                if (entry.type === 'x' && date < today) {
                    // Check if converting needs time calculation
                    if (!entry.start || !entry.end) {
                        const dObj = new Date(date);
                        const info = this.getDayInfo(dObj, this.settings, this.customHolidays);
                        if (info.target > 0) {
                            entry.start = this.settings.default_start_time || '08:00';
                            
                            // Calculate End Time logic (same as onTypeChange)
                            let startMin = 480;
                            try { let p = entry.start.split(':'); startMin = parseInt(p[0])*60 + parseInt(p[1]); } catch(e){}
                            
                            let grossHours = info.target;
                            if(info.target > 9) grossHours += 0.75;
                            else if(info.target > 6) grossHours += 0.5;
                            
                            const endMin = startMin + (grossHours * 60);
                            const h = Math.floor(endMin / 60); const m = Math.round(endMin % 60);
                            entry.end = `${(h<10?'0':'')+h}:${(m<10?'0':'')+m}`;
                        }
                    }
                    entry.type = 'home';
                    Store.saveEntry(date, entry);
                    changed = true;
                }
            }
            if (changed && this.viewMode === 'list') { 
                // Force reload if we are in list view to show changes immediately
                this.loadMonthData(); 
            }
        },

        loadData() {
            this.settings = Store.getSettings();
            this.customHolidays = Store.getCustomHolidays();
            
            // NEU: Beim Laden einmal prüfen
            this.autoConvertExpiredEntries();
            
            if(this.viewMode === 'year') this.loadYearData();
            else this.loadMonthData();
        },

        loadMonthData() {
            const entries = Store.getEntries();
            const year = this.currentYear, month = this.currentMonth;
            const daysInMonth = new Date(year, month, 0).getDate();
            let total_ho=0, total_office=0, workdays=0, current_week_sum=0;
            let total_target_hours_month = 0.0;
            
            this.items = [];

            for(let d=1; d<=daysInMonth; d++) {
                const dateObj = new Date(year, month-1, d);
                const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                const isoWeek = getISOWeek(dateObj);
                const weekday = (dateObj.getDay() + 6) % 7; 
                
                const info = this.getDayInfo(dateObj, this.settings, this.customHolidays);
                
                if (info.is_workday) { workdays++; total_target_hours_month += info.target; }

                const entry = entries[dateStr] || {};
                const type = entry.type || "";
                
                let net = 0;
                if(type === 'x') net = info.target;
                else if(['home','office'].includes(type)) net = calculateNetHours(entry.start, entry.end);
                net = parseFloat(net.toFixed(2)); 
                
                if(['home', 'x'].includes(type)) total_ho += net;
                if(type === 'office') total_office += net;
                current_week_sum += net;
                
                this.items.push({ 
                    row_type: 'day', date: dateStr, day_num: d, weekday_index: weekday, iso_week: isoWeek, 
                    is_holiday: (info.holiday_name && !info.is_workday), holiday_name: info.holiday_name, is_short_day: info.is_short_day, is_off_day: info.is_off_day,
                    type: type, start: entry.start||'', end: entry.end||'', net: net, daily_target: info.target
                });
                
                if(weekday === 6 || d === daysInMonth) {
                    this.items.push({ row_type: 'summary', iso_week: isoWeek, sum: parseFloat(current_week_sum.toFixed(2)), target: this.settings.weekly_hours, date: 'sum-'+isoWeek });
                    current_week_sum = 0;
                }
            }
            
            const max_ho = total_target_hours_month * (this.settings.ho_quota_percent / 100);
            const total_work = total_ho + total_office;
            const week_count = this.items.filter(i => i.row_type === 'summary').length;
            this.stats = { total_ho_made: total_ho, total_ho_allowed: max_ho, total_office_made: total_office, total_work_made: total_work, avg_per_week: week_count ? (total_work / week_count) : 0, workdays_month: workdays };
        },
        
        loadYearData() {
            const entries = Store.getEntries();
            const year = this.currentYear;
            this.yearData = [];
            
            for(let m=1; m<=12; m++) {
                const daysInMonth = new Date(year, m, 0).getDate();
                let ho_h=0, off_h=0, wd=0, total_target_month=0.0;
                let days_ho=0, days_off=0;
                
                for(let d=1; d<=daysInMonth; d++) {
                    const dateObj = new Date(year, m-1, d);
                    const dateStr = new Date(dateObj.getTime() - (dateObj.getTimezoneOffset() * 60000)).toISOString().split('T')[0];
                    const info = this.getDayInfo(dateObj, this.settings, this.customHolidays);
                    if(info.is_workday) { wd++; total_target_month += info.target; }
                    const entry = entries[dateStr];
                    if(entry) {
                        const type = entry.type; let h = 0;
                        if(type === 'x') h = info.target;
                        else if(['home','office'].includes(type)) h = calculateNetHours(entry.start, entry.end);
                        if(['home','x'].includes(type)) { ho_h += h; days_ho++; } else if(type === 'office') { off_h += h; days_off++; }
                    }
                }
                this.yearData.push({ month: m, days_ho: days_ho, days_office: days_off, ho_hours_made: parseFloat(ho_h.toFixed(2)), ho_hours_allowed: parseFloat((total_target_month * (this.settings.ho_quota_percent/100)).toFixed(2)), office_hours_made: parseFloat(off_h.toFixed(2)) });
            }
        },

        saveEntry(day) { 
            // Normalize time inputs
            if(day.start) day.start = normalizeTimeInput(day.start);
            if(day.end) day.end = normalizeTimeInput(day.end);
            
            // Validate time entries if type requires time input
            if(this.needsTimeInput(day.type) && (day.start || day.end)) {
                const validation = validateTimeRange(day.start, day.end);
                if (!validation.valid) {
                    this.validationErrors[day.date] = validation.error;
                    // Show error but still allow saving to not lose data
                    console.warn(`Validation warning for ${day.date}: ${validation.error}`);
                } else {
                    // Clear any previous error
                    delete this.validationErrors[day.date];
                }
            } else {
                delete this.validationErrors[day.date];
            }
            
            if(day.type === "") Store.deleteEntry(day.date); 
            else Store.saveEntry(day.date, { type: day.type, start: day.start, end: day.end }); 
        },
        clearEntry(day) { 
            day.type = ""; 
            day.start = ""; 
            day.end = ""; 
            delete this.validationErrors[day.date];
            this.saveEntry(day); 
        },
        saveSettings() { Store.saveSettings(this.settings); Store.saveCustomHolidays(this.customHolidays); this.dialogSettings = false; if(this.viewMode==='year') this.loadYearData(); else this.loadMonthData(); },
        addCustomHoliday() { if(!this.newCustomHoliday.date || !this.newCustomHoliday.name) return; this.customHolidays[this.newCustomHoliday.date] = {...this.newCustomHoliday}; this.newCustomHoliday = {date:'', name:''}; },
        deleteCustomHoliday(dateKey) { delete this.customHolidays[dateKey]; },

        async checkForStoredHandle() { try { const handle = await idbGet('fileHandle'); if(handle) { this.storedHandleName = handle.name; } } catch(e) { console.error(e); } },
        async restoreFileConnection() { try { const handle = await idbGet('fileHandle'); if(!handle) return; const opts = { mode: 'readwrite' }; if ((await handle.queryPermission(opts)) === 'granted' || (await handle.requestPermission(opts)) === 'granted') { this.fileHandle = handle; this.fileName = handle.name; await this.loadFileContent(); } } catch(e) { console.error("Restore failed", e); alert("Konnte Verbindung nicht wiederherstellen."); } },
        async openFile() { try { if (!window.showOpenFilePicker) { alert("Browser unterstützt FileSystemAccess nicht."); return; } const [handle] = await window.showOpenFilePicker({ types: [{ description: 'JSON', accept: {'application/json': ['.json']} }], multiple: false }); this.fileHandle = handle; this.fileName = handle.name; await idbSet('fileHandle', handle); this.storedHandleName = handle.name; await this.loadFileContent(); } catch(e) {} },
        async loadFileContent() { 
            const file = await this.fileHandle.getFile(); 
            const text = await file.text(); 
            try { 
                const json = JSON.parse(text); 
                Store.set(json); 
                this.loadData(); 
            } catch(e) { 
                console.error("Fehler beim Laden der Datei:", e);
                alert("Fehler beim Laden der Datei. Bitte überprüfen Sie das JSON-Format.");
                Store.init(); 
            } 
        },
        async saveToFile() { 
            if(!this.fileHandle) return; 
            try { 
                const writable = await this.fileHandle.createWritable(); 
                await writable.write(JSON.stringify(Store.get(), null, 2)); 
                await writable.close(); 
                this.unsavedChanges = false; 
            } catch(e) { 
                console.error("Fehler beim Speichern:", e);
                alert("Fehler beim Speichern: " + e.message); 
            } 
        },

        exportToCSV(scope) {
            try {
                let csvContent = '';
                let filename = '';
                
                if (scope === 'month') {
                    // Export current month data
                    csvContent = 'Datum,Wochentag,Status,Start,Ende,Stunden,Feiertag\n';
                    filename = `HO-Tracker_${this.currentYear}-${String(this.currentMonth).padStart(2, '0')}.csv`;
                    
                    const dayItems = this.items.filter(i => i.row_type === 'day');
                    dayItems.forEach(item => {
                        const status = this.getTypeName(item.type) || '-';
                        const start = item.start || '-';
                        const end = item.end || '-';
                        const hours = item.net > 0 ? this.formatNum(item.net) : '-';
                        const holiday = item.holiday_name || '-';
                        const weekday = this.getGermanDay(item.weekday_index);
                        
                        csvContent += `${item.date},${weekday},${status},${start},${end},${hours},${holiday}\n`;
                    });
                    
                    // Add summary
                    csvContent += '\n';
                    csvContent += `Zusammenfassung\n`;
                    csvContent += `Arbeitstage,${this.stats.workdays_month}\n`;
                    csvContent += `Home Office Stunden,${this.formatNum(this.stats.total_ho_made)}\n`;
                    csvContent += `Büro Stunden,${this.formatNum(this.stats.total_office_made)}\n`;
                    csvContent += `HO Budget,${this.formatNum(this.stats.total_ho_allowed)}\n`;
                    
                } else if (scope === 'year') {
                    // Export year data
                    csvContent = 'Monat,HO Tage,Büro Tage,HO Stunden,HO Budget,Büro Stunden\n';
                    filename = `HO-Tracker_Jahr_${this.currentYear}.csv`;
                    
                    this.yearData.forEach(stat => {
                        const month = this.getGermanMonthName(stat.month);
                        csvContent += `${month},${stat.days_ho},${stat.days_office},${this.formatNum(stat.ho_hours_made)},${this.formatNum(stat.ho_hours_allowed)},${this.formatNum(stat.office_hours_made)}\n`;
                    });
                }
                
                // Create download
                const blob = new Blob([UTF8_BOM + csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
            } catch(e) {
                console.error("Fehler beim CSV-Export:", e);
                alert("Fehler beim Export: " + e.message);
            }
        },
        
        downloadBackup() {
            try {
                const data = Store.get();
                const jsonStr = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonStr], { type: 'application/json' });
                const link = document.createElement('a');
                const url = URL.createObjectURL(blob);
                
                const now = new Date();
                const dateStr = now.toISOString().split('T')[0];
                const timeStr = now.toTimeString().split(' ')[0].replace(/:/g, '-');
                const filename = `HO-Tracker-Backup_${dateStr}_${timeStr}.json`;
                
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
                
            } catch(e) {
                console.error("Fehler beim Backup:", e);
                alert("Fehler beim Erstellen des Backups: " + e.message);
            }
        },
        
        triggerRestoreBackup() {
            this.$refs.restoreFileInput.click();
        },
        
        async restoreBackup(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            try {
                const text = await file.text();
                const data = JSON.parse(text);
                
                // Validate data structure - at least one of these properties should exist
                if (!data.settings && !data.entries && !data.customHolidays) {
                    throw new Error("Ungültige Backup-Datei. Die Datei muss mindestens settings, entries oder customHolidays enthalten.");
                }
                
                // Confirm before restoring
                if (confirm("Möchtest du wirklich alle aktuellen Daten mit diesem Backup überschreiben? Diese Aktion kann nicht rückgängig gemacht werden.")) {
                    Store.set(data);
                    this.loadData();
                    alert("Backup erfolgreich wiederhergestellt!");
                }
                
            } catch(e) {
                console.error("Fehler beim Wiederherstellen:", e);
                alert("Fehler beim Wiederherstellen des Backups: " + e.message);
            } finally {
                // Reset file input
                event.target.value = '';
            }
        }
      }
    });
    app.config.compilerOptions.delimiters = ['[[', ']]'];
    app.use(vuetify);
    app.mount('#app');
  </script>
</body>
</html>
